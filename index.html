<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"goversion.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.24.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://goversion.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zhou tao">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://goversion.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhou tao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://goversion.github.io/2025/08/31/rust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhou tao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/31/rust/" class="post-title-link" itemprop="url">rust</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-31 17:50:41 / 修改时间：17:52:02" itemprop="dateCreated datePublished" datetime="2025-08-31T17:50:41+08:00">2025-08-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>rust 语言的优点是安全，它把运行时的潜在问题扼杀在编码阶段，只要程序编绎通过，运行时就基本不会有 bug 了。</p>
<p>但它有明显的缺点，从语言形式上它不太自然，缺乏美感。</p>
<p>做下面这些题之前，可以先阅读一下诸如《Rust 程序设计语言》、《Rust语言圣经》、《Rust入门秘籍》、《Rust 死灵书》的链接。</p>
<ul>
<li>死灵书 <a target="_blank" rel="noopener" href="https://nomicon.purewhite.io/">https://nomicon.purewhite.io/</a></li>
</ul>
<p>我初看 rust algorithm 代码时，几乎看不懂的。rust 比传统的 java&#x2F;c++&#x2F;python 语言难了一个数量级，本文以 rustling 为引子，把 rust 的基础内容全部串一遍。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">intro2                  intro/intro2.rs</span><br><span class="line">variables1              variables/variables1.rs</span><br><span class="line">variables2              variables/variables2.rs</span><br><span class="line">variables3              variables/variables3.rs</span><br><span class="line">variables4              variables/variables4.rs</span><br><span class="line">variables5              variables/variables5.rs</span><br><span class="line">variables6              variables/variables6.rs</span><br><span class="line">functions1              functions/functions1.rs</span><br><span class="line">functions2              functions/functions2.rs</span><br><span class="line">functions3              functions/functions3.rs</span><br><span class="line">functions4              functions/functions4.rs</span><br><span class="line">functions5              functions/functions5.rs</span><br><span class="line">if1                     if/if1.rs</span><br><span class="line">if2                     if/if2.rs</span><br><span class="line">if3                     if/if3.rs</span><br><span class="line">quiz1                   quiz1.rs</span><br><span class="line">primitive_types1        primitive_types/primitive_types1.rs</span><br><span class="line">primitive_types2        primitive_types/primitive_types2.rs</span><br><span class="line">primitive_types3        primitive_types/primitive_types3.rs</span><br><span class="line">primitive_types4        primitive_types/primitive_types4.rs</span><br><span class="line">primitive_types5        primitive_types/primitive_types5.rs</span><br><span class="line">primitive_types6        primitive_types/primitive_types6.rs</span><br><span class="line">vecs1                   vecs/vecs1.rs</span><br><span class="line">vecs2                   vecs/vecs2.rs</span><br><span class="line">move_semantics1         move_semantics/move_semantics1.rs</span><br><span class="line">move_semantics2         move_semantics/move_semantics2.rs</span><br><span class="line">move_semantics3         move_semantics/move_semantics3.rs</span><br><span class="line">move_semantics4         move_semantics/move_semantics4.rs</span><br><span class="line">move_semantics5         move_semantics/move_semantics5.rs</span><br><span class="line">move_semantics6         move_semantics/move_semantics6.rs</span><br><span class="line">structs1                structs/structs1.rs</span><br><span class="line">structs2                structs/structs2.rs</span><br><span class="line">structs3                structs/structs3.rs</span><br><span class="line">enums1                  enums/enums1.rs</span><br><span class="line">enums2                  enums/enums2.rs</span><br><span class="line">enums3                  enums/enums3.rs</span><br><span class="line">strings1                strings/strings1.rs</span><br><span class="line">strings2                strings/strings2.rs</span><br><span class="line">strings3                strings/strings3.rs</span><br><span class="line">strings4                strings/strings4.rs</span><br><span class="line">modules1                modules/modules1.rs</span><br><span class="line">modules2                modules/modules2.rs</span><br><span class="line">modules3                modules/modules3.rs</span><br><span class="line">hashmaps1               hashmaps/hashmaps1.rs</span><br><span class="line">hashmaps2               hashmaps/hashmaps2.rs</span><br><span class="line">hashmaps3               hashmaps/hashmaps3.rs</span><br><span class="line">quiz2                   quiz2.rs</span><br><span class="line">options1                options/options1.rs</span><br><span class="line">options2                options/options2.rs</span><br><span class="line">options3                options/options3.rs</span><br><span class="line">errors1                 error_handling/errors1.rs</span><br><span class="line">errors2                 error_handling/errors2.rs</span><br><span class="line">errors3                 error_handling/errors3.rs</span><br><span class="line">errors4                 error_handling/errors4.rs</span><br><span class="line">errors5                 error_handling/errors5.rs</span><br><span class="line">errors6                 error_handling/errors6.rs</span><br><span class="line">generics1               generics/generics1.rs</span><br><span class="line">generics2               generics/generics2.rs</span><br><span class="line">traits1                 traits/traits1.rs</span><br><span class="line">traits2                 traits/traits2.rs</span><br><span class="line">traits3                 traits/traits3.rs</span><br><span class="line">traits4                 traits/traits4.rs</span><br><span class="line">traits5                 traits/traits5.rs</span><br><span class="line">quiz3                   quiz3.rs</span><br><span class="line">lifetimes1              lifetimes/lifetimes1.rs</span><br><span class="line">lifetimes2              lifetimes/lifetimes2.rs</span><br><span class="line">lifetimes3              lifetimes/lifetimes3.rs</span><br><span class="line">tests1                  tests/tests1.rs</span><br><span class="line">tests2                  tests/tests2.rs</span><br><span class="line">tests3                  tests/tests3.rs</span><br><span class="line">tests4                  tests/tests4.rs</span><br><span class="line">iterators1              iterators/iterators1.rs</span><br><span class="line">iterators2              iterators/iterators2.rs</span><br><span class="line">iterators3              iterators/iterators3.rs</span><br><span class="line">iterators4              iterators/iterators4.rs</span><br><span class="line">iterators5              iterators/iterators5.rs</span><br><span class="line">box1                    smart_pointers/box1.rs</span><br><span class="line">rc1                     smart_pointers/rc1.rs</span><br><span class="line">arc1                    smart_pointers/arc1.rs</span><br><span class="line">cow1                    smart_pointers/cow1.rs</span><br><span class="line">threads1                threads/threads1.rs</span><br><span class="line">threads2                threads/threads2.rs</span><br><span class="line">threads3                threads/threads3.rs</span><br><span class="line">macros1                 macros/macros1.rs</span><br><span class="line">macros2                 macros/macros2.rs</span><br><span class="line">macros3                 macros/macros3.rs</span><br><span class="line">macros4                 macros/macros4.rs</span><br><span class="line">clippy1                 clippy/clippy1.rs</span><br><span class="line">clippy2                 clippy/clippy2.rs</span><br><span class="line">clippy3                 clippy/clippy3.rs</span><br><span class="line">using_as                conversions/using_as.rs</span><br><span class="line">from_into               conversions/from_into.rs</span><br><span class="line">from_str                conversions/from_str.rs</span><br><span class="line">try_from_into           conversions/try_from_into.rs</span><br><span class="line">as_ref_mut              conversions/as_ref_mut.rs</span><br><span class="line">tests5                  tests/tests5.rs</span><br><span class="line">tests6                  tests/tests6.rs</span><br><span class="line">tests7                  tests/tests7.rs</span><br><span class="line">tests8                  tests/tests8.rs</span><br><span class="line">tests9                  tests/tests9.rs</span><br><span class="line">algorithm1              algorithm/algorithm1.rs</span><br><span class="line">algorithm2              algorithm/algorithm2.rs</span><br><span class="line">algorithm3              algorithm/algorithm3.rs</span><br><span class="line">algorithm4              algorithm/algorithm4.rs</span><br><span class="line">algorithm5              algorithm/algorithm5.rs</span><br><span class="line">algorithm6              algorithm/algorithm6.rs</span><br><span class="line">algorithm7              algorithm/algorithm7.rs</span><br><span class="line">algorithm8              algorithm/algorithm8.rs</span><br><span class="line">algorithm9              algorithm/algorithm9.rs</span><br><span class="line">algorithm10             algorithm/algorithm10.rs</span><br></pre></td></tr></table></figure>


<h2 id="000-intro-intro2-rs"><a href="#000-intro-intro2-rs" class="headerlink" title="000 intro&#x2F;intro2.rs"></a>000 intro&#x2F;intro2.rs</h2><h2 id="001-variables-variables1-rs"><a href="#001-variables-variables1-rs" class="headerlink" title="001 variables&#x2F;variables1.rs"></a>001 variables&#x2F;variables1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x has the value &#123;&#125;&quot;</span>, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>变量定义用let，其实在rust里 是一个数据绑定到一个变量，这是这个语言内存管理方面的创新点。</p>
<h2 id="002-variables-variables2-rs"><a href="#002-variables-variables2-rs" class="headerlink" title="002 variables&#x2F;variables2.rs"></a>002 variables&#x2F;variables2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;x is ten!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;x is not ten!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>变量出现必须与一个数据做绑定，而绑定后默认不可修改，如果后续要对他修改，那就加上mut。</p>
<p>这里还涉及一个if判断逻辑，类似于python2，不需要括号。</p>
<h2 id="003-variables-variables3-rs"><a href="#003-variables-variables3-rs" class="headerlink" title="003 variables&#x2F;variables3.rs"></a>003 variables&#x2F;variables3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">i32</span> =<span class="number">5</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number &#123;&#125;&quot;</span>, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>报错信息是变量x没有被初始化，所以变量出现必须与一个数据做绑定，同时i32是可以取掉的，因为rust编译器将自动将x推导为等式右边数字的类型。</p>
<h2 id="004-variables-variables4-rs"><a href="#004-variables-variables4-rs" class="headerlink" title="004 variables&#x2F;variables4.rs"></a>004 variables&#x2F;variables4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number &#123;&#125;&quot;</span>, x);</span><br><span class="line">    x = <span class="number">5</span>; <span class="comment">// don&#x27;t change this line</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number &#123;&#125;&quot;</span>, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>像某语言一样 let 不可变，var 可变。</p>
<h2 id="005-variables-variables5-rs"><a href="#005-variables-variables5-rs" class="headerlink" title="005 variables&#x2F;variables5.rs"></a>005 variables&#x2F;variables5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">number</span> = <span class="string">&quot;T-H-R-E-E&quot;</span>; <span class="comment">// don&#x27;t change this line</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Spell a Number : &#123;&#125;&quot;</span>, number);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">number</span> = <span class="number">3</span>; <span class="comment">// don&#x27;t rename this variable</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number plus two is : &#123;&#125;&quot;</span>, number + <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="006-variables-variables6-rs"><a href="#006-variables-variables6-rs" class="headerlink" title="006 variables&#x2F;variables6.rs"></a>006 variables&#x2F;variables6.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> NUMBER:<span class="type">i16</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number &#123;&#125;&quot;</span>, NUMBER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="007-functions-functions1-rs"><a href="#007-functions-functions1-rs" class="headerlink" title="007 functions&#x2F;functions1.rs"></a>007 functions&#x2F;functions1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">call_me</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">call_me</span>()&#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;hello world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不要求被调用函数必须在调用者之前声明或者定义。</p>
<h2 id="008-functions-functions2-rs"><a href="#008-functions-functions2-rs" class="headerlink" title="008 functions&#x2F;functions2.rs"></a>008 functions&#x2F;functions2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">call_me</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">call_me</span>(num: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..num &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Ring! Call number &#123;&#125;&quot;</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="009-functions-functions3-rs"><a href="#009-functions-functions3-rs" class="headerlink" title="009 functions&#x2F;functions3.rs"></a>009 functions&#x2F;functions3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">call_me</span>(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">call_me</span>(num: <span class="type">u32</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..num &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Ring! Call number &#123;&#125;&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="010-functions-functions4"><a href="#010-functions-functions4" class="headerlink" title="010 functions&#x2F;functions4"></a>010 functions&#x2F;functions4</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This store is having a sale where</span></span><br><span class="line"><span class="comment">// if the price is an even number, you get 10 Rustbucks off, but</span></span><br><span class="line"><span class="comment">// if it&#x27;s an odd number, it&#x27;s 3 Rustbucks off.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">original_price</span> = <span class="number">51</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Your sale price is &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sale_price</span>(original_price));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">sale_price</span>(price: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="title function_ invoke__">is_even</span>(price) &#123;</span><br><span class="line">        price - <span class="number">10</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        price - <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">is_even</span>(num: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    num % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回值的类型，需要写明白。</p>
<h2 id="011-functions-functions5-rs"><a href="#011-functions-functions5-rs" class="headerlink" title="011 functions&#x2F;functions5.rs"></a>011 functions&#x2F;functions5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">answer</span> = <span class="title function_ invoke__">square</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The square of 3 is &#123;&#125;&quot;</span>, answer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">square</span>(num: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    num * num</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>square 的返回行 <code>num * num;</code> 分号要去掉。</p>
<h2 id="012-if-if1-rs"><a href="#012-if-if1-rs" class="headerlink" title="012 if&#x2F;if1.rs"></a>012 if&#x2F;if1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">bigger</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="comment">// Complete this function to return the bigger number!</span></span><br><span class="line">    <span class="comment">// Do not use:</span></span><br><span class="line">    <span class="comment">// ## another function call</span></span><br><span class="line">    <span class="comment">// ## additional variables</span></span><br><span class="line">    <span class="keyword">if</span> a &gt; b &#123;</span><br><span class="line">        a</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        b</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="013-if-if2-rs"><a href="#013-if-if2-rs" class="headerlink" title="013 if&#x2F;if2.rs"></a>013 if&#x2F;if2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">foo_if_fizz</span>(fizzish: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> fizzish == <span class="string">&quot;fizz&quot;</span> &#123;</span><br><span class="line">        <span class="string">&quot;foo&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> fizzish == <span class="string">&quot;fuzz&quot;</span> &#123;</span><br><span class="line">        <span class="string">&quot;bar&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="string">&quot;baz&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// No test changes needed!</span></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">foo_for_fizz</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">foo_if_fizz</span>(<span class="string">&quot;fizz&quot;</span>), <span class="string">&quot;foo&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">bar_for_fuzz</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">foo_if_fizz</span>(<span class="string">&quot;fuzz&quot;</span>), <span class="string">&quot;bar&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">default_to_baz</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">foo_if_fizz</span>(<span class="string">&quot;literally anything&quot;</span>), <span class="string">&quot;baz&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="014-if-if3-rs"><a href="#014-if-if3-rs" class="headerlink" title="014 if&#x2F;if3.rs"></a>014 if&#x2F;if3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">animal_habitat</span>(animal: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">identifier</span> = <span class="keyword">if</span> animal == <span class="string">&quot;crab&quot;</span> &#123;</span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> animal == <span class="string">&quot;gopher&quot;</span> &#123;</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> animal == <span class="string">&quot;snake&quot;</span> &#123;</span><br><span class="line">        <span class="number">3</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DO NOT CHANGE THIS STATEMENT BELOW</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">habitat</span> = <span class="keyword">if</span> identifier == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="string">&quot;Beach&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> identifier == <span class="number">2</span> &#123;</span><br><span class="line">        <span class="string">&quot;Burrow&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> identifier == <span class="number">3</span> &#123;</span><br><span class="line">        <span class="string">&quot;Desert&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    habitat</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">gopher_lives_in_burrow</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">animal_habitat</span>(<span class="string">&quot;gopher&quot;</span>), <span class="string">&quot;Burrow&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">snake_lives_in_desert</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">animal_habitat</span>(<span class="string">&quot;snake&quot;</span>), <span class="string">&quot;Desert&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">crab_lives_on_beach</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">animal_habitat</span>(<span class="string">&quot;crab&quot;</span>), <span class="string">&quot;Beach&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">unknown_animal</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">animal_habitat</span>(<span class="string">&quot;dinosaur&quot;</span>), <span class="string">&quot;Unknown&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>let identifier = if animal == &quot;crab&quot; &#123;</code><br>最外层是 let 语句，里层是 if 表达式，表达式可以成为语句的一部分。<br>这里的知识点是语句和表达式。</p>
<p>可以将Rust看作一切皆表达式。由于当分号后面什么都没有时自动补单元值（）的特点，可以将Rust中的语句看作计算结果均为（）的特殊表达式。而对于普通的表达式来说，则会得到正常的求值结果。</p>
<p>Rust 中的语法分为两大类： 语句 (statement) 和表达式 (Expression)。</p>
<p>语句：指的是要执行的一些操作和产生副作用的表达式。</p>
<p>表达式：主要用于计算求值。</p>
<p>Rust编译器在解析代码的时候，如果碰到分毫，就会继续往后面执行；如果碰断语句，则执行语句；如果碰到表达式，则会对表达式求值，如果分号后面什么都没有，就会补上单元值（）。</p>
<h2 id="015-quiz1-rs"><a href="#015-quiz1-rs" class="headerlink" title="015 quiz1.rs"></a>015 quiz1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">calculate_price_of_apples</span>(number: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> number &gt; <span class="number">40</span> &#123;</span><br><span class="line">        number * <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        number * <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Don&#x27;t modify this function!</span></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">verify_test</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">price1</span> = <span class="title function_ invoke__">calculate_price_of_apples</span>(<span class="number">35</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">price2</span> = <span class="title function_ invoke__">calculate_price_of_apples</span>(<span class="number">40</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">price3</span> = <span class="title function_ invoke__">calculate_price_of_apples</span>(<span class="number">41</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">price4</span> = <span class="title function_ invoke__">calculate_price_of_apples</span>(<span class="number">65</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">70</span>, price1);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">80</span>, price2);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">41</span>, price3);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">65</span>, price4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="016-primitive-types-primitive-types1-rs"><a href="#016-primitive-types-primitive-types1-rs" class="headerlink" title="016 primitive_types&#x2F;primitive_types1.rs"></a>016 primitive_types&#x2F;primitive_types1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Booleans (`bool`)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_morning</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> is_morning &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Good morning!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_evening</span> = <span class="literal">true</span>;<span class="comment">// Finish the rest of this line like the example! Or make it be false!</span></span><br><span class="line">    <span class="keyword">if</span> is_evening &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Good evening!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="017-primitive-types-primitive-types2-rs"><a href="#017-primitive-types-primitive-types2-rs" class="headerlink" title="017 primitive_types&#x2F;primitive_types2.rs"></a>017 primitive_types&#x2F;primitive_types2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Characters (`char`)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note the _single_ quotes, these are different from the double quotes</span></span><br><span class="line">    <span class="comment">// you&#x27;ve been seeing around.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">my_first_initial</span> = <span class="string">&#x27;C&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> my_first_initial.<span class="title function_ invoke__">is_alphabetic</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Alphabetical!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> my_first_initial.<span class="title function_ invoke__">is_numeric</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Numerical!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Neither alphabetic nor numeric!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">your_character</span> = <span class="string">&#x27;3&#x27;</span>; <span class="comment">// Finish this line like the example! What&#x27;s your favorite character?</span></span><br><span class="line">    <span class="comment">// Try a letter, try a number, try a special character, try a character</span></span><br><span class="line">    <span class="comment">// from a different language than your own, try an emoji!</span></span><br><span class="line">    <span class="keyword">if</span> your_character.<span class="title function_ invoke__">is_alphabetic</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Alphabetical!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> your_character.<span class="title function_ invoke__">is_numeric</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Numerical!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Neither alphabetic nor numeric!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>字符的属性有 is_alphabetic &#x2F; is_numeric，所以 your_character 赋值要用引号 <code>your_character = &#39;3&#39;</code>。</p>
<h2 id="018-primitive-types-primitive-types3-rs"><a href="#018-primitive-types-primitive-types3-rs" class="headerlink" title="018 primitive_types&#x2F;primitive_types3.rs"></a>018 primitive_types&#x2F;primitive_types3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">0</span>;<span class="number">1000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> a.<span class="title function_ invoke__">len</span>() &gt;= <span class="number">100</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Wow, that&#x27;s a big array!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Meh, I eat arrays like that for breakfast.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="019-primitive-types-primitive-types4-rs"><a href="#019-primitive-types-primitive-types4-rs" class="headerlink" title="019 primitive_types&#x2F;primitive_types4.rs"></a>019 primitive_types&#x2F;primitive_types4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">slice_out_of_array</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">nice_slice</span> = &amp;a[<span class="number">1</span>..<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], nice_slice)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>切片这个名字往往出现在生物课上，我们做样本玻片的时候要从生物体上获取切片，以供在显微镜上观察。在 Rust 中，切片的意思大致也是这样，只不过它从数据取材引用。</p>
<p>$x..y$ 表示 $[x, y)$ 的数学含义。所以记忆时，就用 $[x,y-1]$.</p>
<h2 id="020-primitive-types-primitive-types5-rs"><a href="#020-primitive-types-primitive-types5-rs" class="headerlink" title="020 primitive_types&#x2F;primitive_types5.rs"></a>020 primitive_types&#x2F;primitive_types5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cat</span> = (<span class="string">&quot;Furry McFurson&quot;</span>, <span class="number">3.5</span>);</span><br><span class="line">    <span class="keyword">let</span> (name, age)= cat;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; is &#123;&#125; years old.&quot;</span>, name, age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>元组 tuple 是和数组对应一种类型，数组的元素相同，元组元素可以不同。</p>
<p>元组是由多种类型组合到一起形成的，因此它是复合类型，元组的长度是固定的，元组中元素的顺序也是固定的。</p>
<h2 id="021-primitive-types-primitive-types6-rs"><a href="#021-primitive-types-primitive-types6-rs" class="headerlink" title="021 primitive_types&#x2F;primitive_types6.rs"></a>021 primitive_types&#x2F;primitive_types6.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">indexing_tuple</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="comment">// Replace below ??? with the tuple indexing syntax.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">second</span> = numbers.<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">2</span>, second,</span><br><span class="line">        <span class="string">&quot;This is not the 2nd number in the tuple!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过点访问元组。</p>
<p>接触过python的话，这里很好理解，rust的语法是各家的杂糅。</p>
<h2 id="022-vecs-vecs1-rs"><a href="#022-vecs-vecs1-rs" class="headerlink" title="022 vecs&#x2F;vecs1.rs"></a>022 vecs&#x2F;vecs1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">array_and_vec</span>() <span class="punctuation">-&gt;</span> ([<span class="type">i32</span>; <span class="number">4</span>], <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">41</span>]; <span class="comment">// a plain array</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>];<span class="comment">// <span class="doctag">TODO:</span> declare your vector here with the macro for vectors</span></span><br><span class="line"></span><br><span class="line">    (a, v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_array_and_vec_similarity</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> (a, v) = <span class="title function_ invoke__">array_and_vec</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(a, v[..]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>注意：这里一个 array 和 一个 vector 可以做比较。</p>
<h4 id="背景讲解：Vector-向量详解"><a href="#背景讲解：Vector-向量详解" class="headerlink" title="背景讲解：Vector 向量详解"></a>背景讲解：Vector 向量详解</h4><p>an array in Rust is stored on the stack (meaning it can’t grow or shrink, and the size needs to be known at compile time), and a Vector is stored in the heap (where these restrictions do not apply).</p>
<p>数组分配在栈上，长度固定。而 vecs 存储在堆上，是一种动态数组类型。</p>
<h4 id="一、Vector-的定义和创建"><a href="#一、Vector-的定义和创建" class="headerlink" title="一、Vector 的定义和创建"></a>一、Vector 的定义和创建</h4><p>在 Rust 中，可以使用 Vec<T> 来定义和创建一个 Vector，其中的 T 是 Vector 存储的元素类型。下面是一个示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let numbers: Vec&lt;i32&gt; = Vec::new();</span><br></pre></td></tr></table></figure>
<p>在上述示例中，我们创建了一个空的整数类型的 Vector，使用 Vec::new() 方法来初始化。<br>另一种创建 Vector 的方式是使用宏 vec!：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let numbers = vec![1, 2, 3, 4, 5];</span><br></pre></td></tr></table></figure>
<p>在上面的示例中，我们使用 vec! 宏创建了一个包含 1 到 5 的整数的 Vector。</p>
<h4 id="二、Vector-的常用方法"><a href="#二、Vector-的常用方法" class="headerlink" title="二、Vector 的常用方法"></a>二、Vector 的常用方法</h4><p>Vector 提供了丰富的方法，用于操作和管理数组。下面是一些常用的方法：</p>
<ul>
<li>push(element: T)：向 Vector 的末尾添加一个元素。</li>
<li>pop()：移除并返回 Vector 的末尾元素。</li>
<li>get(index: usize) -&gt; Option&lt;&amp;T&gt;：根据索引获取 Vector 中的元素，返回一个 Option 类型的引用。</li>
<li>len() -&gt; usize：获取 Vector 的长度（元素个数）。</li>
<li>is_empty() -&gt; bool：判断 Vector 是否为空。</li>
<li>contains(&amp;item) -&gt; bool：判断 Vector 是否包含指定元素。</li>
<li>iter()：返回一个迭代器，用于遍历 Vector 中的元素。</li>
</ul>
<p>除了上述方法外，Vector 还提供了很多其他有用的方法，如排序、映射、过滤等，可以根据具体需求选择使用。</p>
<h4 id="三、Vector-的使用示例"><a href="#三、Vector-的使用示例" class="headerlink" title="三、Vector 的使用示例"></a>三、Vector 的使用示例</h4><p>下面通过一些示例代码来演示 Vector 的使用。</p>
<h5 id="示例一：向-Vector-添加和删除元素"><a href="#示例一：向-Vector-添加和删除元素" class="headerlink" title="示例一：向 Vector 添加和删除元素"></a>示例一：向 Vector 添加和删除元素</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">fruits</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    fruits.<span class="title function_ invoke__">push</span>(<span class="string">&quot;Apple&quot;</span>);</span><br><span class="line">    fruits.<span class="title function_ invoke__">push</span>(<span class="string">&quot;Banana&quot;</span>);</span><br><span class="line">    fruits.<span class="title function_ invoke__">push</span>(<span class="string">&quot;Orange&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Fruits: &#123;:?&#125;&quot;</span>, fruits);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">removed_fruit</span> = fruits.<span class="title function_ invoke__">pop</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Removed fruit: &#123;:?&#125;&quot;</span>, removed_fruit);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Fruits: &#123;:?&#125;&quot;</span>, fruits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们首先创建了一个空的 Vector fruits。然后，使用 push 方法向 Vector 添加三个水果。接着，使用 pop 方法移除 Vector 的末尾元素，并将其打印出来。</p>
<h5 id="示例二：遍历-Vector-中的元素"><a href="#示例二：遍历-Vector-中的元素" class="headerlink" title="示例二：遍历 Vector 中的元素"></a>示例二：遍历 Vector 中的元素</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">number</span> <span class="keyword">in</span> &amp;numbers &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Number: &#123;&#125;&quot;</span>, number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述示例中，我们创建了一个包含一些整数的 Vector numbers。使用 iter 方法返回的迭代器来遍历 Vector 中的元素，并将每个元素打印出来。</p>
<h5 id="示例三：使用索引访问-Vector-中的元素"><a href="#示例三：使用索引访问-Vector-中的元素" class="headerlink" title="示例三：使用索引访问 Vector 中的元素"></a>示例三：使用索引访问 Vector 中的元素</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(first_number) = numbers.<span class="title function_ invoke__">get</span>(<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;First number: &#123;&#125;&quot;</span>, first_number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(third_number) = numbers.<span class="title function_ invoke__">get</span>(<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Third number: &#123;&#125;&quot;</span>, third_number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的示例中，我们使用 get 方法根据索引访问 Vector 中的元素。通过匹配 Option 类型的返回值，我们可以安全地访问 Vector 中的元素，并将其打印出来。</p>
<h2 id="023-vecs-vecs2-rs"><a href="#023-vecs-vecs2-rs" class="headerlink" title="023 vecs&#x2F;vecs2.rs"></a>023 vecs&#x2F;vecs2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Vec of even numbers is given. Your task is to complete the loop so that</span></span><br><span class="line"><span class="comment">// each number in the Vec is multiplied by 2.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_loop</span>(<span class="keyword">mut</span> v: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">element</span> <span class="keyword">in</span> v.<span class="title function_ invoke__">iter_mut</span>() &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Fill this up so that each element in the Vec `v` is</span></span><br><span class="line">        <span class="comment">// multiplied by 2.</span></span><br><span class="line">        *element = *element * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// At this point, `v` should be equal to [4, 8, 12, 16, 20].</span></span><br><span class="line">    v</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_map</span>(v: &amp;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|element| &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Do the same thing as above ## but instead of mutating the</span></span><br><span class="line">        <span class="comment">// Vec, you can just return the new number!</span></span><br><span class="line">        element * <span class="number">2</span></span><br><span class="line">    &#125;).<span class="title function_ invoke__">collect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_vec_loop</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">v</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = (<span class="number">1</span>..).<span class="title function_ invoke__">filter</span>(|x| x % <span class="number">2</span> == <span class="number">0</span>).<span class="title function_ invoke__">take</span>(<span class="number">5</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ans</span> = <span class="title function_ invoke__">vec_loop</span>(v.<span class="title function_ invoke__">clone</span>());</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(ans, v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|x| x * <span class="number">2</span>).collect::&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_vec_map</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">v</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = (<span class="number">1</span>..).<span class="title function_ invoke__">filter</span>(|x| x % <span class="number">2</span> == <span class="number">0</span>).<span class="title function_ invoke__">take</span>(<span class="number">5</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ans</span> = <span class="title function_ invoke__">vec_map</span>(&amp;v);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(ans, v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|x| x * <span class="number">2</span>).collect::&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="背景讲解：迭代器"><a href="#背景讲解：迭代器" class="headerlink" title="背景讲解：迭代器"></a>背景讲解：迭代器</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/linysuccess/article/details/123967906">https://blog.csdn.net/linysuccess/article/details/123967906</a></p>
<p>如果我们需要一个获取 v1 所有权并返回拥有所有权的迭代器，则可以调用 into_iter 而不是 iter。类似的，如果我们希望迭代可变引用，则可以调用 iter_mut 而不是 iter。</p>
<p>第一个函数，体验迭代器：注意遍历可变引用时，需要使用 * 运算符来解引用指针以获取可变引用所指向的值，解引用之后才修改的是引用指向的实际值。</p>
<p>第二个函数体验闭包：闭包是一个编程特性。</p>
<p>下面的实现中，使用 v.iter() 方法创建一个<code>不可变的迭代器</code>，该迭代器会产生 &amp;i32 类型的元素引用。</p>
<p>然后，使用 .map() 方法对每个元素进行转换操作。.map() 方法接受一个闭包作为参数，该闭包定义了对每个元素执行的转换操作。在这里，闭包的输入参数是 element，表示迭代器产生的每个元素的引用。</p>
<p>在闭包体内部，我们将 element 乘以 2，并通过闭包体的最后一行作为返回值返回这个新的结果。最后，我们<code>使用 .collect() 方法收集迭代器产生的转换结果，并返回一个新的 Vec&lt;i32&gt; 类型的向量</code>。因此， vec_map 函数实现了对传入的向量中的每个元素进行乘以2的操作，并返回一个包含结果的新向量。原始向量 v 不会被修改。</p>
<blockquote>
<p>所有编译型语言都是数组快（但是有一些语言没有普通的数组，把 C++&#x2F;Rust 的 vec 叫做数组）。<br>数组是放在栈（stack）上的，Vec 是放在堆（heap）上的。栈访问比堆快很多。<br>所以如果是不可变长数组，且长度不是太大，肯定优先选栈上的数组。</p>
</blockquote>
<p>Rust通过单一所有权，将堆上内存管理与分配在栈上的所有者变量生命周期绑定，所有者离开作用域后堆内存也自动释放。</p>
<h2 id="024-move-semantics-move-semantics1-rs"><a href="#024-move-semantics-move-semantics1-rs" class="headerlink" title="024 move_semantics&#x2F;move_semantics1.rs"></a>024 move_semantics&#x2F;move_semantics1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vec0</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec1</span> = <span class="title function_ invoke__">fill_vec</span>(vec0);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125; content `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec1&quot;</span>, vec1.<span class="title function_ invoke__">len</span>(), vec1);</span><br><span class="line"></span><br><span class="line">    vec1.<span class="title function_ invoke__">push</span>(<span class="number">88</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125; content `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec1&quot;</span>, vec1.<span class="title function_ invoke__">len</span>(), vec1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fill_vec</span>(vec: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = vec;</span><br><span class="line"></span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">22</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">44</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">66</span>);</span><br><span class="line"></span><br><span class="line">    vec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="背景讲解：所有权和借用"><a href="#背景讲解：所有权和借用" class="headerlink" title="背景讲解：所有权和借用"></a>背景讲解：所有权和借用</h4><h5 id="clone-：复制-String-中堆上的数据，而不仅仅是栈上的数据，。"><a href="#clone-：复制-String-中堆上的数据，而不仅仅是栈上的数据，。" class="headerlink" title="clone()：复制 String 中堆上的数据，而不仅仅是栈上的数据，。"></a>clone()：复制 String 中堆上的数据，而不仅仅是栈上的数据，。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let s1 = String::from(&quot;hello&quot;);</span><br><span class="line">let s2 = s1.clone();</span><br><span class="line"></span><br><span class="line">println!(&quot;s1 = &#123;&#125;, s2 = &#123;&#125;&quot;, s1, s2);</span><br></pre></td></tr></table></figure>

<h5 id="把一个值-所有权-传来传去来使用它"><a href="#把一个值-所有权-传来传去来使用它" class="headerlink" title="把一个值(所有权)传来传去来使用它"></a>把一个值(所有权)传来传去来使用它</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let s2 = String::from(&quot;hello&quot;);     // s2 进入作用域</span><br><span class="line"></span><br><span class="line">let s3 = takes_and_gives_back(s2);  // s2 被移动到 takes_and_gives_back 中,</span><br><span class="line">                                    // 它也将返回值移给 s3</span><br></pre></td></tr></table></figure>

<p>总是把一个值(所有权)传来传去来使用它。传入一个函数，很可能还要从该函数传出去，结果就是语言表达变得非常啰嗦。</p>
<blockquote>
<p>现有的参考书，在这个地方讲得比较模糊。具体而言，一个值是如何传来传去使用，在堆上是如何表现的，并没有讲得很清楚。</p>
</blockquote>
<p>所有权的概念要从 k&#x3D;v 说起，k 有 v 的所有权。而所有权的传来传去，意思是</p>
<h5 id="引用和借用"><a href="#引用和借用" class="headerlink" title="引用和借用"></a>引用和借用</h5><p>rust 把其它语言里的指针称为 “引用和借用”，<code>*y</code> 称为 “解引用”。</p>
<p>就有了不变引用和可变引用。</p>
<blockquote>
<p>普通的传值与借用的区别，从图形上来讲，就是一级指针和二级指针的区别。为什么搞得这么复杂？</p>
</blockquote>
<h2 id="025-move-semantics-move-semantics2-rs"><a href="#025-move-semantics-move-semantics2-rs" class="headerlink" title="025 move_semantics&#x2F;move_semantics2.rs"></a>025 move_semantics&#x2F;move_semantics2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vec0</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec1</span> = <span class="title function_ invoke__">fill_vec</span>(vec0.<span class="title function_ invoke__">clone</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125;, with contents: `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec0&quot;</span>, vec0.<span class="title function_ invoke__">len</span>(), vec0);</span><br><span class="line"></span><br><span class="line">    vec1.<span class="title function_ invoke__">push</span>(<span class="number">88</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125;, with contents `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec1&quot;</span>, vec1.<span class="title function_ invoke__">len</span>(), vec1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fill_vec</span>(vec: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = vec;</span><br><span class="line"></span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">22</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">44</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">66</span>);</span><br><span class="line"></span><br><span class="line">    vec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这道题与上道题的区别在于 <code>let mut vec1 = fill_vec(vec0.clone());</code> 的下一行，是否还需要访问 vec0。</p>
<h2 id="026-move-semantics-move-semantics3-rs"><a href="#026-move-semantics-move-semantics3-rs" class="headerlink" title="026 move_semantics&#x2F;move_semantics3.rs"></a>026 move_semantics&#x2F;move_semantics3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vec0</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec1</span> = <span class="title function_ invoke__">fill_vec</span>(vec0);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125; content `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec1&quot;</span>, vec1.<span class="title function_ invoke__">len</span>(), vec1);</span><br><span class="line"></span><br><span class="line">    vec1.<span class="title function_ invoke__">push</span>(<span class="number">88</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125; content `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec1&quot;</span>, vec1.<span class="title function_ invoke__">len</span>(), vec1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fill_vec</span>(<span class="keyword">mut</span> vec: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">22</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">44</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">66</span>);</span><br><span class="line"></span><br><span class="line">    vec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 <code>fn fill_vec(vec: Vec&lt;i32&gt;)</code> 改为 <code>fn fill_vec(mut vec: Vec&lt;i32&gt;)</code>。</p>
<p>move_semantics1.rs 与该题的区别在于 <code>fill_vec</code> ，前者在函数里用了一个新变量，后者直接在 vec 上修改。</p>
<h2 id="027-move-semantics-move-semantics4-rs"><a href="#027-move-semantics-move-semantics4-rs" class="headerlink" title="027 move_semantics&#x2F;move_semantics4.rs"></a>027 move_semantics&#x2F;move_semantics4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">//let vec0 = Vec::new();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec1</span> = <span class="title function_ invoke__">fill_vec</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125; content `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec1&quot;</span>, vec1.<span class="title function_ invoke__">len</span>(), vec1);</span><br><span class="line"></span><br><span class="line">    vec1.<span class="title function_ invoke__">push</span>(<span class="number">88</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; has length &#123;&#125; content `&#123;:?&#125;`&quot;</span>, <span class="string">&quot;vec1&quot;</span>, vec1.<span class="title function_ invoke__">len</span>(), vec1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// `fill_vec()` no longer takes `vec: Vec&lt;i32&gt;` as argument</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fill_vec</span>() <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">22</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">44</span>);</span><br><span class="line">    vec.<span class="title function_ invoke__">push</span>(<span class="number">66</span>);</span><br><span class="line"></span><br><span class="line">    vec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把 fill_vec() 的参数去掉，去掉 vec0。</p>
<h2 id="028-move-semantics-move-semantics5-rs"><a href="#028-move-semantics-move-semantics5-rs" class="headerlink" title="028 move_semantics&#x2F;move_semantics5.rs"></a>028 move_semantics&#x2F;move_semantics5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = &amp;<span class="keyword">mut</span> x;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">z</span> = &amp;<span class="keyword">mut</span> x;</span><br><span class="line">    *y += <span class="number">100</span>;</span><br><span class="line">    *z += <span class="number">1000</span>;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(x, <span class="number">1200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>变量x创建了两个可变引用y和z，不满足借用规则的第2条”在同一时刻一个值不能创建多个可变引用”。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = &amp;<span class="keyword">mut</span> x;</span><br><span class="line">    *y += <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">z</span> = &amp;<span class="keyword">mut</span> x;</span><br><span class="line">    *z += <span class="number">1000</span>;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(x, <span class="number">1200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="029-move-semantics-move-semantics6-rs"><a href="#029-move-semantics-move-semantics6-rs" class="headerlink" title="029 move_semantics&#x2F;move_semantics6.rs"></a>029 move_semantics&#x2F;move_semantics6.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="string">&quot;Rust is great!&quot;</span>.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">get_char</span>(&amp;data);<span class="comment">// 不获取所有权，只有使用权</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">string_uppercase</span>(data); <span class="comment">// 获取所有权</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Should not take ownership</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_char</span>(data: &amp;<span class="type">String</span>) <span class="punctuation">-&gt;</span> <span class="type">char</span> &#123;</span><br><span class="line">    data.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">last</span>().<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Should take ownership</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">string_uppercase</span>(<span class="keyword">mut</span> data: <span class="type">String</span>) &#123;</span><br><span class="line">    data = data.<span class="title function_ invoke__">to_uppercase</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看注释，一个要求 “不获取所有权，只有使用权”，一个要求 “获取所有权”。</p>
<p>参考：rust 所有权和借用</p>
<h2 id="030-structs-structs1-rs"><a href="#030-structs-structs1-rs" class="headerlink" title="030 structs&#x2F;structs1.rs"></a>030 structs&#x2F;structs1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ColorClassicStruct</span> &#123;</span><br><span class="line">    red: <span class="type">u64</span>,</span><br><span class="line">    green: <span class="type">u64</span>,</span><br><span class="line">    blue: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ColorTupleStruct</span>(<span class="type">u64</span>,<span class="type">u64</span>,<span class="type">u64</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnitLikeStruct</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">classic_c_structs</span>() &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Instantiate a classic c struct!</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">green</span> = ColorClassicStruct&#123;</span><br><span class="line">            red: <span class="number">0</span>,</span><br><span class="line">            green: <span class="number">255</span>,</span><br><span class="line">            blue: <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(green.red, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(green.green, <span class="number">255</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(green.blue, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">tuple_structs</span>() &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Instantiate a tuple struct!</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">green</span> = <span class="title function_ invoke__">ColorTupleStruct</span>(<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(green.<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(green.<span class="number">1</span>, <span class="number">255</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(green.<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">unit_structs</span>() &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Instantiate a unit-like struct!</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">unit_like_struct</span> = UnitLikeStruct;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">message</span> = <span class="built_in">format!</span>(<span class="string">&quot;&#123;:?&#125;s are fun!&quot;</span>, unit_like_struct);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(message, <span class="string">&quot;UnitLikeStructs are fun!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="背景讲解："><a href="#背景讲解：" class="headerlink" title="背景讲解："></a>背景讲解：</h4><p>这里涉及了 3 种结构体的声明和定义。</p>
<ul>
<li><p>与元组（在第三章讨论过）类似的结构体，称为 元组结构体。</p>
</li>
<li><p>也可以定义一个没有任何字段的结构体！它们被称为 类单元结构体（unit-like structs），因为它们类似于 ()，即“元组类型”一节中提到的 unit 类型。类单元结构体常常在你想要在某个类型上实现 trait 但不需要在类型中存储数据的时候发挥作用。它适用于不关心属性而关心行为&#x2F;方法&#x2F;函数的时候。</p>
</li>
</ul>
<h2 id="031-structs-structs2-rs"><a href="#031-structs-structs2-rs" class="headerlink" title="031 structs&#x2F;structs2.rs"></a>031 structs&#x2F;structs2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    year: <span class="type">u32</span>,</span><br><span class="line">    made_by_phone: <span class="type">bool</span>,</span><br><span class="line">    made_by_mobile: <span class="type">bool</span>,</span><br><span class="line">    made_by_email: <span class="type">bool</span>,</span><br><span class="line">    item_number: <span class="type">u32</span>,</span><br><span class="line">    count: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">create_order_template</span>() <span class="punctuation">-&gt;</span> Order &#123;</span><br><span class="line">    Order &#123;</span><br><span class="line">        name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Bob&quot;</span>),</span><br><span class="line">        year: <span class="number">2019</span>,</span><br><span class="line">        made_by_phone: <span class="literal">false</span>,</span><br><span class="line">        made_by_mobile: <span class="literal">false</span>,</span><br><span class="line">        made_by_email: <span class="literal">true</span>,</span><br><span class="line">        item_number: <span class="number">123</span>,</span><br><span class="line">        count: <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">your_order</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">order_template</span> = <span class="title function_ invoke__">create_order_template</span>();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Create your own order using the update syntax and template above!</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">your_order</span> = Order &#123;</span><br><span class="line">            name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hacker in Rust&quot;</span>),</span><br><span class="line">            year: <span class="number">2019</span>,</span><br><span class="line">            made_by_phone: <span class="literal">false</span>,</span><br><span class="line">            made_by_mobile: <span class="literal">false</span>,</span><br><span class="line">            made_by_email: <span class="literal">true</span>,</span><br><span class="line">            item_number: <span class="number">123</span>,</span><br><span class="line">            count: <span class="number">1</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(your_order.name, <span class="string">&quot;Hacker in Rust&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(your_order.year, order_template.year);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(your_order.made_by_phone, order_template.made_by_phone);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(your_order.made_by_mobile, order_template.made_by_mobile);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(your_order.made_by_email, order_template.made_by_email);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(your_order.item_number, order_template.item_number);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(your_order.count, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按测试用例引导即可。</p>
<h2 id="032-structs-structs3-rs"><a href="#032-structs-structs3-rs" class="headerlink" title="032 structs&#x2F;structs3.rs"></a>032 structs&#x2F;structs3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Package</span> &#123;</span><br><span class="line">    sender_country: <span class="type">String</span>,</span><br><span class="line">    recipient_country: <span class="type">String</span>,</span><br><span class="line">    weight_in_grams: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Package</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(sender_country: <span class="type">String</span>, recipient_country: <span class="type">String</span>, weight_in_grams: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> Package &#123;</span><br><span class="line">        <span class="keyword">if</span> weight_in_grams &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">&quot;Can not ship a weightless package.&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Package &#123;</span><br><span class="line">                sender_country,</span><br><span class="line">                recipient_country,</span><br><span class="line">                weight_in_grams,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_international</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.sender_country != <span class="keyword">self</span>.recipient_country</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_fees</span>(&amp;<span class="keyword">self</span>, cents_per_gram: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.weight_in_grams * cents_per_gram</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[should_panic]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fail_creating_weightless_package</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">sender_country</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Spain&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">recipient_country</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Austria&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Package::<span class="title function_ invoke__">new</span>(sender_country, recipient_country, -<span class="number">2210</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">create_international_package</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">sender_country</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Spain&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">recipient_country</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Russia&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">package</span> = Package::<span class="title function_ invoke__">new</span>(sender_country, recipient_country, <span class="number">1200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert!</span>(package.<span class="title function_ invoke__">is_international</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">create_local_package</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">sender_country</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Canada&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">recipient_country</span> = sender_country.<span class="title function_ invoke__">clone</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">package</span> = Package::<span class="title function_ invoke__">new</span>(sender_country, recipient_country, <span class="number">1200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert!</span>(!package.<span class="title function_ invoke__">is_international</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">calculate_transport_fees</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">sender_country</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Spain&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">recipient_country</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Spain&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cents_per_gram</span> = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">package</span> = Package::<span class="title function_ invoke__">new</span>(sender_country, recipient_country, <span class="number">1500</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(package.<span class="title function_ invoke__">get_fees</span>(cents_per_gram), <span class="number">4500</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(package.<span class="title function_ invoke__">get_fees</span>(cents_per_gram * <span class="number">2</span>), <span class="number">9000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>self 是一个代表类型实例（或者是类型的引用或者是值）的关键字，在 Rust 的方法中使用 self 可以引用当前类型的实例或者类型本身。</p>
<p>具体来说，当我们定义一个方法时，使用 self 关键字作为方法的第一个参数可以让我们在调用该方法时直接访问类型实例本身。</p>
<h2 id="033-enums-enums1-rs"><a href="#033-enums-enums1-rs" class="headerlink" title="033 enums&#x2F;enums1.rs"></a>033 enums&#x2F;enums1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    Quit,</span><br><span class="line">    Echo,</span><br><span class="line">    Move,</span><br><span class="line">    ChangeColor</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, Message::Quit);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, Message::Echo);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, Message::Move);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, Message::ChangeColor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="034-enums-enums2-rs"><a href="#034-enums-enums2-rs" class="headerlink" title="034 enums&#x2F;enums2.rs"></a>034 enums&#x2F;enums2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    Move &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;,</span><br><span class="line">    <span class="title function_ invoke__">Echo</span>(<span class="type">String</span>),</span><br><span class="line">    <span class="title function_ invoke__">ChangeColor</span>(<span class="type">i32</span>, <span class="type">i32</span>, <span class="type">i32</span>),</span><br><span class="line">    Quit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">call</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">messages</span> = [</span><br><span class="line">        Message::Move &#123; x: <span class="number">10</span>, y: <span class="number">30</span> &#125;,</span><br><span class="line">        Message::<span class="title function_ invoke__">Echo</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello world&quot;</span>)),</span><br><span class="line">        Message::<span class="title function_ invoke__">ChangeColor</span>(<span class="number">200</span>, <span class="number">255</span>, <span class="number">255</span>),</span><br><span class="line">        Message::Quit,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">message</span> <span class="keyword">in</span> &amp;messages &#123;</span><br><span class="line">        message.<span class="title function_ invoke__">call</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>任何类型的数据都可以放入枚举成员中 : 例如字符串、数值、结构体甚至另一个枚举。</p>
<p>Echo(String) 是元组型的枚举。</p>
<h2 id="035-enums-enums3-rs"><a href="#035-enums-enums3-rs" class="headerlink" title="035 enums&#x2F;enums3.rs"></a>035 enums&#x2F;enums3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">ChangeColor</span>(<span class="type">i32</span>, <span class="type">i32</span>, <span class="type">i32</span>),</span><br><span class="line">    <span class="title function_ invoke__">Echo</span>(<span class="type">String</span>),</span><br><span class="line">    <span class="title function_ invoke__">Move</span>(Point),</span><br><span class="line">    Quit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">u8</span>,</span><br><span class="line">    y: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    color: (<span class="type">u8</span>, <span class="type">u8</span>, <span class="type">u8</span>),</span><br><span class="line">    position: Point,</span><br><span class="line">    quit: <span class="type">bool</span>,</span><br><span class="line">    message: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">change_color</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, color: (<span class="type">u8</span>, <span class="type">u8</span>, <span class="type">u8</span>)) &#123;</span><br><span class="line">        <span class="keyword">self</span>.color = color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">quit</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.quit = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">echo</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: <span class="type">String</span>) &#123; <span class="keyword">self</span>.message = s &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">move_position</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, p: Point) &#123;</span><br><span class="line">        <span class="keyword">self</span>.position = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">process</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, message: Message) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> create a match expression to process the different message variants</span></span><br><span class="line">        <span class="comment">// Remember: When passing a tuple as a function argument, you&#x27;ll need extra parentheses: fn function((t, u, p, l, e))</span></span><br><span class="line">        <span class="keyword">match</span> message &#123;</span><br><span class="line">            Message::<span class="title function_ invoke__">ChangeColor</span>(r,g,b)  =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">change_color</span>((r <span class="keyword">as</span> <span class="type">u8</span> ,g <span class="keyword">as</span> <span class="type">u8</span>,b <span class="keyword">as</span> <span class="type">u8</span>)),</span><br><span class="line">            Message::<span class="title function_ invoke__">Echo</span>(s) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">echo</span>(s),</span><br><span class="line">            Message::<span class="title function_ invoke__">Move</span>(args) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">move_position</span>(args),</span><br><span class="line">            Message::Quit =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">quit</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_match_message_call</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">state</span> = State &#123;</span><br><span class="line">            quit: <span class="literal">false</span>,</span><br><span class="line">            position: Point &#123; x: <span class="number">0</span>, y: <span class="number">0</span> &#125;,</span><br><span class="line">            color: (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">            message: <span class="string">&quot;hello world&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line">        state.<span class="title function_ invoke__">process</span>(Message::<span class="title function_ invoke__">ChangeColor</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>));</span><br><span class="line">        state.<span class="title function_ invoke__">process</span>(Message::<span class="title function_ invoke__">Echo</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello world&quot;</span>)));</span><br><span class="line">        state.<span class="title function_ invoke__">process</span>(Message::<span class="title function_ invoke__">Move</span>(Point &#123; x: <span class="number">10</span>, y: <span class="number">15</span> &#125;));</span><br><span class="line">        state.<span class="title function_ invoke__">process</span>(Message::Quit);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(state.color, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(state.position.x, <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(state.position.y, <span class="number">15</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(state.quit, <span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(state.message, <span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>match 的出现是为了防止我们写太多的 if，那样就比较丑陋。</p>
<h2 id="036-strings-strings1-rs"><a href="#036-strings-strings1-rs" class="headerlink" title="036 strings&#x2F;strings1.rs"></a>036 strings&#x2F;strings1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">answer</span> = <span class="title function_ invoke__">current_favorite_color</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;My current favorite color is &#123;&#125;&quot;</span>, answer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">current_favorite_color</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="string">&quot;blue&quot;</span>.<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Rust 有两种字符串类型：str 和 String。其中 str 是 String 的切片类型，也就是说，str 类型的字符串值是 String 类型的字符串值的一部分或全部。</p>
<h4 id="1-先看-str："><a href="#1-先看-str：" class="headerlink" title="1. 先看 str："></a>1. 先看 str：</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>()&#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">  <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码等价于：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>()&#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">s</span>: &amp;<span class="type">str</span> = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">  <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>“helloworld” 保存在 literal 块，它是一个类似于 text &#x2F; data &#x2F; bss 块。</p>
<p>stack 里的指针 s 指向 literal 块的 “helloworld”。</p>
<blockquote>
<p>str (stack) ——–&gt; “helloworld” (literal)</p>
</blockquote>
<h4 id="2-再看-string"><a href="#2-再看-string" class="headerlink" title="2. 再看 string"></a>2. 再看 string</h4><p>let s &#x3D; String::from(“hello”);</p>
<p>编译器将 “hello” 放在 literal 内存区，当程序运行到let s &#x3D; String::from()操作时，从字面量内存区将其拷贝到堆内存中。</p>
<blockquote>
<p>str (stack) ——–&gt; “helloworld” (literal)——–&gt; “helloworld” (heap)</p>
</blockquote>
<p>最终即为：</p>
<blockquote>
<p>str (stack) ——–&gt; “helloworld” (heap)</p>
</blockquote>
<h2 id="037-strings-strings2-rs"><a href="#037-strings-strings2-rs" class="headerlink" title="037 strings&#x2F;strings2.rs"></a>037 strings&#x2F;strings2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">word</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;green&quot;</span>); <span class="comment">// Try not changing this line :)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_ invoke__">is_a_color_word</span>(&amp;word) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;That is a color word I know!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;That is not a color word I know.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">is_a_color_word</span>(attempt: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    attempt == <span class="string">&quot;green&quot;</span> || attempt == <span class="string">&quot;blue&quot;</span> || attempt == <span class="string">&quot;red&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="038-strings-strings3-rs"><a href="#038-strings-strings3-rs" class="headerlink" title="038 strings&#x2F;strings3.rs"></a>038 strings&#x2F;strings3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">trim_me</span>(input: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Remove whitespace from both ends of a string!</span></span><br><span class="line">    input.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">compose_me</span>(input: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Add &quot; world!&quot; to the string! There&#x27;s multiple ways to do this!</span></span><br><span class="line">    <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125; world!&quot;</span>, input)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">replace_me</span>(input: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Replace &quot;cars&quot; in the string with &quot;balloons&quot;!</span></span><br><span class="line">    input.<span class="title function_ invoke__">replace</span>(<span class="string">&quot;cars&quot;</span>, <span class="string">&quot;balloons&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">trim_a_string</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">trim_me</span>(<span class="string">&quot;Hello!     &quot;</span>), <span class="string">&quot;Hello!&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">trim_me</span>(<span class="string">&quot;  What&#x27;s up!&quot;</span>), <span class="string">&quot;What&#x27;s up!&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">trim_me</span>(<span class="string">&quot;   Hola!  &quot;</span>), <span class="string">&quot;Hola!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">compose_a_string</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">compose_me</span>(<span class="string">&quot;Hello&quot;</span>), <span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">compose_me</span>(<span class="string">&quot;Goodbye&quot;</span>), <span class="string">&quot;Goodbye world!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">replace_a_string</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">replace_me</span>(<span class="string">&quot;I think cars are cool&quot;</span>), <span class="string">&quot;I think balloons are cool&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">replace_me</span>(<span class="string">&quot;I love to look at cars&quot;</span>), <span class="string">&quot;I love to look at balloons&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>有点不理解，assert_eq 的第一个参数是 string, 第二个参数都是 str 类型，怎么能比较？</p>
</blockquote>
<h2 id="039-strings-strings4-rs"><a href="#039-strings-strings4-rs" class="headerlink" title="039 strings&#x2F;strings4.rs"></a>039 strings&#x2F;strings4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ok, here are a bunch of values-## some are `String`s, some are `&amp;str`s.</span></span><br><span class="line"><span class="comment">// Your task is to call one of these two functions on each value depending on what</span></span><br><span class="line"><span class="comment">// you think each value is. That is, add either `string_slice` or `string`</span></span><br><span class="line"><span class="comment">// before the parentheses on each line.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">string_slice</span>(arg: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">string</span>(arg: <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">string_slice</span>(<span class="string">&quot;blue&quot;</span>);           <span class="comment">// str</span></span><br><span class="line">    <span class="title function_ invoke__">string</span>(<span class="string">&quot;red&quot;</span>.<span class="title function_ invoke__">to_string</span>());      <span class="comment">// String</span></span><br><span class="line">    <span class="title function_ invoke__">string</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hi&quot;</span>));     <span class="comment">// String</span></span><br><span class="line">    <span class="title function_ invoke__">string</span>(<span class="string">&quot;rust is fun!&quot;</span>.<span class="title function_ invoke__">to_owned</span>());</span><br><span class="line">    <span class="title function_ invoke__">string_slice</span>(<span class="string">&quot;nice weather&quot;</span>.<span class="title function_ invoke__">into</span>());</span><br><span class="line">    <span class="title function_ invoke__">string</span>(<span class="built_in">format!</span>(<span class="string">&quot;Interpolation &#123;&#125;&quot;</span>, <span class="string">&quot;Station&quot;</span>));     <span class="comment">//str</span></span><br><span class="line">    <span class="title function_ invoke__">string_slice</span>(&amp;<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;abc&quot;</span>)[<span class="number">0</span>..<span class="number">1</span>]);           <span class="comment">//str</span></span><br><span class="line">    <span class="title function_ invoke__">string_slice</span>(<span class="string">&quot;  hello there &quot;</span>.<span class="title function_ invoke__">trim</span>());              <span class="comment">//str</span></span><br><span class="line">    <span class="title function_ invoke__">string</span>(<span class="string">&quot;Happy Monday!&quot;</span>.<span class="title function_ invoke__">to_string</span>().<span class="title function_ invoke__">replace</span>(<span class="string">&quot;Mon&quot;</span>, <span class="string">&quot;Tues&quot;</span>)); <span class="comment">//String</span></span><br><span class="line">    <span class="title function_ invoke__">string</span>(<span class="string">&quot;mY sHiFt KeY iS sTiCkY&quot;</span>.<span class="title function_ invoke__">to_lowercase</span>());    <span class="comment">// str</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下都是 string 类型，值得注意的地方是 trim 返回的是 &amp;tr 类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s.to_owned()</span><br><span class="line">s.to_string()</span><br><span class="line">s.into()</span><br><span class="line">String::from(s)</span><br><span class="line">format</span><br></pre></td></tr></table></figure>


<h2 id="040-modules-modules1-rs"><a href="#040-modules-modules1-rs" class="headerlink" title="040 modules&#x2F;modules1.rs"></a>040 modules&#x2F;modules1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> sausage_factory &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t let anybody outside of this module see this!</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_secret_recipe</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Ginger&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">make_sausage</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">get_secret_recipe</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;sausage!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    sausage_factory::<span class="title function_ invoke__">make_sausage</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>crate 分成二进制 crate 和包 crate。cargo new my-project 创建了一个名为 my-project 的二进制 Crate。</li>
<li>mod 与 namespace 相似，mod 与 mod 之前互相隔离。</li>
<li>路径：mod 层级系统与文件系统比较类似，比如 &#x2F;a&#x2F;b&#x2F;c 对应于 crate::a::b::c，其中 crate 相当于 &#x2F;。</li>
</ul>
<h2 id="041-modules-modules2-rs"><a href="#041-modules-modules2-rs" class="headerlink" title="041 modules&#x2F;modules2.rs"></a>041 modules&#x2F;modules2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> delicious_snacks &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Fix these use statements</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">use</span> self::fruits::PEAR <span class="keyword">as</span> fruit;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">use</span> self::veggies::CUCUMBER <span class="keyword">as</span> veggie;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mod</span> fruits &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> PEAR: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;Pear&quot;</span>;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> APPLE: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;Apple&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mod</span> veggies &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> CUCUMBER: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;Cucumber&quot;</span>;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> CARROT: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;Carrot&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">&quot;favorite snacks: &#123;&#125; and &#123;&#125;&quot;</span>,</span><br><span class="line">        delicious_snacks::fruit,</span><br><span class="line">        delicious_snacks::veggie</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>use 就是其它语言的 import，as 就是一个别名。</p>
<h2 id="042-modules-modules3-rs"><a href="#042-modules-modules3-rs" class="headerlink" title="042 modules&#x2F;modules3.rs"></a>042 modules&#x2F;modules3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::time::SystemTime;</span><br><span class="line"><span class="keyword">use</span> std::time::UNIX_EPOCH;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">match</span> SystemTime::<span class="title function_ invoke__">now</span>().<span class="title function_ invoke__">duration_since</span>(UNIX_EPOCH) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(n) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;1970-01-01 00:00:00 UTC was &#123;&#125; seconds ago!&quot;</span>, n.<span class="title function_ invoke__">as_secs</span>()),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;SystemTime before UNIX EPOCH!&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>use 就是其它语言的 import。</p>
<h2 id="043-hashmaps-hashmaps1-rs"><a href="#043-hashmaps-hashmaps1-rs" class="headerlink" title="043 hashmaps&#x2F;hashmaps1.rs"></a>043 hashmaps&#x2F;hashmaps1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fruit_basket</span>() <span class="punctuation">-&gt;</span> HashMap&lt;<span class="type">String</span>, <span class="type">u32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">basket</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Put more fruits in your basket here.</span></span><br><span class="line">    basket.<span class="title function_ invoke__">insert</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;banana&quot;</span>), <span class="number">2</span>);</span><br><span class="line">    basket.<span class="title function_ invoke__">insert</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;apple&quot;</span>), <span class="number">3</span>);</span><br><span class="line">    basket.<span class="title function_ invoke__">insert</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;mango&quot;</span>), <span class="number">4</span>);</span><br><span class="line">    basket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="044-hashmaps-hashmaps2-rs"><a href="#044-hashmaps-hashmaps2-rs" class="headerlink" title="044 hashmaps&#x2F;hashmaps2.rs"></a>044 hashmaps&#x2F;hashmaps2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="variable">fruit</span> <span class="keyword">in</span> fruit_kinds &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Insert new fruits if they are not already present in the</span></span><br><span class="line">    <span class="comment">// basket. Note that you are not allowed to put any type of fruit that&#x27;s</span></span><br><span class="line">    <span class="comment">// already present!</span></span><br><span class="line">    <span class="comment">// 查询Yellow对应的值，若不存在则插入新值</span></span><br><span class="line">    basket.<span class="title function_ invoke__">entry</span>(fruit).<span class="title function_ invoke__">or_insert</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> <span class="variable">fruit</span> <span class="keyword">in</span> fruit_kinds &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Put new fruits if not already present. Note that you</span></span><br><span class="line">    <span class="comment">// are not allowed to put any type of fruit that&#x27;s already</span></span><br><span class="line">    <span class="comment">// present!</span></span><br><span class="line">    <span class="keyword">if</span> !basket.<span class="title function_ invoke__">contains_key</span>(&amp;fruit) &#123;</span><br><span class="line">        basket.<span class="title function_ invoke__">insert</span>(fruit, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="045-hashmaps-hashmaps3-rs"><a href="#045-hashmaps-hashmaps3-rs" class="headerlink" title="045 hashmaps&#x2F;hashmaps3.rs"></a>045 hashmaps&#x2F;hashmaps3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A structure to store the goal details of a team.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Team</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    goals_scored: <span class="type">u8</span>,</span><br><span class="line">    goals_conceded: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">build_scores_table</span>(results: <span class="type">String</span>) <span class="punctuation">-&gt;</span> HashMap&lt;<span class="type">String</span>, Team&gt; &#123;</span><br><span class="line">    <span class="comment">// The name of the team is the key and its associated struct is the value.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">scores</span>: HashMap&lt;<span class="type">String</span>, Team&gt; = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">r</span> <span class="keyword">in</span> results.<span class="title function_ invoke__">lines</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">v</span>: <span class="type">Vec</span>&lt;&amp;<span class="type">str</span>&gt; = r.<span class="title function_ invoke__">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team_1_name</span> = v[<span class="number">0</span>].<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team_1_score</span>: <span class="type">u8</span> = v[<span class="number">2</span>].<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team_2_name</span> = v[<span class="number">1</span>].<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team_2_score</span>: <span class="type">u8</span> = v[<span class="number">3</span>].<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Populate the scores table with details extracted from the</span></span><br><span class="line">        <span class="comment">// current line. Keep in mind that goals scored by team_1</span></span><br><span class="line">        <span class="comment">// will be the number of goals conceded from team_2, and similarly</span></span><br><span class="line">        <span class="comment">// goals scored by team_2 will be the number of goals conceded by</span></span><br><span class="line">        <span class="comment">// team_1.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team_1</span> = scores.<span class="title function_ invoke__">entry</span>(team_1_name).<span class="title function_ invoke__">or_insert</span>(</span><br><span class="line">            Team &#123;</span><br><span class="line">                goals_scored: <span class="number">0</span>,</span><br><span class="line">                goals_conceded: <span class="number">0</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        team_1.goals_scored += team_1_score;</span><br><span class="line">        team_1.goals_conceded += team_2_score;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the team 2 score</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team_2</span> = scores.<span class="title function_ invoke__">entry</span>(team_2_name.<span class="title function_ invoke__">clone</span>()).<span class="title function_ invoke__">or_insert</span>(Team &#123;</span><br><span class="line">            goals_scored: <span class="number">0</span>,</span><br><span class="line">            goals_conceded: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        team_2.goals_scored += team_2_score;</span><br><span class="line">        team_2.goals_conceded += team_1_score;</span><br><span class="line">    &#125;</span><br><span class="line">    scores</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_results</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">results</span> = <span class="string">&quot;&quot;</span>.<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">            + <span class="string">&quot;England,France,4,2\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;France,Italy,3,1\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;Poland,Spain,2,0\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;Germany,England,2,1\n&quot;</span>;</span><br><span class="line">        results</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">build_scores</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">scores</span> = <span class="title function_ invoke__">build_scores_table</span>(<span class="title function_ invoke__">get_results</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">keys</span>: <span class="type">Vec</span>&lt;&amp;<span class="type">String</span>&gt; = scores.<span class="title function_ invoke__">keys</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">        keys.<span class="title function_ invoke__">sort</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            keys,</span><br><span class="line">            <span class="built_in">vec!</span>[<span class="string">&quot;England&quot;</span>, <span class="string">&quot;France&quot;</span>, <span class="string">&quot;Germany&quot;</span>, <span class="string">&quot;Italy&quot;</span>, <span class="string">&quot;Poland&quot;</span>, <span class="string">&quot;Spain&quot;</span>]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">validate_team_score_1</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">scores</span> = <span class="title function_ invoke__">build_scores_table</span>(<span class="title function_ invoke__">get_results</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team</span> = scores.<span class="title function_ invoke__">get</span>(<span class="string">&quot;England&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_scored, <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_conceded, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">validate_team_score_2</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">scores</span> = <span class="title function_ invoke__">build_scores_table</span>(<span class="title function_ invoke__">get_results</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">team</span> = scores.<span class="title function_ invoke__">get</span>(<span class="string">&quot;Spain&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_scored, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_conceded, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>u8.parse().unwrap() 查一下。</p>
</blockquote>
<blockquote>
<p>let v: Vec&lt;&amp;str&gt; &#x3D; r.split(‘,’).collect();<br>查一下。</p>
</blockquote>
<h2 id="046-quiz2-rs"><a href="#046-quiz2-rs" class="headerlink" title="046 quiz2.rs"></a>046 quiz2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is a quiz for the following sections:</span></span><br><span class="line"><span class="comment">// ## Strings</span></span><br><span class="line"><span class="comment">// ## Vecs</span></span><br><span class="line"><span class="comment">// ## Move semantics</span></span><br><span class="line"><span class="comment">// ## Modules</span></span><br><span class="line"><span class="comment">// ## Enums</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Let&#x27;s build a little machine in the form of a function.</span></span><br><span class="line"><span class="comment">// As input, we&#x27;re going to give a list of strings and commands.</span></span><br><span class="line"><span class="comment">// These commands determine what action is going to be applied to the string.</span></span><br><span class="line"><span class="comment">// It can either be:</span></span><br><span class="line"><span class="comment">// ## Uppercase the string</span></span><br><span class="line"><span class="comment">// ## Trim the string</span></span><br><span class="line"><span class="comment">// ## Append &quot;bar&quot; to the string a specified amount of times The exact form of this will be:</span></span><br><span class="line">        <span class="comment">// ## The input is going to be a Vector of a 2-length tuple,</span></span><br><span class="line">        <span class="comment">//   the first element is the string, the second one is the command.</span></span><br><span class="line">        <span class="comment">// ## The output element is going to be a Vector of strings.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">    Uppercase,</span><br><span class="line">    Trim,</span><br><span class="line">    <span class="title function_ invoke__">Append</span>(<span class="type">usize</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> my_module &#123;</span><br><span class="line">    <span class="keyword">use</span> super::Command;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Complete the function signature!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transformer</span>(input: <span class="type">Vec</span>&lt;(<span class="type">String</span>, Command)&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Complete the output declaration!</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">output</span>: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">for</span> (string, command) <span class="keyword">in</span> input.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">            <span class="keyword">match</span> command &#123;</span><br><span class="line">                Command::Uppercase =&gt; &#123;</span><br><span class="line">                    output.<span class="title function_ invoke__">push</span>(string.<span class="title function_ invoke__">to_uppercase</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                Command::Trim =&gt; &#123;</span><br><span class="line">                    output.<span class="title function_ invoke__">push</span>(string.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                Command::<span class="title function_ invoke__">Append</span>(<span class="type">usize</span>) =&gt;&#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ans</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">                    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..*<span class="type">usize</span> &#123;</span><br><span class="line">                        ans += &amp;string.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    output.<span class="title function_ invoke__">push</span>(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;bar&quot;</span>, ans));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> What do we need to import to have `transformer` in scope?</span></span><br><span class="line">    <span class="keyword">use</span> crate::my_module::transformer;</span><br><span class="line">    <span class="keyword">use</span> super::Command;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">it_works</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">output</span> = <span class="title function_ invoke__">transformer</span>(<span class="built_in">vec!</span>[</span><br><span class="line">            (<span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">into</span>(), Command::Uppercase),</span><br><span class="line">            (<span class="string">&quot; all roads lead to rome! &quot;</span>.<span class="title function_ invoke__">into</span>(), Command::Trim),</span><br><span class="line">            (<span class="string">&quot;foo&quot;</span>.<span class="title function_ invoke__">into</span>(), Command::<span class="title function_ invoke__">Append</span>(<span class="number">1</span>)),</span><br><span class="line">            (<span class="string">&quot;bar&quot;</span>.<span class="title function_ invoke__">into</span>(), Command::<span class="title function_ invoke__">Append</span>(<span class="number">5</span>)),</span><br><span class="line">        ]);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">0</span>], <span class="string">&quot;HELLO&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">1</span>], <span class="string">&quot;all roads lead to rome!&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">2</span>], <span class="string">&quot;foobar&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">3</span>], <span class="string">&quot;barbarbarbarbarbar&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="047-options-options1-rs"><a href="#047-options-options1-rs" class="headerlink" title="047 options&#x2F;options1.rs"></a>047 options&#x2F;options1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">maybe_icecream</span>(time_of_day: <span class="type">u16</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u16</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// We use the 24-hour system here, so 10PM is a value of 22</span></span><br><span class="line">    <span class="comment">// and 12AM is a value of 0</span></span><br><span class="line">    <span class="comment">// The Option output should gracefully handle cases where time_of_day &gt; 23.</span></span><br><span class="line">    <span class="comment">// remember to return an Option!</span></span><br><span class="line">    <span class="keyword">if</span> time_of_day &gt; <span class="number">24</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> time_of_day &lt;= <span class="number">12</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="number">5</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">check_icecream</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">maybe_icecream</span>(<span class="number">9</span>), <span class="title function_ invoke__">Some</span>(<span class="number">5</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">maybe_icecream</span>(<span class="number">10</span>), <span class="title function_ invoke__">Some</span>(<span class="number">5</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">maybe_icecream</span>(<span class="number">23</span>), <span class="title function_ invoke__">Some</span>(<span class="number">0</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">maybe_icecream</span>(<span class="number">22</span>), <span class="title function_ invoke__">Some</span>(<span class="number">0</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">maybe_icecream</span>(<span class="number">25</span>), <span class="literal">None</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">raw_value</span>() &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Fix this test. How do you get at the value contained in the</span></span><br><span class="line">        <span class="comment">// Option?</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">icecreams</span> = <span class="title function_ invoke__">maybe_icecream</span>(<span class="number">12</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(icecreams, <span class="title function_ invoke__">Some</span>(<span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>option 的出现是为了应对空指针。</p>
<blockquote>
<p>Some() 是个什么东西？</p>
</blockquote>
<h4 id="背景讲解：Option"><a href="#背景讲解：Option" class="headerlink" title="背景讲解：Option"></a>背景讲解：Option</h4><p>Option 是Rust中核心的枚举类型，它表示一个值可能存在，也可能不存在的情况。其提出是为了让空值得到有效的处理。任何可能为空值的结果都应被处理为Option。</p>
<p>Option 的枚举情况有两种，分别是代表有的Some()和代表无的 None。</p>
<p>Option 本质上是一个枚举，有两种分别是Some 和 None。Some 代表有值，None 则类似于 null，代表无值。</p>
<p>在 Option 类型中，”some” 表示某个具体的值存在，它的语法格式为 Some(value)，其中 value 是具体的值。</p>
<p>使用 unwrap<br>如果我们确定 Option 中一定存在值，可以使用 unwrap 方法来获取该值。如果 Option 中不存在值，则会触发 panic。<br>rust复制代码let some_value: Option<i32> &#x3D; Some(5);</p>
<p>let value &#x3D; some_value.unwrap();<br>println!(“The value is {}”, value);</p>
<h2 id="048-options-options2-rs"><a href="#048-options-options2-rs" class="headerlink" title="048 options&#x2F;options2.rs"></a>048 options&#x2F;options2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">simple_option</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">target</span> = <span class="string">&quot;rustlings&quot;</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">optional_target</span> = <span class="title function_ invoke__">Some</span>(target);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Make this an if let statement whose value is &quot;Some&quot; type</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(word) = optional_target &#123;</span><br><span class="line">            <span class="built_in">assert_eq!</span>(word, target);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">layered_option</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">range</span> = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">optional_integers</span>: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;<span class="type">i8</span>&gt;&gt; = <span class="built_in">vec!</span>[<span class="literal">None</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1, 2, 3, 4 ...</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..(range + <span class="number">1</span>) &#123;</span><br><span class="line">            optional_integers.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">Some</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cursor</span> = range;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> make this a while let statement ## remember that vector.pop also</span></span><br><span class="line">        <span class="comment">// adds another layer of Option&lt;T&gt;. You can stack `Option&lt;T&gt;`s into</span></span><br><span class="line">        <span class="comment">// while let and if let.</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(<span class="title function_ invoke__">Some</span>(integer)) = optional_integers.<span class="title function_ invoke__">pop</span>() &#123;</span><br><span class="line">            <span class="built_in">assert_eq!</span>(integer, cursor);</span><br><span class="line">            cursor -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(cursor, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pop() -&gt; option<T></p>
<p>调用 pop 方法时，它会从数组的末尾移除一个元素。并且 pop 的返回值会套上 Option<T>。</p>
<p>因此，上例类型是 Vec&lt;Option<i8>&gt;，所以 pop 方法返回的类型是 Option&lt;Option<i8>&gt;。</p>
<h2 id="049-options-options3-rs"><a href="#049-options-options3-rs" class="headerlink" title="049 options&#x2F;options3.rs"></a>049 options&#x2F;options3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span>: <span class="type">Option</span>&lt;Point&gt; = <span class="title function_ invoke__">Some</span>(Point &#123; x: <span class="number">100</span>, y: <span class="number">200</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> y &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="keyword">ref</span> p) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Co-ordinates are &#123;&#125;,&#123;&#125; &quot;</span>, p.x, p.y),</span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;no match!&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    y; <span class="comment">// Fix without deleting this line.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再取Option里面的结构体的时候,我们需要知道,结构体在option里面,所有权是归Option值的,后面又访问了一次Option值,所以说y还没有放弃所有权,只能通过引用去访问。( y没有放弃所有权,里面的结构体也是属于y的,y&#x3D; Some(p)来取数据是不对的 )</p>
<blockquote>
<p>用 <code>ref p</code> 这种形式引用，比较奇怪，为什么不用 <code>&amp;</code>?</p>
</blockquote>
<h2 id="050-error-handling-errors1-rs"><a href="#050-error-handling-errors1-rs" class="headerlink" title="050 error_handling&#x2F;errors1.rs"></a>050 error_handling&#x2F;errors1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">generate_nametag_text</span>(name: <span class="type">String</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> name.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">        <span class="comment">// Empty names aren&#x27;t allowed.</span></span><br><span class="line">        <span class="title function_ invoke__">Err</span>(<span class="string">&quot;`name` was empty; it must be nonempty.&quot;</span>.<span class="title function_ invoke__">to_string</span>())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="built_in">format!</span>(<span class="string">&quot;Hi! My name is &#123;&#125;&quot;</span>, name))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">generates_nametag_text_for_a_nonempty_name</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="title function_ invoke__">generate_nametag_text</span>(<span class="string">&quot;Beyoncé&quot;</span>.<span class="title function_ invoke__">into</span>()),</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="string">&quot;Hi! My name is Beyoncé&quot;</span>.<span class="title function_ invoke__">into</span>())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">explains_why_generating_nametag_text_fails</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="title function_ invoke__">generate_nametag_text</span>(<span class="string">&quot;&quot;</span>.<span class="title function_ invoke__">into</span>()),</span><br><span class="line">            <span class="comment">// Don&#x27;t change this line</span></span><br><span class="line">            <span class="title function_ invoke__">Err</span>(<span class="string">&quot;`name` was empty; it must be nonempty.&quot;</span>.<span class="title function_ invoke__">into</span>())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="背景讲解：-From-和-Into"><a href="#背景讲解：-From-和-Into" class="headerlink" title="背景讲解： From 和 Into"></a>背景讲解： From 和 Into</h4><p>From 和 Into 两个 trait 是内部相关联的，实际上这是它们实现的一部分。如果我们能够从类型 B 得到类型 A，那么很容易相信我们也能够把类型 B 转换为类型 A。</p>
<p>From trait 允许一种类型定义 “怎么根据另一种类型生成自己”，<br>String::from(str); 根据 str 生成 string。</p>
<p>Into trait 就是把 From trait 倒过来而已。</p>
<h4 id="背景讲解：-Result"><a href="#背景讲解：-Result" class="headerlink" title="背景讲解： Result"></a>背景讲解： Result</h4><p>Rust对可靠性的执着也延伸到了错误处理。在很多情况下，Rust 要求你承认出错的可能性，并在编译代码之前就采取行动。这些要求使得程序更为健壮。Rust将错误组合为两个主要类别：可恢复错误和不可恢复错误。大部分语言并不区分这两类错误，并采用类似异常这样方式统一处理他们。Rust并没有异常，但是，有可恢复错误 Result&lt;T, E&gt;，和不可恢复(遇到错误时停止程序执行)错误panic!。</p>
<p>panic!前面已经接触过，但大多数错误并没有严重到需要程序完全停止执行。</p>
<p>我们先来说说题目中的那个option是怎么回事。</p>
<p>Option是标准库定义的一个枚举，它编码了一个常见的情况：一个值要么有值要么没值。Rust并没有空值，不过它确实拥有一个可以编码存在或不存在概念的枚举。这个枚举就是Option。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enum Option&lt;T&gt; &#123;</span><br><span class="line">    Some(T),</span><br><span class="line">    None,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>泛型参数使得它可以包含任意类型的数据。我们现在知道它和错误处理没什么关系。对于可恢复错误，标准库也有一个枚举，Result。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enum Result&lt;T, E&gt; &#123;</span><br><span class="line">    Ok(T),</span><br><span class="line">    Err(E),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>T表示成功时返回的Ok成员中的数据类型，E代表失败时返回的Err成员中的错误类型。所以我们修改程序。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pub fn generate_nametag_text(name: String) -&gt; Result&lt;String, String&gt; &#123;</span><br><span class="line">    if name.len() &gt; 0 &#123;</span><br><span class="line">        Ok(format!(&quot;Hi! My name is &#123;&#125;&quot;, name))</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Empty names aren&#x27;t allowed.</span><br><span class="line">        //None</span><br><span class="line">        Err(&quot;`name` was empty; it must be nonempty.&quot;.to_string())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#[cfg(test)]</span><br><span class="line">mod tests &#123;</span><br><span class="line">    use super::*;</span><br><span class="line"></span><br><span class="line">    // This test passes initially if you comment out the 2nd test.</span><br><span class="line">    // You&#x27;ll need to update what this test expects when you change</span><br><span class="line">    // the function under test!</span><br><span class="line">    #[test]</span><br><span class="line">    fn generates_nametag_text_for_a_nonempty_name() &#123;</span><br><span class="line">        assert_eq!(</span><br><span class="line">            generate_nametag_text(&quot;Beyoncé&quot;.into()),</span><br><span class="line">            Ok(&quot;Hi! My name is Beyoncé&quot;.into())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #[test]</span><br><span class="line">    fn explains_why_generating_nametag_text_fails() &#123;</span><br><span class="line">        assert_eq!(</span><br><span class="line">            generate_nametag_text(&quot;&quot;.into()),</span><br><span class="line">            Err(&quot;`name` was empty; it must be nonempty.&quot;.into())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就能通过了，</p>
<h2 id="051-error-handling-errors2-rs"><a href="#051-error-handling-errors2-rs" class="headerlink" title="051 error_handling&#x2F;errors2.rs"></a>051 error_handling&#x2F;errors2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::num::ParseIntError;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">total_cost</span>(item_quantity: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, ParseIntError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">processing_fee</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cost_per_item</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qty</span> = item_quantity.parse::&lt;<span class="type">i32</span>&gt;()?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(qty * cost_per_item + processing_fee)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">item_quantity_is_a_valid_number</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">total_cost</span>(<span class="string">&quot;34&quot;</span>), <span class="title function_ invoke__">Ok</span>(<span class="number">171</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">item_quantity_is_an_invalid_number</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="title function_ invoke__">total_cost</span>(<span class="string">&quot;beep boop&quot;</span>).<span class="title function_ invoke__">unwrap_err</span>().<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            <span class="string">&quot;invalid digit found in string&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>total_cost(&quot;beep boop&quot;).unwrap_err().to_string()</code> 这种形式还待查一下。</p>
</blockquote>
<blockquote>
<p><code>let qty = item_quantity.parse::&lt;i32&gt;()?; 后面这个 </code> <code>?</code> 什么意思？</p>
</blockquote>
<p>? 运算符只能被用于返回值与 ? 作用的值相兼容的函数。因为 ? 运算符被定义为从函数中提早返回一个值，这与 match 表达式有着完全相同的工作方式。</p>
<p>看上去 <code>?</code> 是返回值的简化版，不需要 match 这种比较复杂的形式。</p>
<p>参考：用 Result 处理可恢复的错误，<a target="_blank" rel="noopener" href="https://kaisery.github.io/trpl-zh-cn/ch09-02-recoverable-errors-with-result.html">https://kaisery.github.io/trpl-zh-cn/ch09-02-recoverable-errors-with-result.html</a></p>
<h4 id="看下面的例子，-避免了对变量类型的判断。"><a href="#看下面的例子，-避免了对变量类型的判断。" class="headerlink" title="看下面的例子，? 避免了对变量类型的判断。"></a>看下面的例子，<code>?</code> 避免了对变量类型的判断。</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">multiply</span>(first_number_str: &amp;<span class="type">str</span>, second_number_str: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, ParseIntError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first_number</span> = first_number_str.parse::&lt;<span class="type">i32</span>&gt;()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">second_number</span> = second_number_str.parse::&lt;<span class="type">i32</span>&gt;()?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(first_number * second_number)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="052-error-handling-errors3-rs"><a href="#052-error-handling-errors3-rs" class="headerlink" title="052 error_handling&#x2F;errors3.rs"></a>052 error_handling&#x2F;errors3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对于库代码，不建议使用“Box&lt;dyn error::Error&gt;”之类的万能错误类型，因为调用者可能希望根据错误内容做出决策，而不是将其打印出来或进一步传播。在这里，我们定义了一个自定义错误类型，以便调用者能够决定当我们的函数返回错误时下一步要做什么。</span></span><br><span class="line"><span class="keyword">use</span> std::num::ParseIntError;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), ParseIntError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tokens</span> = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pretend_user_input</span> = <span class="string">&quot;8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cost</span> = <span class="title function_ invoke__">total_cost</span>(pretend_user_input)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cost &gt; tokens &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;You can&#x27;t afford that many!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tokens -= cost;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;You now have &#123;&#125; tokens.&quot;</span>, tokens);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">total_cost</span>(item_quantity: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, ParseIntError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">processing_fee</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cost_per_item</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qty</span> = item_quantity.parse::&lt;<span class="type">i32</span>&gt;()?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(qty * cost_per_item + processing_fee)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>main 的最后一行添加了 <code>Ok(())</code>。</p>
<p>main函数默认没有返回值，或者说返回值类型是()，在这种函数中不能使用 ?，故而有两种解决方案：</p>
<ul>
<li>给main函数增加返回值类型，fn main() -&gt; Result&lt;(), ParseIntError&gt;</li>
<li>不使用?，用unwrap代替：letcost&#x3D;total_cost(pretend_user_input).unwrap();</li>
</ul>
<h4 id="unwrap-故障时执行panic"><a href="#unwrap-故障时执行panic" class="headerlink" title="unwrap: 故障时执行panic"></a>unwrap: 故障时执行panic</h4><p>并且你知道或者期望它一定是 Ok 值（即不包含错误）时，可以使用 .unwrap() 方法。它会提取并返回 Ok 包含的值。但如果该 Result 是 Err 值（包含错误），.unwrap() 会触发一个运行时panic，并停止程序执行，同时打印出错误信息。</p>
<h4 id="故障时返回Err对象"><a href="#故障时返回Err对象" class="headerlink" title="?: 故障时返回Err对象"></a>?: 故障时返回Err对象</h4><h2 id="053-error-handling-errors4-rs"><a href="#053-error-handling-errors4-rs" class="headerlink" title="053 error_handling&#x2F;errors4.rs"></a>053 error_handling&#x2F;errors4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PositiveNonzeroInteger</span>(<span class="type">u64</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">CreationError</span> &#123;</span><br><span class="line">    Negative,</span><br><span class="line">    Zero,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PositiveNonzeroInteger</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(value: <span class="type">i64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;PositiveNonzeroInteger, CreationError&gt; &#123;</span><br><span class="line">        <span class="comment">// Hmm...? Why is this only returning an Ok value?</span></span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">PositiveNonzeroInteger</span>(value <span class="keyword">as</span> <span class="type">u64</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> value ==<span class="number">0</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(CreationError::Zero)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(CreationError::Negative)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_creation</span>() &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(PositiveNonzeroInteger::<span class="title function_ invoke__">new</span>(<span class="number">10</span>).<span class="title function_ invoke__">is_ok</span>());</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">Err</span>(CreationError::Negative),     PositiveNonzeroInteger::<span class="title function_ invoke__">new</span>(-<span class="number">10</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">Err</span>(CreationError::Zero),         PositiveNonzeroInteger::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="背景讲解：-1"><a href="#背景讲解：-1" class="headerlink" title="背景讲解："></a>背景讲解：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PositiveNonzeroInteger::new 总会创建一个新的实例（instance）并返回结果 Ok，它应当做一些检查，在检查失败时返回 Err，仅当检查确定一切正常时返回 Ok。</span><br><span class="line"></span><br><span class="line">所以我们在 new 函数中实现检查，小于 0 是报错负数，等于 0 时报错 0。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">impl PositiveNonzeroInteger &#123;</span><br><span class="line">    fn new(value: i64) -&gt; Result&lt;PositiveNonzeroInteger, CreationError&gt; &#123;</span><br><span class="line">        if value &lt; 0 &#123;</span><br><span class="line">            Err(CreationError::Negative)</span><br><span class="line"></span><br><span class="line">        &#125; else if value == 0 &#123;</span><br><span class="line">            Err(CreationError::Zero)</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            Ok(PositiveNonzeroInteger(value as u64))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">除了 if 外，参考 errors5</span><br><span class="line"></span><br><span class="line">也可以使用 match 的版本：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">impl PositiveNonzeroInteger &#123;</span><br><span class="line">    fn new(value: i64) -&gt; Result&lt;PositiveNonzeroInteger, CreationError&gt; &#123;</span><br><span class="line">        match value &#123;</span><br><span class="line">            x if x &lt; 0 =&gt; Err(CreationError::Negative),</span><br><span class="line">            x if x == 0 =&gt; Err(CreationError::Zero),</span><br><span class="line">            _ =&gt; Ok(PositiveNonzeroInteger(value as u64))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h4><ol>
<li><p><code>fn new(value: i64) -&gt; Result&lt;PositiveNonzeroInteger, CreationError&gt;</code> 为什么没有包含 Ok 的值？但 Ok 有返回呀。</p>
</li>
<li><p>struct PositiveNonzeroInteger(u64) 是一种什么结构？</p>
</li>
</ol>
<p>它是一种元组结构体，如：<br>struct Pair(i32, f32);</p>
<h2 id="054-error-handling-errors5-rs"><a href="#054-error-handling-errors5-rs" class="headerlink" title="054 error_handling&#x2F;errors5.rs"></a>054 error_handling&#x2F;errors5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This program uses an altered version of the code from errors4.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This exercise uses some concepts that we won&#x27;t get to until later in the course, like `Box` and the `From` trait. It&#x27;s not important to understand them in detail right now, but you can read ahead if you like. For now, think of the `Box&lt;dyn ???&gt;` type as an &quot;I want anything that does ???&quot; type, which, given Rust&#x27;s usual standards for runtime safety, should strike you as somewhat lenient!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In short, this particular use case for boxes is for when you want to own a value and you care only that it is a type which implements a particular trait. To do so, The Box is declared as of type Box&lt;dyn Trait&gt; where Trait is the trait the compiler looks for on any value used in that context. For this exercise, that context is the potential errors which can be returned in a Result.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// What can we use to describe both errors? In other words, is there a trait which both errors implement?</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">use</span> std::error;</span><br><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"><span class="keyword">use</span> std::num::ParseIntError;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> update the return type of `main()` to make this compile.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pretend_user_input</span> = <span class="string">&quot;42&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">i64</span> = pretend_user_input.<span class="title function_ invoke__">parse</span>()?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;output=&#123;:?&#125;&quot;</span>, PositiveNonzeroInteger::<span class="title function_ invoke__">new</span>(x)?);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Don&#x27;t change anything below this line.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PositiveNonzeroInteger</span>(<span class="type">u64</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">CreationError</span> &#123;</span><br><span class="line">    Negative,</span><br><span class="line">    Zero,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PositiveNonzeroInteger</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(value: <span class="type">i64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;PositiveNonzeroInteger, CreationError&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> value &#123;</span><br><span class="line">            x <span class="keyword">if</span> x &lt; <span class="number">0</span> =&gt; <span class="title function_ invoke__">Err</span>(CreationError::Negative),</span><br><span class="line">            x <span class="keyword">if</span> x == <span class="number">0</span> =&gt; <span class="title function_ invoke__">Err</span>(CreationError::Zero),</span><br><span class="line">            x =&gt; <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">PositiveNonzeroInteger</span>(x <span class="keyword">as</span> <span class="type">u64</span>)),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is required so that `CreationError` can implement `error::Error`.</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::Display <span class="keyword">for</span> <span class="title class_">CreationError</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">description</span> = <span class="keyword">match</span> *<span class="keyword">self</span> &#123;</span><br><span class="line">            CreationError::Negative =&gt; <span class="string">&quot;number is negative&quot;</span>,</span><br><span class="line">            CreationError::Zero =&gt; <span class="string">&quot;number is zero&quot;</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        f.<span class="title function_ invoke__">write_str</span>(description)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">error</span>::Error <span class="keyword">for</span> <span class="title class_">CreationError</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>本题与 error3.rs 背景类似，<br>因为 ? 要求 Result&lt;T, E&gt; 形式的返回值，而 main 函数的返回是 ()<br>本题只需个修改 <code>fn main() -&gt; Result&lt;(), Box&lt;dyn error::Error&gt;&gt;</code>。</p>
<h4 id="疑问-1"><a href="#疑问-1" class="headerlink" title="疑问"></a>疑问</h4><ul>
<li>Box<dyn error::Error>&gt;</li>
</ul>
<p>查 dyn 是个什么关键字？</p>
<h2 id="055-error-handling-errors6-rs"><a href="#055-error-handling-errors6-rs" class="headerlink" title="055 error_handling&#x2F;errors6.rs"></a>055 error_handling&#x2F;errors6.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// errors6.rs</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Using catch-all error types like `Box&lt;dyn error::Error&gt;` isn&#x27;t recommended for library code, where callers might want to make decisions based on the error content, instead of printing it out or propagating it further. Here, we define a custom error type to make it possible for callers to decide what to do next when our function returns an error.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint errors6` or use the `hint` watch subcommand for a</span></span><br><span class="line"><span class="comment">// hint.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::num::ParseIntError;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a custom error type that we will be using in `parse_pos_nonzero()`.</span></span><br><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">ParsePosNonzeroError</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Creation</span>(CreationError),</span><br><span class="line">    <span class="title function_ invoke__">ParseInt</span>(ParseIntError),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ParsePosNonzeroError</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_creation</span>(err: CreationError) <span class="punctuation">-&gt;</span> ParsePosNonzeroError &#123;</span><br><span class="line">        ParsePosNonzeroError::<span class="title function_ invoke__">Creation</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_parseint</span>(err: ParseIntError) <span class="punctuation">-&gt;</span> ParsePosNonzeroError &#123;</span><br><span class="line">        ParsePosNonzeroError::<span class="title function_ invoke__">ParseInt</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">parse_pos_nonzero</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;PositiveNonzeroInteger, ParsePosNonzeroError&gt; &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> change this to return an appropriate error instead of panicking</span></span><br><span class="line">    <span class="comment">// when `parse()` returns an error.</span></span><br><span class="line">    <span class="comment">//let x: i64 = s.parse().map_err(PositiveNonzeroInteger::from_parseint)?;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">i64</span> = s.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">map_err</span>(ParsePosNonzeroError::from_parseint)?;</span><br><span class="line">    PositiveNonzeroInteger::<span class="title function_ invoke__">new</span>(x).<span class="title function_ invoke__">map_err</span>(ParsePosNonzeroError::from_creation)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Don&#x27;t change anything below this line.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PositiveNonzeroInteger</span>(<span class="type">u64</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">CreationError</span> &#123;</span><br><span class="line">    Negative,</span><br><span class="line">    Zero,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PositiveNonzeroInteger</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(value: <span class="type">i64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;PositiveNonzeroInteger, CreationError&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> value &#123;</span><br><span class="line">            x <span class="keyword">if</span> x &lt; <span class="number">0</span> =&gt; <span class="title function_ invoke__">Err</span>(CreationError::Negative),</span><br><span class="line">            x <span class="keyword">if</span> x == <span class="number">0</span> =&gt; <span class="title function_ invoke__">Err</span>(CreationError::Zero),</span><br><span class="line">            x =&gt; <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">PositiveNonzeroInteger</span>(x <span class="keyword">as</span> <span class="type">u64</span>)),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> test &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_parse_error</span>() &#123;</span><br><span class="line">        <span class="comment">// We can&#x27;t construct a ParseIntError, so we have to pattern match.</span></span><br><span class="line">        <span class="built_in">assert!</span>(matches!(</span><br><span class="line">            <span class="title function_ invoke__">parse_pos_nonzero</span>(<span class="string">&quot;not a number&quot;</span>),</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(ParsePosNonzeroError::<span class="title function_ invoke__">ParseInt</span>(_))</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_negative</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="title function_ invoke__">parse_pos_nonzero</span>(<span class="string">&quot;-555&quot;</span>),</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(ParsePosNonzeroError::<span class="title function_ invoke__">Creation</span>(CreationError::Negative))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_zero</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="title function_ invoke__">parse_pos_nonzero</span>(<span class="string">&quot;0&quot;</span>),</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(ParsePosNonzeroError::<span class="title function_ invoke__">Creation</span>(CreationError::Zero))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_positive</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = PositiveNonzeroInteger::<span class="title function_ invoke__">new</span>(<span class="number">42</span>);</span><br><span class="line">        <span class="built_in">assert!</span>(x.<span class="title function_ invoke__">is_ok</span>());</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">parse_pos_nonzero</span>(<span class="string">&quot;42&quot;</span>), <span class="title function_ invoke__">Ok</span>(x.<span class="title function_ invoke__">unwrap</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://course.rs/advance/errors.html#map-%E5%92%8C-map_err">https://course.rs/advance/errors.html#map-%E5%92%8C-map_err</a></p>
<h4 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h4><p><code>let x: i64 = s.parse().map_err(ParsePosNonzeroError::from_parseint)?</code> 为什么是这么个顺序，虽然它表达的意思我们大致能够理解。</p>
<p>这行代码的意思是，如果 s.parse() 解析成功，则将解析后的整数值赋值给 x；如果解析失败，? 操作符会立即返回并将 ParseIntError 转换为 ParsePosNonzeroError::ParseInt 错误，并将其作为 parse_pos_nonzero 函数的返回结果。</p>
<p>在 Rust 中，? 操作符用于简化错误处理的过程。它只能在返回 Result 或 Option 的函数中使用。当使用 ? 操作符时，编译器会自动为你处理错误的传播。</p>
<p>具体到代码中，s.parse() 返回的是一个 Result&lt;i64, ParseIntError&gt;，该结果表示解析字符串为整数的过程。如果解析成功，返回 Ok 包含解析后的整数值；如果解析失败，则返回 Err 包含一个 ParseIntError 错误。</p>
<h4 id="待删"><a href="#待删" class="headerlink" title="待删"></a>待删</h4><p>main 的返回值是 Result&lt;(), ParseIntError&gt; ，而 PositiveNonzeroInteger::new(x) 的返回值是 Result&lt;PositiveNonzeroInteger, CreationError&gt;。我们怎么能让 main 的返回值包含它们呢？看看 hint：</p>
<p>main 中会产生两种错误类型（ParseIntError 和 CreationError），它们都通过 ? 传递。我们怎样在 main 中声明同时允许两种错误返回的情况呢？ 还是参考 Where The ? Operator Can Be Used，在底层实现中，? 对错误值调用 From::from 将其转换成一个装箱（boxed）的 trait 对象，也就是 Box<dyn error::Error>，它是多态的，意味着很多不同类型的错误可以从同一个函数返回。所有的错误行为都是一样的，因为它们都实现了 error::Error trait（特征）。</p>
<p>这样我们可以通过修改返回值简单地实现：</p>
<p>fn main() -&gt; Result&lt;(), Box<dyn error::Error>&gt;</p>
<h4 id="待消化，待删除的内容"><a href="#待消化，待删除的内容" class="headerlink" title="待消化，待删除的内容"></a>待消化，待删除的内容</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::num::ParseIntError;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a custom error type that we will be using in `parse_pos_nonzero()`.</span></span><br><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">ParsePosNonzeroError</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Creation</span>(CreationError),</span><br><span class="line">    <span class="title function_ invoke__">ParseInt</span>(ParseIntError),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ParsePosNonzeroError</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_creation</span>(err: CreationError) <span class="punctuation">-&gt;</span> ParsePosNonzeroError &#123;</span><br><span class="line">        ParsePosNonzeroError::<span class="title function_ invoke__">Creation</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> add another error conversion function here.</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_parseint</span>(err: ParseIntError)<span class="punctuation">-&gt;</span> ParsePosNonzeroError &#123;</span><br><span class="line">        ParsePosNonzeroError::<span class="title function_ invoke__">ParseInt</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">parse_pos_nonzero</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;PositiveNonzeroInteger, ParsePosNonzeroError&gt; &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> change this to return an appropriate error instead of panicking</span></span><br><span class="line">    <span class="comment">// when `parse()` returns an error.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">i64</span> = s.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">map_err</span>(ParsePosNonzeroError::from_parseint)?;</span><br><span class="line">    PositiveNonzeroInteger::<span class="title function_ invoke__">new</span>(x).<span class="title function_ invoke__">map_err</span>(ParsePosNonzeroError::from_creation)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原本是parse().unwrap()，这将会导致如果s不能解析为整数i64，就会直接panic掉，而使用map_err对Err()进行一些修改，捕获原本的ParseInt类型错误，而将它转化成ParsePosNonzeroError::ParseInt，这就符合下面的测试逻辑了。</p>
<p>再解释一下 let x: i64 &#x3D; s.parse().map_err(ParsePosNonzeroError::from_parseint)?; 为什么是这么个顺序，虽然它表达的意思我们大致能够理解。</p>
<p>这行代码的意思是，如果 s.parse() 解析成功，则将解析后的整数值赋值给 x；如果解析失败，? 操作符会立即返回并将 ParseIntError 转换为 ParsePosNonzeroError::ParseInt 错误，并将其作为 parse_pos_nonzero 函数的返回结果。</p>
<p>在 Rust 中，? 操作符用于简化错误处理的过程。它只能在返回 Result 或 Option 的函数中使用。当使用 ? 操作符时，编译器会自动为你处理错误的传播。</p>
<p>具体到代码中，s.parse() 返回的是一个 Result&lt;i64, ParseIntError&gt;，该结果表示解析字符串为整数的过程。如果解析成功，返回 Ok 包含解析后的整数值；如果解析失败，则返回 Err 包含一个 ParseIntError 错误。</p>
<h2 id="056-generics-generics1-rs"><a href="#056-generics-generics1-rs" class="headerlink" title="056 generics&#x2F;generics1.rs"></a>056 generics&#x2F;generics1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">shopping_list</span>: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    shopping_list.<span class="title function_ invoke__">push</span>(<span class="string">&quot;milk&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是 Vec 的类型为 String，那么下面的字符串就需要 .to_string()，还可以设置 Vec 的类型为 &amp;str，就不需要修改下面的 push 了。</p>
<h2 id="057-generics-generics2-rs"><a href="#057-generics-generics2-rs" class="headerlink" title="057 generics&#x2F;generics2.rs"></a>057 generics&#x2F;generics2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This powerful wrapper provides the ability to store a positive integer value.</span></span><br><span class="line"><span class="comment">// Rewrite it using generics so that it supports wrapping ANY type.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Wrapper</span>&lt;T&gt; &#123;</span><br><span class="line">    value: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Wrapper&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(value: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Wrapper &#123; value &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">store_u32_in_wrapper</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(Wrapper::<span class="title function_ invoke__">new</span>(<span class="number">42</span>).value, <span class="number">42</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">store_str_in_wrapper</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(Wrapper::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Foo&quot;</span>).value, <span class="string">&quot;Foo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="058-traits-traits1-rs"><a href="#058-traits-traits1-rs" class="headerlink" title="058 traits&#x2F;traits1.rs"></a>058 traits&#x2F;traits1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Time to implement some traits! Your task is to implement the trait</span></span><br><span class="line"><span class="comment">// `AppendBar` for the type `String`. The trait AppendBar has only one function,</span></span><br><span class="line"><span class="comment">// which appends &quot;Bar&quot; to any object implementing this trait.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint traits1` or use the `hint` watch subcommand for a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">AppendBar</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">append_bar</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">AppendBar</span> <span class="keyword">for</span> <span class="title class_">String</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Implement `AppendBar` for type `String`.</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">append_bar</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>&#123;</span><br><span class="line">        <span class="keyword">self</span> + <span class="string">&quot;Bar&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Foo&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = s.<span class="title function_ invoke__">append_bar</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;s: &#123;&#125;&quot;</span>, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_foo_bar</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Foo&quot;</span>).<span class="title function_ invoke__">append_bar</span>(), <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;FooBar&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_bar_bar</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;&quot;</span>).<span class="title function_ invoke__">append_bar</span>().<span class="title function_ invoke__">append_bar</span>(),</span><br><span class="line">            <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;BarBar&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="59-traits-traits2-rs"><a href="#59-traits-traits2-rs" class="headerlink" title="59 traits&#x2F;traits2.rs"></a>59 traits&#x2F;traits2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Your task is to implement the trait `AppendBar` for a vector of strings.</span></span><br><span class="line"><span class="comment">// To implement this trait, consider for a moment what it means to &#x27;append Bar&#x27; to a vector of strings.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// No boiler plate code this time, you can do this!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint traits2` or use the `hint` watch subcommand for a hint.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">AppendBar</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">append_bar</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">AppendBar</span> <span class="keyword">for</span> <span class="title class_">Vec</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">append_bar</span>(<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">String</span>&gt;&#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">push</span>(<span class="string">&quot;Bar&quot;</span>.<span class="title function_ invoke__">to_owned</span>());</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Implement trait `AppendBar` for a vector of strings.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_vec_pop_eq_bar</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">foo</span> = <span class="built_in">vec!</span>[<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Foo&quot;</span>)].<span class="title function_ invoke__">append_bar</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(foo.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>(), <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Bar&quot;</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(foo.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>(), <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Foo&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面两题都很基础，没什么可说的。</p>
<h2 id="60-traits-traits3-rs"><a href="#60-traits-traits3-rs" class="headerlink" title="60 traits&#x2F;traits3.rs"></a>60 traits&#x2F;traits3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Your task is to implement the Licensed trait for both structures and have them return the same information</span></span><br><span class="line"><span class="comment">// without writing the same function twice.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Consider what you can add to the Licensed trait.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint traits3` or use the `hint` watch subcommand for a hint.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Licensed</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">licensing_info</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Some information&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SomeSoftware</span> &#123;</span><br><span class="line">    version_number: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">OtherSoftware</span> &#123;</span><br><span class="line">    version_number: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Licensed</span> <span class="keyword">for</span> <span class="title class_">SomeSoftware</span> &#123;&#125; <span class="comment">// Don&#x27;t edit this line</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Licensed</span> <span class="keyword">for</span> <span class="title class_">OtherSoftware</span> &#123;&#125; <span class="comment">// Don&#x27;t edit this line</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_licensing_info_the_same</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">licensing_info</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Some information&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">some_software</span> = SomeSoftware   &#123; version_number: <span class="number">1</span> &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">other_software</span> = OtherSoftware &#123; version_number: <span class="string">&quot;v2.0.0&quot;</span>.<span class="title function_ invoke__">to_string</span>(), &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取出 licensing_info 返回值，和字符串比较。</span></span><br><span class="line">        <span class="built_in">assert_eq!</span>(some_software.<span class="title function_ invoke__">licensing_info</span>(), licensing_info);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(other_software.<span class="title function_ invoke__">licensing_info</span>(), licensing_info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口实现了一个基本的函数。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">licensing_info</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Some information&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="61-traits-traits4-rs"><a href="#61-traits-traits4-rs" class="headerlink" title="61 traits&#x2F;traits4.rs"></a>61 traits&#x2F;traits4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Your task is to replace the &#x27;??&#x27; sections so the code compiles.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Don&#x27;t change any line other than the marked one.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint traits4` or use the `hint` watch subcommand for a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Licensed</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">licensing_info</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="string">&quot;some information&quot;</span>.<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SomeSoftware</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">OtherSoftware</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Licensed</span> <span class="keyword">for</span> <span class="title class_">SomeSoftware</span> &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Licensed</span> <span class="keyword">for</span> <span class="title class_">OtherSoftware</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// YOU MAY ONLY CHANGE THE NEXT LINE</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">compare_license_types</span>(software: <span class="keyword">impl</span> <span class="title class_">Licensed</span> , software_two: <span class="keyword">impl</span> <span class="title class_">Licensed</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    software.<span class="title function_ invoke__">licensing_info</span>() == software_two.<span class="title function_ invoke__">licensing_info</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">compare_license_information</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">some_software</span> = SomeSoftware &#123;&#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">other_software</span> = OtherSoftware &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert!</span>(<span class="title function_ invoke__">compare_license_types</span>(some_software, other_software));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">compare_license_information_backwards</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">some_software</span> = SomeSoftware &#123;&#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">other_software</span> = OtherSoftware &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert!</span>(<span class="title function_ invoke__">compare_license_types</span>(other_software, some_software));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改了 <code>fn compare_license_types(software: impl Licensed , software_two: impl Licensed) -&gt; bool</code></p>
<p>不用写具体的类名，只需 <code>impl Licensed</code>，这样表示它实现了一个抽象类。</p>
<h2 id="62-traits-traits5-rs"><a href="#62-traits-traits5-rs" class="headerlink" title="62 traits&#x2F;traits5.rs"></a>62 traits&#x2F;traits5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Your task is to replace the &#x27;??&#x27; sections so the code compiles.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">SomeTrait</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">some_function</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">OtherTrait</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">other_function</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SomeStruct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">OtherStruct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">SomeTrait</span> <span class="keyword">for</span> <span class="title class_">SomeStruct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">OtherTrait</span> <span class="keyword">for</span> <span class="title class_">SomeStruct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">SomeTrait</span> <span class="keyword">for</span> <span class="title class_">OtherStruct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">OtherTrait</span> <span class="keyword">for</span> <span class="title class_">OtherStruct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// YOU MAY ONLY CHANGE THE NEXT LINE</span></span><br><span class="line"><span class="comment">// fn some_func(item: ??) -&gt; bool &#123;</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">some_func</span>(item: <span class="keyword">impl</span> <span class="title class_">SomeTrait</span> + OtherTrait) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    item.<span class="title function_ invoke__">some_function</span>() &amp;&amp; item.<span class="title function_ invoke__">other_function</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">some_func</span>(SomeStruct &#123;&#125;);</span><br><span class="line">    <span class="title function_ invoke__">some_func</span>(OtherStruct &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>item: impl SomeTrait + OtherTrait</code> 表示 item 实现了两个抽象类。</p>
<h2 id="63-quiz3-rs"><a href="#63-quiz3-rs" class="headerlink" title="63 quiz3.rs"></a>63 quiz3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一所虚构的魔法学校有一个新的用 Rust 编写的成绩单生成系统！</span></span><br><span class="line"><span class="comment">// 目前，该系统仅支持创建以数字表示学生成绩的成绩单（例如 1.0 -&gt; 5.5）。但是，学校还颁发按字母顺序排列的成绩（A+ -&gt; F-），并且需要能够打印这两种类型的成绩单！</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 在 struct ReportCard 和 impl 块中进行必要的代码更改以支持按字母顺序排列的成绩单。将第二个测试中的成绩更改为“A+”，以表明您的更改允许按字母顺序排列的成绩。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ReportCard</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> grade: T,</span><br><span class="line">    <span class="keyword">pub</span> student_name: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> student_age: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T: std::fmt::Display&gt; ReportCard&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">print</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125; (&#123;&#125;) ## achieved a grade of &#123;&#125;&quot;</span>,</span><br><span class="line">            &amp;<span class="keyword">self</span>.student_name, &amp;<span class="keyword">self</span>.student_age, &amp;<span class="keyword">self</span>.grade)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">generate_numeric_report_card</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">report_card</span> = ReportCard &#123;</span><br><span class="line">            grade: <span class="number">2.1</span>,</span><br><span class="line">            student_name: <span class="string">&quot;Tom Wriggle&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            student_age: <span class="number">12</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            report_card.<span class="title function_ invoke__">print</span>(),</span><br><span class="line">            <span class="string">&quot;Tom Wriggle (12) ## achieved a grade of 2.1&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">generate_alphabetic_report_card</span>() &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Make sure to change the grade here after you finish the exercise.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">report_card</span> = ReportCard &#123;</span><br><span class="line">            grade: <span class="string">&quot;A+&quot;</span>,</span><br><span class="line">            student_name: <span class="string">&quot;Gary Plotter&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            student_age: <span class="number">11</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            report_card.<span class="title function_ invoke__">print</span>(),</span><br><span class="line">            <span class="string">&quot;Gary Plotter (11) ## achieved a grade of A+&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要添加了一行 <code>impl&lt;T: std::fmt::Display&gt; ReportCard&lt;T&gt;</code></p>
<p>通过在 impl 声明中指定 T: std::fmt::Display，表明泛型类型 T 必须实现 std::fmt::Display trait。</p>
<h4 id="疑问："><a href="#疑问：" class="headerlink" title="疑问："></a>疑问：</h4><p><code>泛型类型 T 必须实现 std::fmt::Display trait </code>这里还没太懂。</p>
<h2 id="064-lifetimes-lifetimes1-rs"><a href="#064-lifetimes-lifetimes1-rs" class="headerlink" title="064 lifetimes&#x2F;lifetimes1.rs"></a>064 lifetimes&#x2F;lifetimes1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">string1</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;abcd&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">string2</span> = <span class="string">&quot;xyz&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">longest</span>(string1.<span class="title function_ invoke__">as_str</span>(), string2);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The longest string is &#x27;&#123;&#125;&#x27;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生命周期，简而言之就是引用的有效作用域，生命周期主要是解决悬垂引用问题。</p>
<p>生命周期语法用来将函数的多个引用参数和返回值的作用域关联到一起，一旦关联到一起后，Rust 就拥有充分的信息来确保我们的操作是内存安全的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    let r;                // ---------+-- &#x27;a</span><br><span class="line">                          //          |</span><br><span class="line">    &#123;                     //          |</span><br><span class="line">        let x = 5;        // -+-- &#x27;b  |</span><br><span class="line">        r = &amp;x;           //  |       |</span><br><span class="line">    &#125;                     // -+       |</span><br><span class="line">                          //          |</span><br><span class="line">    println!(&quot;r: &#123;&#125;&quot;, r); //          |</span><br><span class="line">&#125;                         // ---------+</span><br></pre></td></tr></table></figure>

<p>在编译期会比较两个变量的生命周期，结果发现 r 生命周期 ‘a，引用了小得多的生命周期 ‘b，编译器认为存在风险，因此拒绝运行。</p>
<p>要想编译通过，引用，即箭头右边指向的那个东西，要活得久一点。</p>
<p>回到本题，该函数的返回值是一个引用类型，但是函数签名无法说明，该引用是借用自 <code>x</code> 还是 <code>y</code>，它不知道 x 和 y 的生命周期跟返回值的之间的关系是怎样的？</p>
<p><code>longest&lt;&#39;a&gt;(x: &amp;&#39;a str, y: &amp;&#39;a str) -&gt; &amp;&#39;a str</code> 表示 x、y 和返回值存活一样久。</p>
<h2 id="065-lifetimes-lifetimes2-rs"><a href="#065-lifetimes-lifetimes2-rs" class="headerlink" title="065 lifetimes&#x2F;lifetimes2.rs"></a>065 lifetimes&#x2F;lifetimes2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">string1</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;long string is long&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">string2</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;xyz&quot;</span>);</span><br><span class="line">        result = <span class="title function_ invoke__">longest</span>(string1.<span class="title function_ invoke__">as_str</span>(), string2.<span class="title function_ invoke__">as_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The longest string is &#x27;&#123;&#125;&#x27;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是原题。</p>
<p>此处的逻辑有点违反直觉，原以为 result 都已经从函数里返回出来了，它不应该受 string1 &#x2F; string2 的影响，上面代码理应正常通过。</p>
<p>但真实逻辑是：’a 等于两者中生命周期较小的那个，也就是 ‘a 等于 string2 的生命周期，同理，result 也是 ‘a，可以得出 result 等于 string2 的生命周期。</p>
<h2 id="066-lifetimes-lifetimes3-rs"><a href="#066-lifetimes-lifetimes3-rs" class="headerlink" title="066 lifetimes&#x2F;lifetimes3.rs"></a>066 lifetimes&#x2F;lifetimes3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lifetimes are also needed when structs hold references.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint lifetimes3` or use the `hint` watch subcommand for a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Book</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    author: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">    title: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Jill Smith&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">title</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Fish Flying&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">book</span> = Book &#123; author: &amp;name, title: &amp;title &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; by &#123;&#125;&quot;</span>, book.title, book.author);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="067-tests-tests1-rs"><a href="#067-tests-tests1-rs" class="headerlink" title="067 tests&#x2F;tests1.rs"></a>067 tests&#x2F;tests1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tests are important to ensure that your code does what you think it should</span></span><br><span class="line"><span class="comment">// do. Tests can be run on this file with the following command: rustlings run</span></span><br><span class="line"><span class="comment">// tests1</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This test has a problem with it -## make the test compile! Make the test pass!</span></span><br><span class="line"><span class="comment">// Make the test fail!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint tests1` or use the `hint` watch subcommand for a</span></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">you_can_assert</span>() &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>介绍 test 模块是怎么回事。</p>
<h2 id="068-tests-tests2-rs"><a href="#068-tests-tests2-rs" class="headerlink" title="068 tests&#x2F;tests2.rs"></a>068 tests&#x2F;tests2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This test has a problem with it -## make the test compile! Make the test pass!</span></span><br><span class="line"><span class="comment">// Make the test fail!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint tests2` or use the `hint` watch subcommand for a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">you_can_assert_eq</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="069-tests-tests3-rs"><a href="#069-tests-tests3-rs" class="headerlink" title="069 tests&#x2F;tests3.rs"></a>069 tests&#x2F;tests3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This test isn&#x27;t testing our function -## make it do that in such a way that</span></span><br><span class="line"><span class="comment">// the test passes. Then write a second test that tests whether we get the</span></span><br><span class="line"><span class="comment">// result we expect to get when we call `is_even(5)`.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint tests3` or use the `hint` watch subcommand for a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_even</span>(num: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    num % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_true_when_even</span>() &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(<span class="title function_ invoke__">is_even</span>(<span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_false_when_odd</span>() &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(!<span class="title function_ invoke__">is_even</span>(<span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="070-tests-tests4-rs"><a href="#070-tests-tests4-rs" class="headerlink" title="070 tests&#x2F;tests4.rs"></a>070 tests&#x2F;tests4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Make sure that we&#x27;re testing for the correct conditions!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint tests4` or use the `hint` watch subcommand for a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    width: <span class="type">i32</span>,</span><br><span class="line">    height: <span class="type">i32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="comment">// Only change the test functions themselves</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(width: <span class="type">i32</span>, height: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> width &lt;= <span class="number">0</span> || height &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">&quot;Rectangle width and height cannot be negative!&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        Rectangle &#123;width, height&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">correct_width_and_height</span>() &#123;</span><br><span class="line">        <span class="comment">// This test should check if the rectangle is the size that we pass into its constructor</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">rect</span> = Rectangle::<span class="title function_ invoke__">new</span>(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(rect.width, <span class="number">10</span>); <span class="comment">// check width</span></span><br><span class="line">        <span class="built_in">assert_eq!</span>(rect.height, <span class="number">20</span>); <span class="comment">// check height</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[should_panic]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">negative_width</span>() &#123;</span><br><span class="line">        <span class="comment">// This test should check if program panics when we try to create rectangle with negative width</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_rect</span> = Rectangle::<span class="title function_ invoke__">new</span>(-<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[should_panic]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">negative_height</span>() &#123;</span><br><span class="line">        <span class="comment">// This test should check if program panics when we try to create rectangle with negative height</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_rect</span> = Rectangle::<span class="title function_ invoke__">new</span>(<span class="number">10</span>, -<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="疑问：-1"><a href="#疑问：-1" class="headerlink" title="疑问："></a>疑问：</h4><p>主要涉及到 <code>#[should_panic]</code> 特性。</p>
<h2 id="71-iterators-iterators1-rs"><a href="#71-iterators-iterators1-rs" class="headerlink" title="71 iterators&#x2F;iterators1.rs"></a>71 iterators&#x2F;iterators1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// When performing operations on elements within a collection, iterators are</span></span><br><span class="line"><span class="comment">// essential. This module helps you get familiar with the structure of using an iterator and how to go through elements within an iterable collection.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Make me compile by filling in the `???`s</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint iterators1` or use the `hint` watch subcommand for a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">my_fav_fruits</span> = <span class="built_in">vec!</span>[<span class="string">&quot;banana&quot;</span>, <span class="string">&quot;custard apple&quot;</span>, <span class="string">&quot;avocado&quot;</span>, <span class="string">&quot;peach&quot;</span>, <span class="string">&quot;raspberry&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">my_iterable_fav_fruits</span> = my_fav_fruits.<span class="title function_ invoke__">iter</span>();;   <span class="comment">// <span class="doctag">TODO:</span> Step 1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(my_iterable_fav_fruits.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(&amp;<span class="string">&quot;banana&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(my_iterable_fav_fruits.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(&amp;<span class="string">&quot;custard apple&quot;</span>));     <span class="comment">// <span class="doctag">TODO:</span> Step 2</span></span><br><span class="line">    <span class="built_in">assert_eq!</span>(my_iterable_fav_fruits.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(&amp;<span class="string">&quot;avocado&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(my_iterable_fav_fruits.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(&amp;<span class="string">&quot;peach&quot;</span>));     <span class="comment">// <span class="doctag">TODO:</span> Step 3</span></span><br><span class="line">    <span class="built_in">assert_eq!</span>(my_iterable_fav_fruits.<span class="title function_ invoke__">next</span>(), <span class="title function_ invoke__">Some</span>(&amp;<span class="string">&quot;raspberry&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(my_iterable_fav_fruits.<span class="title function_ invoke__">next</span>(), <span class="literal">None</span>);     <span class="comment">// <span class="doctag">TODO:</span> Step 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>into_iter()会夺走所有权，iter()是借用。如果使用前者，assert_eq!中比较对象应该是Some(“banana”)。</p>
<h2 id="72-iterators-iterators2-rs"><a href="#72-iterators-iterators2-rs" class="headerlink" title="72 iterators&#x2F;iterators2.rs"></a>72 iterators&#x2F;iterators2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 1.</span></span><br><span class="line"><span class="comment">// Complete the `capitalize_first` function.</span></span><br><span class="line"><span class="comment">// &quot;hello&quot; -&gt; &quot;Hello&quot;</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">capitalize_first</span>(input: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">c</span> = input.<span class="title function_ invoke__">chars</span>();</span><br><span class="line">    <span class="keyword">match</span> c.<span class="title function_ invoke__">next</span>() &#123;</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="type">String</span>::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(first) =&gt; first.<span class="title function_ invoke__">to_uppercase</span>().<span class="title function_ invoke__">to_string</span>() + c.<span class="title function_ invoke__">as_str</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 2.</span></span><br><span class="line"><span class="comment">// Apply the `capitalize_first` function to a slice of string slices.</span></span><br><span class="line"><span class="comment">// Return a vector of strings.</span></span><br><span class="line"><span class="comment">// [&quot;hello&quot;, &quot;world&quot;] -&gt; [&quot;Hello&quot;, &quot;World&quot;]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">capitalize_words_vector</span>(words: &amp;[&amp;<span class="type">str</span>]) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    words.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|words| <span class="title function_ invoke__">capitalize_first</span>(words)).<span class="title function_ invoke__">collect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 3.</span></span><br><span class="line"><span class="comment">// Apply the `capitalize_first` function again to a slice of string slices.</span></span><br><span class="line"><span class="comment">// Return a single string.</span></span><br><span class="line"><span class="comment">// [&quot;hello&quot;, &quot; &quot;, &quot;world&quot;] -&gt; &quot;Hello World&quot;</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">capitalize_words_string</span>(words: &amp;[&amp;<span class="type">str</span>]) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    words.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|words| <span class="title function_ invoke__">capitalize_first</span>(words)).<span class="title function_ invoke__">collect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_success</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">capitalize_first</span>(<span class="string">&quot;hello&quot;</span>), <span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_empty</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">capitalize_first</span>(<span class="string">&quot;&quot;</span>), <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_iterate_string_vec</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">words</span> = <span class="built_in">vec!</span>[<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>];</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">capitalize_words_vector</span>(&amp;words), [<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_iterate_into_string</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">words</span> = <span class="built_in">vec!</span>[<span class="string">&quot;hello&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;world&quot;</span>];</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">capitalize_words_string</span>(&amp;words), <span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="73-iterators-iterators3-rs"><a href="#73-iterators-iterators3-rs" class="headerlink" title="73 iterators&#x2F;iterators3.rs"></a>73 iterators&#x2F;iterators3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, PartialEq, Eq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">DivisionError</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">NotDivisible</span>(NotDivisibleError),</span><br><span class="line">    DivideByZero,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq, Eq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">NotDivisibleError</span> &#123;</span><br><span class="line">    dividend: <span class="type">i32</span>,</span><br><span class="line">    divisor: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Calculate `a` divided by `b` if `a` is evenly divisible by `b`.</span></span><br><span class="line"><span class="comment">// Otherwise, return a suitable error.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, DivisionError&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(DivisionError::DivideByZero);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> a % b !=<span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(DivisionError::<span class="title function_ invoke__">NotDivisible</span>(</span><br><span class="line">            NotDivisibleError</span><br><span class="line">            &#123;</span><br><span class="line">                dividend:a,</span><br><span class="line">                divisor:b,&#125;</span><br><span class="line">            ));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(a/b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Complete the function and return a value of the correct type so the test</span></span><br><span class="line"><span class="comment">// passes.</span></span><br><span class="line"><span class="comment">// Desired output: Ok([1, 11, 1426, 3])</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">result_with_list</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;, DivisionError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">27</span>, <span class="number">297</span>, <span class="number">38502</span>, <span class="number">81</span>];</span><br><span class="line">    numbers.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">map</span>(|n| <span class="title function_ invoke__">divide</span>(n, <span class="number">27</span>)).<span class="title function_ invoke__">collect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Complete the function and return a value of the correct type so the test</span></span><br><span class="line"><span class="comment">// passes.</span></span><br><span class="line"><span class="comment">// Desired output: [Ok(1), Ok(11), Ok(1426), Ok(3)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">list_of_results</span>() <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">Result</span>&lt;<span class="type">i32</span>, DivisionError&gt;&gt;   &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">27</span>, <span class="number">297</span>, <span class="number">38502</span>, <span class="number">81</span>];</span><br><span class="line">    numbers.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">map</span>(|n| <span class="title function_ invoke__">divide</span>(n, <span class="number">27</span>)).<span class="title function_ invoke__">collect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_success</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">divide</span>(<span class="number">81</span>, <span class="number">9</span>), <span class="title function_ invoke__">Ok</span>(<span class="number">9</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_not_divisible</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="title function_ invoke__">divide</span>(<span class="number">81</span>, <span class="number">6</span>),</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(DivisionError::<span class="title function_ invoke__">NotDivisible</span>(NotDivisibleError &#123;</span><br><span class="line">                dividend: <span class="number">81</span>,</span><br><span class="line">                divisor: <span class="number">6</span></span><br><span class="line">            &#125;))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_divide_by_0</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">divide</span>(<span class="number">81</span>, <span class="number">0</span>), <span class="title function_ invoke__">Err</span>(DivisionError::DivideByZero));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_divide_0_by_something</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">divide</span>(<span class="number">0</span>, <span class="number">81</span>), <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_result_with_list</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="built_in">format!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="title function_ invoke__">result_with_list</span>()), <span class="string">&quot;Ok([1, 11, 1426, 3])&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_list_of_results</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            <span class="built_in">format!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="title function_ invoke__">list_of_results</span>()),</span><br><span class="line">            <span class="string">&quot;[Ok(1), Ok(11), Ok(1426), Ok(3)]&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="疑问-2"><a href="#疑问-2" class="headerlink" title="疑问"></a>疑问</h4><blockquote>
<p>下面两条代码，还没有明白。</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Complete the function and return a value of the correct type so the test</span></span><br><span class="line"><span class="comment">// passes.</span></span><br><span class="line"><span class="comment">// Desired output: Ok([1, 11, 1426, 3])</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">result_with_list</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;, DivisionError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">27</span>, <span class="number">297</span>, <span class="number">38502</span>, <span class="number">81</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">division_results</span> = numbers.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">map</span>(|n| <span class="title function_ invoke__">divide</span>(n, <span class="number">27</span>)).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    division_results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Complete the function and return a value of the correct type so the test</span></span><br><span class="line"><span class="comment">// passes.</span></span><br><span class="line"><span class="comment">// Desired output: [Ok(1), Ok(11), Ok(1426), Ok(3)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">list_of_results</span>() <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">Result</span>&lt;<span class="type">i32</span>, DivisionError&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">27</span>, <span class="number">297</span>, <span class="number">38502</span>, <span class="number">81</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">division_results</span> = numbers.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">map</span>(|n| <span class="title function_ invoke__">divide</span>(n, <span class="number">27</span>)).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    division_results</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>map：转换数据。接受一个闭包并为迭代器中的每个元素调用该闭包，然后返回一个新的迭代器，其中包含闭包返回的值。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let v = vec![1, 2, 3];</span><br><span class="line">let v_squared: Vec&lt;i32&gt; = v.iter().map(|x| x * x).collect();</span><br></pre></td></tr></table></figure>

<ul>
<li>filter：过滤数据。接受一个闭包并为迭代器中的每个元素调用该闭包。如果闭包返回true，则元素将包含在新的迭代器中。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let v = vec![1, 2, 3];</span><br><span class="line">let v_even: Vec&lt;&amp;i32&gt; = v.iter().filter(|x| *x % 2 == 0).collect();</span><br></pre></td></tr></table></figure>
<ul>
<li>fold：聚合数据。接受一个初始值和一个闭包，并将闭包应用于初始值和迭代器中的每个元素，以生成一个单一的最终值。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let v = vec![1, 2, 3];</span><br><span class="line">let sum: i32 = v.iter().fold(0, |acc, x| acc + x);</span><br></pre></td></tr></table></figure>

<ul>
<li>chain：该方法是Iterator trait的一个方法，它允许你将两个迭代器链接在一起，形成一个新的迭代器。这个新的迭代器会先遍历第一个迭代器中的所有元素，然后再遍历第二个迭代器中的所有元素。</li>
</ul>
<p>例如，你可以使用chain方法将两个数组中的元素链接在一起：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let a = [1, 2, 3];</span><br><span class="line">let b = [4, 5];</span><br><span class="line">let c: Vec&lt;i32&gt; = a.iter().chain(b.iter()).copied().collect();</span><br><span class="line">assert_eq!(c, [1, 2, 3, 4, 5]);</span><br></pre></td></tr></table></figure>
<p>在这个例子中，我们创建了两个数组a和b，然后使用chain方法将它们链接在一起，形成一个新的迭代器。最后，我们使用collect方法将迭代器中的元素收集到一个向量中。</p>
<h2 id="74-iterators-iterators4-rs"><a href="#74-iterators-iterators4-rs" class="headerlink" title="74 iterators&#x2F;iterators4.rs"></a>74 iterators&#x2F;iterators4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">factorial</span>(num: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    (<span class="number">1</span>..num+<span class="number">1</span>).<span class="title function_ invoke__">product</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="75-iterators-iterators5-rs"><a href="#75-iterators-iterators5-rs" class="headerlink" title="75 iterators&#x2F;iterators5.rs"></a>75 iterators&#x2F;iterators5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone, Copy, PartialEq, Eq)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Progress</span> &#123;</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">Some</span>,</span><br><span class="line">    Complete,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">count_for</span>(map: &amp;HashMap&lt;<span class="type">String</span>, Progress&gt;, value: Progress) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> map.<span class="title function_ invoke__">values</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> val == &amp;value &#123;</span><br><span class="line">            count += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">count_iterator</span>(map: &amp;HashMap&lt;<span class="type">String</span>, Progress&gt;, value: Progress) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="comment">// map is a hashmap with String keys and Progress values.</span></span><br><span class="line">    <span class="comment">// map = &#123; &quot;variables1&quot;: Complete, &quot;from_str&quot;: None, ... &#125;</span></span><br><span class="line">    map.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">filter</span>(|v| *v.<span class="number">1</span> == value).<span class="title function_ invoke__">count</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">count_collection_for</span>(collection: &amp;[HashMap&lt;<span class="type">String</span>, Progress&gt;], value: Progress) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">map</span> <span class="keyword">in</span> collection &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> map.<span class="title function_ invoke__">values</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> val == &amp;value &#123;</span><br><span class="line">                count += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">count_collection_iterator</span>(collection: &amp;[HashMap&lt;<span class="type">String</span>, Progress&gt;], value: Progress) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="comment">// collection is a slice of hashmaps.</span></span><br><span class="line">    <span class="comment">// collection = [&#123; &quot;variables1&quot;: Complete, &quot;from_str&quot;: None, ... &#125;,</span></span><br><span class="line">    <span class="comment">//     &#123; &quot;variables2&quot;: Complete, ... &#125;, ... ]</span></span><br><span class="line">    collection</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|vals| vals.<span class="title function_ invoke__">values</span>().<span class="title function_ invoke__">filter</span>(|val| *val == &amp;value).<span class="title function_ invoke__">count</span>())</span><br><span class="line">        .<span class="title function_ invoke__">sum</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>迭代器就好像是现实世界的水管，现实世界中，水管是标准化的接口，打开水管就可以出水。厨房用水可能需要加热，洗澡间用水可能需要冷热混合，淋浴花洒可能需要将水分割成若干个小水流。干这些事情的，我们称之为适配器。</p>
<p>filter_map 适配器是个非常有用的适配器，它有点像 filter 和 map 的结合体。我们有时候遍历 Result 类型的迭代器的时候，有时候，可能会有失败的情况，我们就用 filter_map 来忽略失败的项。</p>
<h4 id="疑问-3"><a href="#疑问-3" class="headerlink" title="疑问"></a>疑问</h4><p>再了解迭代器。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">collection</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|vals| vals.<span class="title function_ invoke__">values</span>().<span class="title function_ invoke__">filter</span>(|val| *val == &amp;value).<span class="title function_ invoke__">count</span>())</span><br><span class="line">    .<span class="title function_ invoke__">sum</span>()</span><br></pre></td></tr></table></figure>

<h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://kaisery.github.io/trpl-zh-cn/ch15-04-rc.html">https://kaisery.github.io/trpl-zh-cn/ch15-04-rc.html</a></p>
<h2 id="76-smart-pointers-box1-rs"><a href="#76-smart-pointers-box1-rs" class="headerlink" title="76 smart_pointers&#x2F;box1.rs"></a>76 smart_pointers&#x2F;box1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(PartialEq, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, <span class="type">Box</span>&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;This is an empty cons list: &#123;:?&#125;&quot;</span>, <span class="title function_ invoke__">create_empty_list</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;This is a non-empty cons list: &#123;:?&#125;&quot;</span>, <span class="title function_ invoke__">create_non_empty_list</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_empty_list</span>() <span class="punctuation">-&gt;</span> List &#123;</span><br><span class="line">    List::Nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_non_empty_list</span>() <span class="punctuation">-&gt;</span> List &#123;</span><br><span class="line">    List::<span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(List::Nil))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="77-smart-pointers-rc1-rs"><a href="#77-smart-pointers-rc1-rs" class="headerlink" title="77 smart_pointers&#x2F;rc1.rs"></a>77 smart_pointers&#x2F;rc1.rs</h2><p>调用Rc::clone()增加引用计数，drop()删除引用计数。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Sun</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Planet</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Mercury</span>(Rc&lt;Sun&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Venus</span>(Rc&lt;Sun&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Earth</span>(Rc&lt;Sun&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Mars</span>(Rc&lt;Sun&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Jupiter</span>(Rc&lt;Sun&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Saturn</span>(Rc&lt;Sun&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Uranus</span>(Rc&lt;Sun&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Neptune</span>(Rc&lt;Sun&gt;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Planet</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">details</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hi from &#123;:?&#125;!&quot;</span>, <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sun</span> = Rc::<span class="title function_ invoke__">new</span>(Sun &#123;&#125;);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;1. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 1 reference</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mercury</span> = Planet::<span class="title function_ invoke__">Mercury</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;2. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 2 references</span></span><br><span class="line">    mercury.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">venus</span> = Planet::<span class="title function_ invoke__">Venus</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;3. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 3 references</span></span><br><span class="line">    venus.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">earth</span> = Planet::<span class="title function_ invoke__">Earth</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;4. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 4 references</span></span><br><span class="line">    earth.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mars</span> = Planet::<span class="title function_ invoke__">Mars</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;5. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 5 references</span></span><br><span class="line">    mars.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">jupiter</span> = Planet::<span class="title function_ invoke__">Jupiter</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;6. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 6 references</span></span><br><span class="line">    jupiter.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">saturn</span> = Planet::<span class="title function_ invoke__">Saturn</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;7. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 7 references</span></span><br><span class="line">    saturn.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">uranus</span> = Planet::<span class="title function_ invoke__">Uranus</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;8. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 8 references</span></span><br><span class="line">    uranus.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">neptune</span> = Planet::<span class="title function_ invoke__">Neptune</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;sun));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;9. reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 9 references</span></span><br><span class="line">    neptune.<span class="title function_ invoke__">details</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun), <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(neptune);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 8 references</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(uranus);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 7 references</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(saturn);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 6 references</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(jupiter);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 5 references</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(mars);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 4 references</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(earth);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 3 references</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(venus);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 2 references</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(mercury);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;reference count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun)); <span class="comment">// 1 reference</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(Rc::<span class="title function_ invoke__">strong_count</span>(&amp;sun), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="78-smart-pointers-arc1-rs"><a href="#78-smart-pointers-arc1-rs" class="headerlink" title="78 smart_pointers&#x2F;arc1.rs"></a>78 smart_pointers&#x2F;arc1.rs</h2><p>所谓智能指针，并不是说指针是智能的，它其实是对原生指针的一种封装，这种封装通过引用计数器的方法来判断指针是否还在使用，从而自动的管理指针对应的内存资源回收。</p>
<p>在Rust中，最初级的智能指针可以算是 Box，它提供了类似于其它语言的<code>装箱操作</code>，它在堆上提供简单的复制操作。其所有权的语义取决于其封装的对象的类型。其针对单一所有权，如果基础类型实现了 copy，那么它就是拷贝，否则就是Move。</p>
<p>如果感兴趣可以尝试着去实现一个基础的链表，会发现在实现的过程中Rust对Box的一些用法。</p>
<p> a atomic，所以这是一个 原子引用计数（atomically reference counted）类型。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Arc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span>: <span class="type">Vec</span>&lt;_&gt; = (<span class="number">0</span>…<span class="number">100u32</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引用计数指针, 指向一个 Vec</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">shared_numbers</span> = Arc::<span class="title function_ invoke__">new</span>(numbers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环创建 10 个线程</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>…<span class="number">10</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 复制引用计数指针,所有的 Arc 都指向同一个 Vec</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child_numbers</span> = shared_numbers.<span class="title function_ invoke__">clone</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// move修饰闭包,上面这个 Arc 指针被 move 进入了新线程中</span></span><br><span class="line">        thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="comment">// 我们可以在新线程中使用 Arc,读取共享的那个 Vec</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">local_numbers</span> = &amp;child_numbers[…];</span><br><span class="line">            <span class="comment">// 继续使用 Vec 中的数据</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个实验中，给定一个 u32 的 Vec，称其 numbers，值从 0 到 99。</p>
<p>我们希望在 8 个不同的线程中同时使用这组数字。</p>
<p>每一个线程会获得总和的 1&#x2F;8，带有偏移：</p>
<p>对于第一个线程（offset 0），会对 0, 8, 16, … 求和<br>对于第二个线程（offset 1），会对 1, 9, 17, … 求和<br>对于第三个线程（offset 2），会对 2, 10, 18, … 求和<br>…<br>对于第八个线程（offset 7），会对 7, 15, 23, … 求和</p>
<p>因为我们使用了线程，我们的值需要是线程安全的。因此，我们使用 Arc。</p>
<p>通过填充第一个 TODO 所在的 shared_numbers 使代码通过编译，在第二个 TODO 所在的位置为 child_numbers 创建初始绑定。尽量不要创建 numbers Vec 的任何复制。</p>
<p>有关 Arc 的知识，参考原子引用计数 Arc<T> 和 Struct std::sync::Arc。它的本质就是对Rc<T> 引用计数智能指针 的一种重构，使得它可以安全的用于并发环境。</p>
<p>shared_numbers 通过 Arc 创建引用计数的 numbers，在下面的循环中，child_numbers 每通过 Arc clone 一次，shared_numbers 的引用计数就会加一。</p>
<p>在计算 sum 时，filter 会获取满足 *n % 8 &#x3D;&#x3D; offset 的数字并求和，最终输出。为了避免创建 numbers 的 copy，我们需要在 main 线程中创建 child_numbers，而不是在子线程中。</p>
<p>文件名：src&#x2F;main.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例 16-15: 使用 Arc<T> 包装一个 Mutex<T> 能够实现在多线程之间共享所有权</p>
<p>这会打印出：</p>
<p>Result: 10</p>
<p>成功了！我们从 0 数到了 10，这可能并不是很显眼，不过一路上我们确实学习了很多关于 Mutex<T> 和线程安全的内容！这个例子中构建的结构可以用于比增加计数更为复杂的操作。使用这个策略，可将计算分成独立的部分，分散到多个线程中，接着使用 Mutex<T> 使用各自的结算结果更新最终的结果。</p>
<p>注意如果是简单的数值运算，标准库中 std::sync::atomic 模块 提供的比 Mutex<T> 更简单的类型。这些类型提供了基本类型之上安全、并发、原子的操作。这个例子中选择在基本类型上使用 Mutex<T> 以便我们可以专注于 Mutex<T> 如何工作。</p>
<h2 id="79-smart-pointers-cow1-rs"><a href="#79-smart-pointers-cow1-rs" class="headerlink" title="79 smart_pointers&#x2F;cow1.rs"></a>79 smart_pointers&#x2F;cow1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::borrow::Cow;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">abs_all</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt;(input: &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> Cow&lt;<span class="symbol">&#x27;b</span>, [<span class="type">i32</span>]&gt;) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> Cow&lt;<span class="symbol">&#x27;b</span>, [<span class="type">i32</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..input.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">v</span> = input[i];</span><br><span class="line">        <span class="keyword">if</span> v &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// Clones into a vector if not already owned.</span></span><br><span class="line">            input.<span class="title function_ invoke__">to_mut</span>()[i] = -v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    input</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">reference_mutation</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// Clone occurs because `input` needs to be mutated.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">slice</span> = [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">input</span> = Cow::<span class="title function_ invoke__">from</span>(&amp;slice[..]);</span><br><span class="line">        <span class="keyword">match</span> <span class="title function_ invoke__">abs_all</span>(&amp;<span class="keyword">mut</span> input) &#123;</span><br><span class="line">            Cow::<span class="title function_ invoke__">Owned</span>(_) =&gt; <span class="title function_ invoke__">Ok</span>(()),</span><br><span class="line">            _ =&gt; <span class="title function_ invoke__">Err</span>(<span class="string">&quot;Expected owned value&quot;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">reference_no_mutation</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// No clone occurs because `input` doesn&#x27;t need to be mutated.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">slice</span> = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">input</span> = Cow::<span class="title function_ invoke__">from</span>(&amp;slice[..]);</span><br><span class="line">        <span class="keyword">match</span> <span class="title function_ invoke__">abs_all</span>(&amp;<span class="keyword">mut</span> input) &#123;</span><br><span class="line">            Cow::<span class="title function_ invoke__">Borrowed</span>(_) =&gt; <span class="title function_ invoke__">Ok</span>(()),</span><br><span class="line">            _ =&gt; <span class="title function_ invoke__">Err</span>(<span class="string">&quot;Expected borrowed value&quot;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">owned_no_mutation</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// We can also pass `slice` without `&amp;` so Cow owns it directly. In this</span></span><br><span class="line">        <span class="comment">// case no mutation occurs and thus also no clone, but the result is</span></span><br><span class="line">        <span class="comment">// still owned because it was never borrowed or mutated.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">slice</span> = <span class="built_in">vec!</span>[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">input</span> = Cow::<span class="title function_ invoke__">from</span>(slice);</span><br><span class="line">        <span class="keyword">match</span> <span class="title function_ invoke__">abs_all</span>(&amp;<span class="keyword">mut</span> input) &#123;</span><br><span class="line">            Cow::<span class="title function_ invoke__">Owned</span>(_) =&gt; <span class="title function_ invoke__">Ok</span>(()),</span><br><span class="line">            _ =&gt; <span class="title function_ invoke__">Err</span>(<span class="string">&quot;Expected borrowed value&quot;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">owned_mutation</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// Of course this is also the case if a mutation does occur. In this</span></span><br><span class="line">        <span class="comment">// case the call to `to_mut()` returns a reference to the same data as</span></span><br><span class="line">        <span class="comment">// before.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">slice</span> = <span class="built_in">vec!</span>[-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">input</span> = Cow::<span class="title function_ invoke__">from</span>(slice);</span><br><span class="line">        <span class="keyword">match</span> <span class="title function_ invoke__">abs_all</span>(&amp;<span class="keyword">mut</span> input) &#123;</span><br><span class="line">            Cow::<span class="title function_ invoke__">Owned</span>(_) =&gt; <span class="title function_ invoke__">Ok</span>(()),</span><br><span class="line">            _ =&gt; <span class="title function_ invoke__">Err</span>(<span class="string">&quot;Expected borrowed value&quot;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="疑问-4"><a href="#疑问-4" class="headerlink" title="疑问"></a>疑问</h4><p>不懂该题的背景。</p>
<p>cow大致是在解决引用类型数据的所有权与可修改有时会发生矛盾的问题（处理借用和所有权转移），cow写时复制，当不修改内容时，就返回不可变引用；修改内容时，复制一份产生可变引用。具体来说：</p>
<ul>
<li>to_mut()方法的作用是获取数据的可变引用，如果数据当前处于Owned状态，则直接返回对该数据的可变引用；否则，通过克隆数据来获取可变引用，并将数据的所有权转移为Owned状态。</li>
<li>具体来说，如果Cow当前处于Borrowed状态，则说明Cow的底层数据目前并不拥有所有权。此时调用to_mut()方法将克隆数据并返回对其的可变引用，从而获取了底层数据的所有权。此后，对返回的可变引用进行的修改将直接反映在底层数据上。</li>
</ul>
<h2 id="80-thread-thread1-rs"><a href="#80-thread-thread1-rs" class="headerlink" title="80 thread&#x2F;thread1.rs"></a>80 thread&#x2F;thread1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">start</span> = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">250</span>));</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;thread &#123;&#125; is complete&quot;</span>, i);</span><br><span class="line">            start.<span class="title function_ invoke__">elapsed</span>().<span class="title function_ invoke__">as_millis</span>()</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">results</span>: <span class="type">Vec</span>&lt;<span class="type">u128</span>&gt; = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        results.<span class="title function_ invoke__">push</span>(result)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> results.<span class="title function_ invoke__">len</span>() != <span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;Oh no! All the spawned threads did not finish!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>();</span><br><span class="line">    <span class="keyword">for</span> (i, result) <span class="keyword">in</span> results.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;thread &#123;&#125; took &#123;&#125;ms&quot;</span>, i, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rust 并没有像 golang 采用大道至简的方式，而是选择了多线程与 async&#x2F;await 相结合，优点是可控性更强、性能更高，缺点是复杂度不低。</p>
<p>move 关键字经常用于传递给 thread::spawn 的闭包，因为闭包会获取从环境中取得的值的所有权。</p>
<p>定义一个可变的 handles 向量来存储所有的线程句柄。接下来，使用一个循环来创建 10 个线程。当线程启动时，它会获取当前时间戳并存储在 start 变量中，当它完成时，它会再次获取当前时间戳，并计算时间差。然后，在 vector 中存储该时间差。</p>
<p>接下来，我们使用一个循环来等待每个线程完成，然后从其返回值中提取时间差，并将其存储在vector中。如果任何线程不能成功地join，则程序将崩溃并显示错误消息。</p>
<h2 id="81-threads-threads2-rs"><a href="#81-threads-threads2-rs" class="headerlink" title="81 threads&#x2F;threads2.rs"></a>81 threads&#x2F;threads2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">JobStatus</span> &#123;</span><br><span class="line">    jobs_completed: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(JobStatus &#123; jobs_completed: <span class="number">0</span> &#125;));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">status_shared</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;status);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">250</span>));</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> You must take an action before you update a shared value</span></span><br><span class="line">            status_shared.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().jobs_completed += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Print the value of the JobStatus.jobs_completed. Did you notice</span></span><br><span class="line">        <span class="comment">// anything interesting in the output? Do you have to &#x27;join&#x27; on all the</span></span><br><span class="line">        <span class="comment">// handles?</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;jobs completed &#123;&#125;&quot;</span>, status.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().jobs_completed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本题是关于“多线程和多所有权”。</p>
<p>Go 编程语言文档中口号的这一部分：“不要通过共享内存来通讯”。</p>
<p>任何编程语言中的信道都类似于单所有权，因为一旦将一个值传送到信道中，将无法再使用这个值。共享内存类似于多所有权：多个线程可以同时访问相同的内存位置。</p>
<h4 id="疑问-5"><a href="#疑问-5" class="headerlink" title="疑问"></a>疑问</h4><p>该程序还不明白，本程序中出现了两句相似的语句。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">status_shared.lock().unwrap().jobs_completed += 1;</span><br><span class="line">status.lock().unwrap().jobs_completed</span><br></pre></td></tr></table></figure>

<h4 id="背景了解：智能指针"><a href="#背景了解：智能指针" class="headerlink" title="背景了解：智能指针"></a>背景了解：智能指针</h4><p>智能指针（smart pointers）是一类数据结构，他们的表现类似指针，但是也拥有额外的元数据和功能。</p>
<p>在 Rust 中，普通引用和智能指针的一个额外的区别是引用是一类只借用数据的指针；相反，在大部分情况下，智能指针 拥有 他们指向的数据。Rust现存的智能指针很多，这里会研究其中4种智能指针：</p>
<p>Box<T>，用于在堆上分配值<br>Rc<T>，(reference counter) 一个引用计数类型，其数据可以有多个所有者。<br>Arc<T>，(atomic reference counter) 可被多线程操作，但只能只读。<br>Mutex<T>，互斥指针，能保证修改的时候只有一个线程参与。</p>
<h4 id="1-Box指针"><a href="#1-Box指针" class="headerlink" title="1. Box指针"></a>1. Box指针</h4><p>第8章给出了一个错误版本，其中比较重要的部分是因为我们的变量p在多线程环境下被分配到了每个线程的栈内存中，根据rust所有权的机制，它在线程间不断的move，这样的变量是无法满足我们的要求的。因此，我们希望变量能够被储存在堆上。</p>
<p>定义一个Box包装变量：</p>
<p>let mut p &#x3D; Box::new(Point { x: 1, y: 2 });<br>解引用<br>前面一直说引用&amp;，那么如何读出引用的值，就需要解引用*。因此，读取Box变量的写法：</p>
<p>println!(“{}”, (*p).x);<br>执行成功。这里要注意解引用时要加括号，否则会作用到x上面引发报错。</p>
<p><strong>Box变量虽然被强制分配在堆上，但它只能有一个所有权。所以还不是真正的共享。</strong></p>
<h4 id="2-Rc指针"><a href="#2-Rc指针" class="headerlink" title="2. Rc指针"></a>2. Rc指针</h4><p>Box指针修饰的变量只能保证强制被分配到堆上，但同一时间仍旧只能有一个所有权，不算真的共享。下面来学习Rc指针。Rc是一个引用计数智能指针，首先它修饰的变量也会分配在堆上，可以被多个变量所引用，智能指针会记录每个变量的引用，这就是引用计数的概念。下面看一下如何编写使用Rc智能指针。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span> = Rc::<span class="title function_ invoke__">new</span>(Point &#123; x: <span class="number">1</span>, y: <span class="number">2</span> &#125;);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;p);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;p);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;,&#123;&#125;,&#123;&#125;&quot;</span>, p.x, p1.x, p2.x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1、首先变量p被指定由Rc所包装。</p>
<p>2、接着，p1和p2都是由p的引用克隆而来，所以他们都指向p的内存。</p>
<p>3、尝试打印p和p1,p2的x坐标的值，我们用Box指针的话，这样是不行的，一定会报错。但是Rc指针是可以的。</p>
<p>执行成功，打印出1,1,1。</p>
<p>Rc智能指针学习到这里，看上去是可以满足我们的多线程修改共享变量的目的，那我们捡起来之前的rust代码，并将p修改为Rc智能指针所修饰，再去执行一下做个试验。</p>
<p>error[E0277]: Rc<Point> cannot be sent between threads safely</p>
<p>结果是不行的，报错提示了，<strong>说明Rc指针不能保证线程安全，因此只能在单线程中使用。</strong> 看来Rc指针是不能满足我们的需求了。下面我们继续来学习Arc指针。</p>
<h4 id="3-Arc指针"><a href="#3-Arc指针" class="headerlink" title="3. Arc指针"></a>3. Arc指针</h4><p>Arc指针是比Rc多了一个Atomic的限定词语，这是原子的意思。熟悉多线程的朋友应该了解，原子性代表了一种线程安全的特性。那么它该如何使用，是否能满足我们的要求呢？我们来编写一下。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span> = Arc::<span class="title function_ invoke__">new</span>(Point &#123; x: <span class="number">1</span>, y: <span class="number">2</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">p1</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;p);</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;,&#123;&#125;&quot;</span>, i, p1.x);</span><br><span class="line">    <span class="comment">// p.x += 1;</span></span><br><span class="line">  &#125;);</span><br><span class="line">  handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">  handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;TODO: panic message&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, p.x);</span><br></pre></td></tr></table></figure>

<p>1、我们修改了第1行p为Arc的修饰。</p>
<p>2、然后第4行增加了对p的引用的克隆。这是在循环体内执行的，保证每个线程都能有单独的变量使用，同时借由Arc的特性，这些变量都共同指向了同一个内存值。</p>
<p>3、我们注释掉了第7行对于共享变量的修改操作，否则会报错：error[E0594]: cannot assign to data in an Arc</p>
<p>总结一下，<strong>Arc智能指针继承了Rc的能力，同时又能够满足多线程下的操作，使得变量真正成为共享变量。然而Arc不能被修改，是只读权限</strong>，这就无法满足我们要修改的需求。我们距离目标越来越近了。</p>
<h4 id="4-Mutex指针"><a href="#4-Mutex指针" class="headerlink" title="4. Mutex指针"></a>4. Mutex指针</h4><p>下面来介绍Mutex指针，它是专门为修改共享变量而生的。Mutex指针能够保证同一时间下，只有一个线程可以对变量进行修改，其他线程必须等待当前线程修改完毕方可进行修改。</p>
<p>Mutex指针的功能描述，与java的多线程上锁的过程很相似。可变不共享，共享不可变。</p>
<p>下面我们在之前的基础上尝试修改：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span> = Mutex::<span class="title function_ invoke__">new</span>(Point &#123; x: <span class="number">1</span>, y: <span class="number">2</span> &#125;);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="comment">// let p1 = Arc::clone(&amp;p);</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p0</span> = p.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;,&#123;&#125;&quot;</span>, i, p0.x);</span><br><span class="line">            p0.x += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;TODO: panic message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, p.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1、首先第2行我们将p改为用Mutex指针修饰。</p>
<p>2、第7行要注意，Mutex 之所以能够是互斥，因为它内部是通过锁机制来实现了多线程下的线程安全。所以这里要先得到p的锁即 p.lock()，然后再解包装，就能得到里面的值。我们将它复制给 p0。</p>
<p>3、最后打印的时候也要注意同样的写法。</p>
<p>那么这段代码的执行仍旧是失败，报错提示error[E0382]: use of moved value: p。</p>
<p>其实<strong>问题还是出在了共享变量上，Mutex单独修饰的变量并不是共享变量，因为它的所有权在同一时间仍旧是只有一个，也就是说这里其实缺少了Rc的能力。</strong></p>
<h5 id="终版"><a href="#终版" class="headerlink" title="终版"></a>终版</h5><p>前面我们学习了4种智能指针，<strong>Box和Rc首先被淘汰</strong>，因为他们距离我们的需求都比较遥远，但是他们两个的学习可以很有效地帮助我们学习其他的智能指针。而Arc和Mutex这两个智能指针在编写代码的时候，总是感觉跟我们的目标擦肩而过。那么我们可以想一想，如果<strong>使用Arc来包装Mutex指针，然后Mutex指针再包装一层变量。</strong> 这样我们就可以既满足多线程下修改的线程安全，同时又能够克隆出来多个变量的引用，共同指向同一内存。下面就来实现一下本文题目的最终版本。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(Point &#123; x: <span class="number">1</span>, y: <span class="number">2</span> &#125;));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pp</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;p);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p0</span> = pp.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;thread-&#123;&#125;::&#123;&#125;&quot;</span>, i, p0.x);</span><br><span class="line">            p0.x += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;TODO: panic message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;total: &#123;&#125;&quot;</span>, p.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如前面分析的，</p>
<p>1、我们在第10行将变量p先用Mutex包装一层，然后在外层再使用Arc智能指针包装一层。</p>
<p>2、第13行，我们在循环体内，子线程外，给变量p克隆出一个pp。</p>
<p>3、第15行，我们使用pp.lock().unwrap()得到Mutex包装的变量值。</p>
<p>4、后面就是对于p0在子线程中的操作。</p>
<p>最后打印出来p的x坐标，执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">thread-0::1</span><br><span class="line">thread-1::2</span><br><span class="line">thread-4::3</span><br><span class="line">thread-3::4</span><br><span class="line">thread-2::5</span><br><span class="line">thread-5::6</span><br><span class="line">thread-6::7</span><br><span class="line">thread-7::8</span><br><span class="line">thread-8::9</span><br><span class="line">thread-9::10</span><br><span class="line">total: 11</span><br></pre></td></tr></table></figure>
<p>共享变量p的x坐标值被10个线程所修改，每个线程都对其进行了加1操作，最终该共享变量p的x坐标变为了11，结果符合预期。</p>
<h2 id="82-threads-threads3-rs"><a href="#82-threads-threads3-rs" class="headerlink" title="82 threads&#x2F;threads3.rs"></a>82 threads&#x2F;threads3.rs</h2><p>任何编程语言中的信道都类似于单所有权，因为一旦将一个值传送到信道中，将无法再使用这个值。共享内存类似于多所有权：多个线程可以同时访问相同的内存位置。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">    length: <span class="type">u32</span>,</span><br><span class="line">    first_half: <span class="type">Vec</span>&lt;<span class="type">u32</span>&gt;,</span><br><span class="line">    second_half: <span class="type">Vec</span>&lt;<span class="type">u32</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Queue &#123;</span><br><span class="line">            length: <span class="number">10</span>,</span><br><span class="line">            first_half: <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">            second_half: <span class="built_in">vec!</span>[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">send_tx</span>(q: Queue, tx: mpsc::Sender&lt;<span class="type">u32</span>&gt;) <span class="punctuation">-&gt;</span> () &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qc</span> = Arc::<span class="title function_ invoke__">new</span>(q);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qc1</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;qc);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qc2</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;qc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tx1</span> = mpsc::Sender::<span class="title function_ invoke__">clone</span>(&amp;tx);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tx2</span> = mpsc::Sender::<span class="title function_ invoke__">clone</span>(&amp;tx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> &amp;qc1.first_half &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;sending &#123;:?&#125;&quot;</span>, val);</span><br><span class="line">            tx1.<span class="title function_ invoke__">send</span>(*val).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> &amp;qc2.second_half &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;sending &#123;:?&#125;&quot;</span>, val);</span><br><span class="line">            tx2.<span class="title function_ invoke__">send</span>(*val).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">queue</span> = Queue::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">queue_length</span> = queue.length;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">send_tx</span>(queue, tx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">total_received</span>: <span class="type">u32</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">received</span> <span class="keyword">in</span> rx &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Got: &#123;&#125;&quot;</span>, received);</span><br><span class="line">        total_received += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;total numbers received: &#123;&#125;&quot;</span>, total_received);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(total_received, queue_length)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该程序添加了下面两句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let tx1 = mpsc::Sender::clone(&amp;tx);</span><br><span class="line">let tx2 = mpsc::Sender::clone(&amp;tx);</span><br></pre></td></tr></table></figure>

<p>In the code you provided, <code>tx</code> is cloned to ensure that each spawned thread has its own copy of the sender, allowing them to send data concurrently without data races. This is a common pattern when working with Rust’s <code>mpsc</code> (multi-producer, single-consumer) channels.</p>
<p>Here’s why you need to clone <code>tx</code>:</p>
<ol>
<li><p><strong>Ownership and Concurrency</strong>: In Rust, ownership rules prevent multiple threads from directly accessing the same data. To send data through a channel, you need to have ownership of the sender. By cloning <code>tx</code>, you are effectively creating a separate sender for each thread, ensuring that each thread has exclusive ownership of its sender.</p>
</li>
<li><p><strong>Message Passing</strong>: Each thread will send messages through its own sender (<code>tx1</code> and <code>tx2</code>) without conflicting with the other threads. If you shared the same sender across multiple threads, you could have race conditions and undefined behavior when they try to send messages concurrently.</p>
</li>
<li><p><strong>Cloning is Cheap for Senders</strong>: Cloning a sender (<code>Sender</code>) in Rust is a cheap operation because it doesn’t involve deep copying of data but rather increments the reference count for the underlying channel. It allows multiple threads to send messages through the same channel simultaneously.</p>
</li>
</ol>
<p>So, cloning <code>tx</code> is a common practice in multi-threaded Rust code when you want each thread to have its own sender for concurrent message passing while avoiding data races.</p>
<h2 id="083-macros-macros1-rs"><a href="#083-macros-macros1-rs" class="headerlink" title="083 macros&#x2F;macros1.rs"></a>083 macros&#x2F;macros1.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> my_macro &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Check out my macro!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    my_macro!();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从根本上来说，宏是通过一种代码来生成另一种代码。</p>
<p>声明宏（declarative macros）声明宏允许我们编写一些类似 Rust match 表达式的代码。</p>
<h2 id="084-macros-macros2-rs"><a href="#084-macros-macros2-rs" class="headerlink" title="084 macros&#x2F;macros2.rs"></a>084 macros&#x2F;macros2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> my_macro &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Check out my macro!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    my_macro!();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="085-macros-macros3-rs"><a href="#085-macros-macros3-rs" class="headerlink" title="085 macros&#x2F;macros3.rs"></a>085 macros&#x2F;macros3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[macro_use]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> macros &#123;</span><br><span class="line">    <span class="built_in">macro_rules!</span> my_macro &#123;</span><br><span class="line">        () =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Check out my macro!&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    my_macro!();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="086-macros-macros4-rs"><a href="#086-macros-macros4-rs" class="headerlink" title="086 macros&#x2F;macros4.rs"></a>086 macros&#x2F;macros4.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> my_macro &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Check out my macro!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    ($val:expr) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Look at this other macro: &#123;&#125;&quot;</span>, $val);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    my_macro!();</span><br><span class="line">    my_macro!(<span class="number">7777</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="087-clippy-clippy1-rs"><a href="#087-clippy-clippy1-rs" class="headerlink" title="087 clippy&#x2F;clippy1.rs"></a>087 clippy&#x2F;clippy1.rs</h2><p>clippy1:参考 <a target="_blank" rel="noopener" href="https://rust-lang.github.io/rust-clippy/master/index.html#approx_constant%EF%BC%8C%E5%BD%93%E6%A3%80%E6%9F%A5%E5%88%B0%E8%BF%91%E4%BC%BC%E4%BA%8E">https://rust-lang.github.io/rust-clippy/master/index.html#approx_constant，当检查到近似于</a> std::f32::consts 或 std::f64::consts 的常量时就会报错。因为默认 #[deny(clippy::approx_constant)] 选项是开启的。我们可以用 f32::consts::PI 替代</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let pi = f32::consts::PI;</span><br></pre></td></tr></table></figure>

<h2 id="088-clippy-clippy2-rs"><a href="#088-clippy-clippy2-rs" class="headerlink" title="088 clippy&#x2F;clippy2.rs"></a>088 clippy&#x2F;clippy2.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">res</span> = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">option</span> = <span class="title function_ invoke__">Some</span>(<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(x) = option &#123;</span><br><span class="line">        res += x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="089-clippy-clippy3-rs"><a href="#089-clippy-clippy3-rs" class="headerlink" title="089 clippy&#x2F;clippy3.rs"></a>089 clippy&#x2F;clippy3.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[allow(unused_variables, unused_assignments)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">my_option</span>: <span class="type">Option</span>&lt;()&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="comment">//if my_option.is_none() &#123;</span></span><br><span class="line">    <span class="comment">//    my_option.unwrap();</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">my_arr</span> = &amp;[</span><br><span class="line">        -<span class="number">1</span>, -<span class="number">2</span>, -<span class="number">3</span>,</span><br><span class="line">        -<span class="number">4</span>, -<span class="number">5</span>, -<span class="number">6</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;My array! Here it is: &#123;:?&#125;&quot;</span>, my_arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">my_empty_vec</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    my_empty_vec.<span class="title function_ invoke__">clear</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;This Vec is empty, see? &#123;:?&#125;&quot;</span>, my_empty_vec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">value_a</span> = <span class="number">45</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">value_b</span> = <span class="number">66</span>;</span><br><span class="line">    <span class="comment">// Let&#x27;s swap these two!</span></span><br><span class="line">    <span class="comment">//value_a = value_b;</span></span><br><span class="line">    <span class="comment">//value_b = value_a;</span></span><br><span class="line">    std::mem::<span class="title function_ invoke__">swap</span>(&amp;<span class="keyword">mut</span> value_a, &amp;<span class="keyword">mut</span> value_b);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;value a: &#123;&#125;; value b: &#123;&#125;&quot;</span>, value_a, value_b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="090-conversions-using-as-rs"><a href="#090-conversions-using-as-rs" class="headerlink" title="090 conversions&#x2F;using_as.rs"></a>090 conversions&#x2F;using_as.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">average</span>(values: &amp;[<span class="type">f64</span>]) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">total</span> = values.<span class="title function_ invoke__">iter</span>().sum::&lt;<span class="type">f64</span>&gt;();</span><br><span class="line">    total / values.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> <span class="type">f64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">values</span> = [<span class="number">3.5</span>, <span class="number">0.3</span>, <span class="number">13.0</span>, <span class="number">11.7</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">average</span>(&amp;values));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Rust 中内置了一些基本类型之间的转换，使用 as 操作符来完成。</p>
<h2 id="091-conversions-from-into-rs"><a href="#091-conversions-from-into-rs" class="headerlink" title="091 conversions&#x2F;from_into.rs"></a>091 conversions&#x2F;from_into.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    age: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We implement the Default trait to use it as a fallback</span></span><br><span class="line"><span class="comment">// when the provided string is not convertible into a Person object</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Default</span> <span class="keyword">for</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">default</span>() <span class="punctuation">-&gt;</span> Person &#123;</span><br><span class="line">        Person &#123;</span><br><span class="line">            name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;John&quot;</span>),</span><br><span class="line">            age: <span class="number">30</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your task is to complete this implementation in order for the line `let p = Person::from(&quot;Mark,20&quot;)` to compile Please note that you&#x27;ll need to parse the</span></span><br><span class="line"><span class="comment">// age component into a `usize` with something like `&quot;4&quot;.parse::&lt;usize&gt;()`.</span></span><br><span class="line"><span class="comment">// The outcome of this needs to be handled appropriately.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Steps:</span></span><br><span class="line"><span class="comment">// 1. If the length of the provided string is 0, then return the default of Person.</span></span><br><span class="line"><span class="comment">// 2. Split the given string on the commas present in it.</span></span><br><span class="line"><span class="comment">// 3. Extract the first element from the split operation and use it as the name.</span></span><br><span class="line"><span class="comment">// 4. If the name is empty, then return the default of Person.</span></span><br><span class="line"><span class="comment">// 5. Extract the other element from the split operation and parse it into a</span></span><br><span class="line"><span class="comment">//    `usize` as the age.</span></span><br><span class="line"><span class="comment">// If while parsing the age, something goes wrong, then return the default of</span></span><br><span class="line"><span class="comment">// Person Otherwise, then return an instantiated Person object with the results</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1. 首先检查输入字符串的长度，如果是0则返回默认的Person对象。这个步骤也可以直接使用 if s.is_empty()来代替。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2. 使用逗号分隔符将输入字符串分割成两个部分。这个步骤使用 s.split(&#x27;,&#x27;).collect()实现。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">3. 提取分割后的第一个元素作为姓名（name）。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">4. 如果姓名为空，则返回默认的Person对象。这个步骤可以直接使用 if name.is_empty()来判断。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">5. 将分割后的第二部分作为字符串进行解析，得到年龄age，如果解析失败则返回默认的Person对象。这个步骤使用 parts[1].trim().parse::&lt;usize&gt;()来实现。trim()函数用于去除空格和换行符等。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">6. 如果所有步骤都成功，则返回一个新的Person对象，其姓名是name，年龄是age。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;&amp;<span class="type">str</span>&gt; <span class="keyword">for</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> Person &#123;</span><br><span class="line">        <span class="keyword">if</span> s.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">            Person::<span class="title function_ invoke__">default</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">let</span> <span class="variable">parts</span>:<span class="type">Vec</span>&lt;&amp;<span class="type">str</span>&gt; = s.<span class="title function_ invoke__">split</span>(<span class="string">&quot;,&quot;</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">            <span class="keyword">if</span> parts.<span class="title function_ invoke__">len</span>() != <span class="number">2</span>&#123;</span><br><span class="line">                Person::<span class="title function_ invoke__">default</span>()</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">name</span> = parts[<span class="number">0</span>].<span class="title function_ invoke__">trim</span>();</span><br><span class="line">                <span class="keyword">if</span> name.<span class="title function_ invoke__">is_empty</span>()&#123;</span><br><span class="line">                    Person::<span class="title function_ invoke__">default</span>()</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(age) = parts[<span class="number">1</span>].<span class="title function_ invoke__">trim</span>().parse::&lt;<span class="type">usize</span>&gt;() &#123;</span><br><span class="line">                    Person&#123;name:<span class="type">String</span>::<span class="title function_ invoke__">from</span>(name),age&#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Person::<span class="title function_ invoke__">default</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Use the `from` function</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Mark,20&quot;</span>);</span><br><span class="line">    <span class="comment">// Since From is implemented for Person, we should be able to use Into</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span>: Person = <span class="string">&quot;Gerald,70&quot;</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_default</span>() &#123;</span><br><span class="line">        <span class="comment">// Test that the default person is 30 year old John</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">dp</span> = Person::<span class="title function_ invoke__">default</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(dp.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(dp.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_bad_convert</span>() &#123;</span><br><span class="line">        <span class="comment">// Test that John is returned when bad string is provided</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span> = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_good_convert</span>() &#123;</span><br><span class="line">        <span class="comment">// Test that &quot;Mark,20&quot; works</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span> = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Mark,20&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;Mark&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_bad_age</span>() &#123;</span><br><span class="line">        <span class="comment">// Test that &quot;Mark,twenty&quot; will return the default person due to an</span></span><br><span class="line">        <span class="comment">// error in parsing age</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span> = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Mark,twenty&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_missing_comma_and_age</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span>: Person = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Mark&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_missing_age</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span>: Person = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Mark,&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_missing_name</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span>: Person = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;,1&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_missing_name_and_age</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span>: Person = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_missing_name_and_invalid_age</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span>: Person = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;,one&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_trailing_comma</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span>: Person = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Mike,32,&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_trailing_comma_and_some_string</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">p</span>: Person = Person::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Mike,32,man&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.name, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(p.age, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let num = Number::from(30);</span><br><span class="line"></span><br><span class="line">let int = 5;</span><br><span class="line">let num: Number = int.into();</span><br></pre></td></tr></table></figure>

<p>from into 两个成对的函数的，在我看来，两者的功能一样，都是将 int 转换为 Number。<br>这是一个疑问，一样的功能，为什么要提出这么一个概念？</p>
<h2 id="092-conversions-from-str-rs"><a href="#092-conversions-from-str-rs" class="headerlink" title="092 conversions&#x2F;from_str.rs"></a>092 conversions&#x2F;from_str.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    age: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We will use this error type for the `FromStr` implementation.</span></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">ParsePersonError</span> &#123;</span><br><span class="line">    <span class="comment">// Empty input string</span></span><br><span class="line">    Empty,</span><br><span class="line">    <span class="comment">// Incorrect number of fields</span></span><br><span class="line">    BadLen,</span><br><span class="line">    <span class="comment">// Empty name field</span></span><br><span class="line">    NoName,</span><br><span class="line">    <span class="comment">// Wrapped error from parse::&lt;usize&gt;()</span></span><br><span class="line">    <span class="title function_ invoke__">ParseInt</span>(ParseIntError),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Steps:</span></span><br><span class="line"><span class="comment">// 1. If the length of the provided string is 0, an error should be returned</span></span><br><span class="line"><span class="comment">// 2. Split the given string on the commas present in it</span></span><br><span class="line"><span class="comment">// 3. Only 2 elements should be returned from the split, otherwise return an error</span></span><br><span class="line"><span class="comment">// 4. Extract the first element from the split operation and use it as the name</span></span><br><span class="line"><span class="comment">// 5. Extract the other element from the split operation and parse it into a</span></span><br><span class="line"><span class="comment">//    `usize` as the age with something like `&quot;4&quot;.parse::&lt;usize&gt;()`</span></span><br><span class="line"><span class="comment">// 6. If while extracting the name and the age something goes wrong, an error</span></span><br><span class="line"><span class="comment">//    should be returned</span></span><br><span class="line"><span class="comment">// If everything goes well, then return a Result of a Person object</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// As an aside: `Box&lt;dyn Error&gt;` implements `From&lt;&amp;&#x27;_ str&gt;`. This means that if</span></span><br><span class="line"><span class="comment">// you want to return a string error message, you can do so via just using</span></span><br><span class="line"><span class="comment">// return `Err(&quot;my error message&quot;.into())`.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">FromStr</span> <span class="keyword">for</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Err</span> = ParsePersonError;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_str</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;Person, <span class="keyword">Self</span>::<span class="literal">Err</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> s.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="title function_ invoke__">Err</span>(ParsePersonError::Empty),</span><br><span class="line">            <span class="literal">false</span> =&gt;&#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">parts</span>:<span class="type">Vec</span>&lt;&amp;<span class="type">str</span>&gt; = s.<span class="title function_ invoke__">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">                <span class="keyword">match</span> parts.<span class="title function_ invoke__">len</span>() !=<span class="number">2</span> &#123;</span><br><span class="line">                    <span class="literal">true</span> =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ParsePersonError::BadLen),</span><br><span class="line">                    <span class="literal">false</span> =&gt; &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="variable">name</span> = parts[<span class="number">0</span>].<span class="title function_ invoke__">trim</span>();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> name.<span class="title function_ invoke__">is_empty</span>()&#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ParsePersonError::NoName);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> <span class="variable">number</span> = parts[<span class="number">1</span>].<span class="title function_ invoke__">parse</span>();</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(x) = number &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ParsePersonError::<span class="title function_ invoke__">ParseInt</span>((x)))</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="title function_ invoke__">Ok</span>(Person&#123;name:<span class="type">String</span>::<span class="title function_ invoke__">from</span>(name), age:number.<span class="title function_ invoke__">unwrap</span>()&#125;)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span> = <span class="string">&quot;Mark,20&quot;</span>.parse::&lt;Person&gt;().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读完代码发现跟from_into的逻辑基本类似，只是将默认处理修改为了Err报错。由于测试test逻辑基本类似，所以基本不用大改，只是由于Err的类型，需要略微调整一下代码的顺序。</p>
<p>在实现 FromStr 时，可以在 Strings 上使用 parse 方法以生成实现者类型的对象。</p>
<h2 id="093-conversions-try-from-into-rs"><a href="#093-conversions-try-from-into-rs" class="headerlink" title="093 conversions&#x2F;try_from_into.rs"></a>093 conversions&#x2F;try_from_into.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::convert::&#123;TryFrom, TryInto&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    red: <span class="type">u8</span>,</span><br><span class="line">    green: <span class="type">u8</span>,</span><br><span class="line">    blue: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We will use this error type for these `TryFrom` conversions.</span></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">IntoColorError</span> &#123;</span><br><span class="line">    <span class="comment">// Incorrect length of slice</span></span><br><span class="line">    BadLen,</span><br><span class="line">    <span class="comment">// Integer conversion error</span></span><br><span class="line">    IntConversion,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 您需要为三个整数的元组、三个整数的数组和一个整数切片创建一个实现。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Tuple implementation</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">TryFrom</span>&lt;(<span class="type">i16</span>, <span class="type">i16</span>, <span class="type">i16</span>)&gt; <span class="keyword">for</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Error</span> = IntoColorError;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">try_from</span>(tuple: (<span class="type">i16</span>, <span class="type">i16</span>, <span class="type">i16</span>)) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="keyword">Self</span>, <span class="keyword">Self</span>::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> [tuple.<span class="number">0</span>,tuple.<span class="number">1</span>,tuple.<span class="number">2</span>] &#123;</span><br><span class="line">            <span class="keyword">if</span> i &lt;<span class="number">0</span> || i&gt;<span class="number">255</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(IntoColorError::IntConversion);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(Color&#123;red:tuple.<span class="number">0</span> <span class="keyword">as</span> <span class="type">u8</span>, green:tuple.<span class="number">1</span> <span class="keyword">as</span> <span class="type">u8</span>, blue:tuple.<span class="number">2</span> <span class="keyword">as</span> <span class="type">u8</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Array implementation</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">TryFrom</span>&lt;[<span class="type">i16</span>; <span class="number">3</span>]&gt; <span class="keyword">for</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Error</span> = IntoColorError;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">try_from</span>(arr: [<span class="type">i16</span>; <span class="number">3</span>]) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="keyword">Self</span>, <span class="keyword">Self</span>::Error&gt; &#123;</span><br><span class="line">        Color::<span class="title function_ invoke__">try_from</span>((arr[<span class="number">0</span>],arr[<span class="number">1</span>],arr[<span class="number">2</span>]))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Slice implementation</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">TryFrom</span>&lt;&amp;[<span class="type">i16</span>]&gt; <span class="keyword">for</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Error</span> = IntoColorError;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">try_from</span>(slice: &amp;[<span class="type">i16</span>]) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="keyword">Self</span>, <span class="keyword">Self</span>::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> slice.<span class="title function_ invoke__">len</span>() != <span class="number">3</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(IntoColorError::BadLen)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Color::<span class="title function_ invoke__">try_from</span>((slice[<span class="number">0</span>],slice[<span class="number">1</span>],slice[<span class="number">2</span>]))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Use the `try_from` function</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c1</span> = Color::<span class="title function_ invoke__">try_from</span>((<span class="number">183</span>, <span class="number">65</span>, <span class="number">14</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, c1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Since TryFrom is implemented for Color, we should be able to use TryInto</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c2</span>: <span class="type">Result</span>&lt;Color, _&gt; = [<span class="number">183</span>, <span class="number">65</span>, <span class="number">14</span>].<span class="title function_ invoke__">try_into</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, c2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">183</span>, <span class="number">65</span>, <span class="number">14</span>];</span><br><span class="line">    <span class="comment">// With slice we should use `try_from` function</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c3</span> = Color::<span class="title function_ invoke__">try_from</span>(&amp;v[..]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, c3);</span><br><span class="line">    <span class="comment">// or take slice within round brackets and use TryInto</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c4</span>: <span class="type">Result</span>&lt;Color, _&gt; = (&amp;v[..]).<span class="title function_ invoke__">try_into</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, c4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TryFrom 是 Rust 标准库中的一个工具，它可以让我们从一个类型转换到另一个类型。但与 From 不同的是，TryFrom 会在转换失败时返回错误，而不是 panic。</p>
<p>例如，假设我们有一个字符串表示年龄，我们想把它转换成一个 usize 类型。使用 FromStr trait 我们可以通过调用 parse() 函数轻松地实现这个转换，如果能成功转换，则返回解析后的值，否则返回一个 Err 对象。这种方式简单易懂，但是它违反了 Rust 的一些设计原则——避免隐藏错误。</p>
<p>如果我们使用 FromStr 进行转换时没有考虑到错误情况，那么就会导致程序在转换失败时无法处理错误，最终产生不可预测的后果。</p>
<p>TryFrom 就是为了解决这个问题而诞生的。它强制我们在类型转换中考虑错误的情况，并且在转换失败时返回一个合适的错误类型，以便我们能够更好地处理错误。当我们使用 TryFrom 时，我们需要为目标类型实现 TryFrom trait，并使用 try_from() 函数进行转换。如果转换成功，则返回之前提及的 Ok 对象，否则返回一个 Err 对象，其中包含了转换失败的相关信息。</p>
<h2 id="094-conversions-as-ref-mut-rs"><a href="#094-conversions-as-ref-mut-rs" class="headerlink" title="094 conversions&#x2F;as_ref_mut.rs"></a>094 conversions&#x2F;as_ref_mut.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">byte_counter</span>&lt;T: <span class="built_in">AsRef</span>&lt;<span class="type">str</span>&gt;&gt;(arg: T) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    arg.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">as_bytes</span>().<span class="title function_ invoke__">len</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Obtain the number of characters (not bytes) in the given argument.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Add the AsRef trait appropriately as a trait bound.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">char_counter</span>&lt;T: <span class="built_in">AsRef</span>&lt;<span class="type">str</span>&gt;&gt;(arg: T) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    arg.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">count</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Squares a number using as_mut().</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Add the appropriate trait bound.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">num_sq</span>&lt;T: <span class="built_in">AsMut</span>&lt;<span class="type">u32</span>&gt;&gt;(arg: &amp;<span class="keyword">mut</span> T) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Implement the function body.</span></span><br><span class="line">    *arg.<span class="title function_ invoke__">as_mut</span>() *= *arg.<span class="title function_ invoke__">as_mut</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">different_counts</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;Café au lait&quot;</span>;</span><br><span class="line">        <span class="built_in">assert_ne!</span>(<span class="title function_ invoke__">char_counter</span>(s), <span class="title function_ invoke__">byte_counter</span>(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">same_counts</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;Cafe au lait&quot;</span>;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">char_counter</span>(s), <span class="title function_ invoke__">byte_counter</span>(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">different_counts_using_string</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Café au lait&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_ne!</span>(<span class="title function_ invoke__">char_counter</span>(s.<span class="title function_ invoke__">clone</span>()), <span class="title function_ invoke__">byte_counter</span>(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">same_counts_using_string</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Cafe au lait&quot;</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">char_counter</span>(s.<span class="title function_ invoke__">clone</span>()), <span class="title function_ invoke__">byte_counter</span>(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">mult_box</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span>: <span class="type">Box</span>&lt;<span class="type">u32</span>&gt; = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">3</span>);</span><br><span class="line">        <span class="title function_ invoke__">num_sq</span>(&amp;<span class="keyword">mut</span> num);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(*num, <span class="number">9</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>as_ref_mut 是一个方法，它允许我们将一个值转换为对同一值的可变引用。</p>
<p>假设我们有一个整数变量 x，它的类型是 i32。通常情况下，如果我们想修改 x 的值，我们需要拥有它的可变借用（mutable borrow）。但是有时候，我们可能已经拥有了一个“不可变的引用”，而我们又希望能够修改这个值。</p>
<p>这时候就可以使用 as_ref_mut 方法来实现。</p>
<p>具体来说，as_ref_mut 方法将一个值转换为对同一值的可变引用，但是只有在原始值（调用 as_ref_mut 方法的值）<strong>本身就是可变的时候</strong>才会返回可变引用。如果原始值是不可变的，那么 as_ref_mut 方法返回一个 None。因此，我们可以通过检查 Option 类型的返回值来确定是否成功地获得了可变引用。</p>
<p>举个例子，假设我们有一个字符串 s，我们希望将其转换为一个字节切片的可变引用。我们可以使用 as_mut 方法将字符串转换为 &amp;mut [u8] 类型的可变引用。如果字符串是可变的，那么转换成功并返回一个 Some 值，其中包含可变引用；否则，返回 None。</p>
<p>总之，as_ref_mut 方法是 Rust 提供的一种转换方法，<strong>它可以方便地将一个值转换为对同一值的可变引用，但只有在原始值本身是可变的情况下才会成功。这样可以帮助我们更好地控制可变性，并提供一种安全和灵活的方式来修改数据。</strong></p>
<p>AsRef 是一个 trait（特质），用于将一个类型转换为另一种类型的引用。</p>
<p>AsRef 的主要作用是允许我们以统一的方式处理不同类型之间的转换。通过实现 AsRef trait，我们可以定义一个类型转换函数，该函数将一个类型转换为另一个类型的引用，而不是拥有新的所有权。</p>
<p>具体来说，如果我们有一个类型 T，并且希望将其转换为类型 U 的引用，我们可以实现 <code>AsRef &lt;U&gt; trait</code> 来完成这个转换。在实现中，我们需要提供一个名为 as_ref 的方法，该方法返回类型 &amp;U。这样，我们就可以使用 as_ref 方法来将 T 转换为 U 的引用。</p>
<p>当我们在代码中需要将一个类型转换为另一个类型的引用时，可以使用 as_ref 方法来进行转换。这对于接受不同类型引用参数的函数或方法非常有用，因为它使得我们可以使用相同的代码来处理不同的类型。</p>
<p>AsRef trait 主要用于提供一种通用的引用转换机制，使得代码更加灵活和可重用。在标准库中，许多类型都实现了 AsRef trait，例如字符串、向量、切片等。这意味着我们可以使用 as_ref 方法来将这些类型转换为其他类型的引用，而不需要进行显式的类型转换。</p>
<p>总之，AsRef 是 Rust 中的一个 trait，它提供了一种统一的方式来将一个类型转换为另一个类型的引用。通过实现 AsRef trait，我们可以定义自己的类型转换，并使用 as_ref 方法来执行转换操作。这为代码重用和类型灵活性提供了便利。</p>
<p>as_mut()和AsMut trait就也很好理解了。跟上面AsRef极其类似。至于为什么要使用as_mut，这是因为T类型因为不确定，所以编译器不清楚它的内部值是否可以直接修改，所以对泛型参数进行可变操作是被禁止的，所以我们用as_mut明确地告诉编译器该类型是可变的。</p>
<p>AsMut <T> 是一个标准库中定义的 trait，它将类型 T 转换为一个指向其内部值的可变引用。当我们在泛型函数中使用 T: AsMut <u32> 这个 trait bound 时，我们告诉编译器要求 T 类型必须具备将其内部值作为 u32 类型的可变引用的能力。通过这个 trait bound，编译器就可以安全地假设我们可以使用 as_mut() 方法来获得一个指向 arg 内部值的可变引用。这样，我们就可以对该值进行修改，而不会破坏借用规则。</p>
<h2 id="095-tests-tests5-rs"><a href="#095-tests-tests5-rs" class="headerlink" title="095 tests&#x2F;tests5.rs"></a>095 tests&#x2F;tests5.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// # Safety</span></span><br><span class="line"><span class="comment">/// The `address` must contain a mutable reference to a valid `u32` value.</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">modify_by_address</span>(address: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Fill your safety notice of the code block below to match your</span></span><br><span class="line">    <span class="comment">// code&#x27;s behavior and the contract of this function. You may use the</span></span><br><span class="line">    <span class="comment">// comment of the test below as your format reference.</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        *(address <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u32</span>) = <span class="number">0xAABBCCDD</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_success</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">t</span>: <span class="type">u32</span> = <span class="number">0x12345678</span>;</span><br><span class="line">        <span class="comment">// SAFETY: The address is guaranteed to be valid and contains</span></span><br><span class="line">        <span class="comment">// a unique reference to a `u32` local variable.</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">modify_by_address</span>(&amp;<span class="keyword">mut</span> t <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u32</span> <span class="keyword">as</span> <span class="type">usize</span>) &#125;;</span><br><span class="line">        <span class="built_in">assert!</span>(t == <span class="number">0xAABBCCDD</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><ul>
<li><a target="_blank" rel="noopener" href="https://rqdmap.top/posts/rust-unsafe/">https://rqdmap.top/posts/rust-unsafe/</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/388258029">https://zhuanlan.zhihu.com/p/388258029</a></li>
</ul>
<h2 id="096-tests-tests6-rs"><a href="#096-tests-tests6-rs" class="headerlink" title="096 tests&#x2F;tests6.rs"></a>096 tests&#x2F;tests6.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In this example we take a shallow dive into the Rust standard library&#x27;s</span></span><br><span class="line"><span class="comment">// unsafe functions. Fix all the question marks and todos to make the test</span></span><br><span class="line"><span class="comment">// pass.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint tests6` or use the `hint` watch subcommand for a</span></span><br><span class="line"><span class="comment">// hint.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    a: <span class="type">u128</span>,</span><br><span class="line">    b: <span class="type">Option</span>&lt;<span class="type">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// # Safety</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The `ptr` must contain an owned box of ` ???Foo`.</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">raw_pointer_to_box</span>(ptr: *<span class="keyword">mut</span> Foo) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;Foo&gt; &#123;</span><br><span class="line">    <span class="comment">// SAFETY: The `ptr` contains an owned box of `Foo` by contract. We</span></span><br><span class="line">    <span class="comment">// simply reconstruct the box from that pointer.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ret</span>: <span class="type">Box</span>&lt;Foo&gt; = <span class="keyword">unsafe</span> &#123; <span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(ptr) &#125;;</span><br><span class="line">    ret.b = <span class="title function_ invoke__">Some</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> std::time::Instant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_success</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Foo &#123; a: <span class="number">1</span>, b: <span class="literal">None</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr_1</span> = &amp;data.a <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u128</span> <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">        <span class="comment">// SAFETY: We pass an owned box of ` ???Foo`.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ret</span> = <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">raw_pointer_to_box</span>(<span class="type">Box</span>::<span class="title function_ invoke__">into_raw</span>(data)) &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr_2</span> = &amp;ret.a <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u128</span> <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert!</span>(ptr_1 == ptr_2);</span><br><span class="line">        <span class="built_in">assert!</span>(ret.b == <span class="title function_ invoke__">Some</span>(<span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">to_owned</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="097-tests-tests7-rs"><a href="#097-tests-tests7-rs" class="headerlink" title="097 tests&#x2F;tests7.rs"></a>097 tests&#x2F;tests7.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// When building packages, some dependencies can neither be imported in</span></span><br><span class="line"><span class="comment">// `Cargo.toml` nor be directly linked; some preprocesses varies from code</span></span><br><span class="line"><span class="comment">// generation to set-up package-specific configurations.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Cargo does not aim to replace other build tools, but it does integrate</span></span><br><span class="line"><span class="comment">// with them with custom build scripts called `build.rs`. This file is</span></span><br><span class="line"><span class="comment">// usually placed in the root of the project, while in this case the same</span></span><br><span class="line"><span class="comment">// directory of this exercise.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// It can be used to:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ## Building a bundled C library.</span></span><br><span class="line"><span class="comment">// ## Finding a C library on the host system.</span></span><br><span class="line"><span class="comment">// ## Generating a Rust module from a specification.</span></span><br><span class="line"><span class="comment">// ## Performing any platform-specific configuration needed for the crate.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// When setting up configurations, we can `println!` in the build script</span></span><br><span class="line"><span class="comment">// to tell Cargo to follow some instructions. The generic format is:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     println!(&quot;cargo:&#123;&#125;&quot;, your_command_in_string);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Please see the official Cargo book about build scripts for more</span></span><br><span class="line"><span class="comment">// information:</span></span><br><span class="line"><span class="comment">// https://doc.rust-lang.org/cargo/reference/build-scripts.html</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In this exercise, we look for an environment variable and expect it to</span></span><br><span class="line"><span class="comment">// fall in a range. You can look into the testcase to find out the details.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// You should NOT modify this file. Modify `build.rs` in the same directory to pass this exercise.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint tests7` or use the `hint` watch subcommand for a</span></span><br><span class="line"><span class="comment">// hint.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// std::env::set_var(&quot;TEST_FOO&quot;, timestamp.to_string());</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_success</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">timestamp</span> = std::time::SystemTime::<span class="title function_ invoke__">now</span>()</span><br><span class="line">            .<span class="title function_ invoke__">duration_since</span>(std::time::UNIX_EPOCH)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">            .<span class="title function_ invoke__">as_secs</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">s</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;TEST_FOO&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">e</span>: <span class="type">u64</span> = s.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">assert!</span>(timestamp &gt;= e &amp;&amp; timestamp &lt; e + <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="098-tests-tests8-rs"><a href="#098-tests-tests8-rs" class="headerlink" title="098 tests&#x2F;tests8.rs"></a>098 tests&#x2F;tests8.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This execrise shares `build.rs` with the previous exercise.</span></span><br><span class="line"><span class="comment">// You need to add some code to `build.rs` to make both this exercise and</span></span><br><span class="line"><span class="comment">// the previous one work.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Execute `rustlings hint tests8` or use the `hint` watch subcommand for a</span></span><br><span class="line"><span class="comment">// hint.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_success</span>() &#123;</span><br><span class="line">        <span class="meta">#[cfg(feature = <span class="string">&quot;pass&quot;</span>)]</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;no cfg set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="099-tests-tests9-rs"><a href="#099-tests-tests9-rs" class="headerlink" title="099 tests&#x2F;tests9.rs"></a>099 tests&#x2F;tests9.rs</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Rust is highly capable of sharing FFI interfaces with C/C++ and other statically compiled</span></span><br><span class="line"><span class="comment">// languages, and it can even link within the code itself! It makes it through the extern</span></span><br><span class="line"><span class="comment">// block, just like the code below.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The short string after the `extern` keyword indicates which ABI the externally imported</span></span><br><span class="line"><span class="comment">// function would follow. In this exercise, &quot;Rust&quot; is used, while other variants exists like</span></span><br><span class="line"><span class="comment">// &quot;C&quot; for standard C ABI, &quot;stdcall&quot; for the Windows ABI.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The externally imported functions are declared in the extern blocks, with a semicolon to</span></span><br><span class="line"><span class="comment">// mark the end of signature instead of curly braces. Some attributes can be applied to those</span></span><br><span class="line"><span class="comment">// function declarations to modify the linking behavior, such as #[link_name = &quot;..&quot;] to</span></span><br><span class="line"><span class="comment">// modify the actual symbol names.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If you want to export your symbol to the linking environment, the `extern` keyword can</span></span><br><span class="line"><span class="comment">// also be marked before a function definition with the same ABI string note. The default ABI</span></span><br><span class="line"><span class="comment">// for Rust functions is literally &quot;Rust&quot;, so if you want to link against pure Rust functions,</span></span><br><span class="line"><span class="comment">// the whole extern term can be omitted.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Rust mangles symbols by default, just like C++ does. To suppress this behavior and make</span></span><br><span class="line"><span class="comment">// those functions addressable by name, the attribute #[no_mangle] can be applied.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In this exercise, your task is to make the testcase able to call the `my_demo_function` in</span></span><br><span class="line"><span class="comment">// module Foo. the `my_demo_function_alias` is an alias for `my_demo_function`, so the two</span></span><br><span class="line"><span class="comment">// line of code in the testcase should call the same function.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// You should NOT modify any existing code except for adding two lines of attributes.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;Rust&quot;</span> &#123;</span><br><span class="line">    <span class="meta">#[no_mangle]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">my_demo_function</span>(a: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[no_mangle]</span></span><br><span class="line">    <span class="meta">#[link_name = <span class="string">&quot;my_demo_function&quot;</span>]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">my_demo_function_alias</span>(a: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> Foo &#123;</span><br><span class="line">    <span class="comment">// No `extern` equals `extern &quot;Rust&quot;`.</span></span><br><span class="line">    <span class="meta">#[no_mangle]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">my_demo_function</span>(a: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">        a</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_success</span>() &#123;</span><br><span class="line">        <span class="comment">// The externally imported functions are UNSAFE by default</span></span><br><span class="line">        <span class="comment">// because of untrusted source of other languages. You may</span></span><br><span class="line">        <span class="comment">// wrap them in safe Rust APIs to ease the burden of callers.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// SAFETY: We know those functions are aliases of a safe</span></span><br><span class="line">        <span class="comment">// Rust function.</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">my_demo_function</span>(<span class="number">123</span>);</span><br><span class="line">            <span class="title function_ invoke__">my_demo_function_alias</span>(<span class="number">456</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考：-1"><a href="#参考：-1" class="headerlink" title="参考："></a>参考：</h2><ul>
<li><a target="_blank" rel="noopener" href="https://rust-book.junmajinlong.com/">https://rust-book.junmajinlong.com</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Roboduster/p/17781712.html">https://www.cnblogs.com/Roboduster/p/17781712.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43840665/article/details/130065993">https://blog.csdn.net/qq_43840665/article/details/130065993</a></li>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/rust/rust-tutorial.html">https://www.runoob.com/rust/rust-tutorial.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://goversion.github.io/2025/08/31/os5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhou tao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/31/os5/" class="post-title-link" itemprop="url">os5</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-31 17:44:26 / 修改时间：23:12:23" itemprop="dateCreated datePublished" datetime="2025-08-31T17:44:26+08:00">2025-08-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <head>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
</head>


<h1 id="OS-第五章：进程"><a href="#OS-第五章：进程" class="headerlink" title="OS 第五章：进程"></a>OS 第五章：进程</h1><h2 id="1-为什么要有进程？"><a href="#1-为什么要有进程？" class="headerlink" title="1 为什么要有进程？"></a>1 为什么要有进程？</h2><p>在前面的章节里，内核和用户程序的交互比较有限，仅是加载一下 app 就结束了。内核还缺乏对用户程序的<strong>抓手</strong>。</p>
<p>因此，为了描述进程，我们需要创建一些数据结构，即进程控制块 PCB，便于控制程序。从资源角度来看，进程是程序执行中占用资源的集合。</p>
<h2 id="2-四个重要的系统调用"><a href="#2-四个重要的系统调用" class="headerlink" title="2 四个重要的系统调用"></a>2 四个重要的系统调用</h2><p>首先要讲几个系统调用的实现</p>
<h3 id="2-1-fork"><a href="#2-1-fork" class="headerlink" title="2.1 fork"></a>2.1 fork</h3><p><img src="/./pics/5_01.png"></p>
<p>fork 就是复制一份，新的一份就是子进程。</p>
<p>fork 返回 0 时是子进程，返回不为 0 时是子进程的 pid。</p>
<h3 id="2-2-exec"><a href="#2-2-exec" class="headerlink" title="2.2 exec"></a>2.2 exec</h3><p>看上图，在代码段，把当前的代码填充进去。</p>
<h3 id="2-3-exit"><a href="#2-3-exit" class="headerlink" title="2.3 exit"></a>2.3 exit</h3><p>进程结束时调用 exit，完成进程的第一次资源的回收，然后将该进程标识为<strong>僵尸进程</strong>，由父进程使用 wait 来收拾残局，进行第二次资源的回收。</p>
<p>然后准备向父进程发送返回值之前，先检查父进程是否存活。</p>
<p>如果存在，父进程执行回收。</p>
<p>如果不存在，把本进程的父进程设为 init 进程，然后 init 进程执行回收。一般 init 进程不会做很复杂的事，主要做回收。</p>
<h3 id="2-4-wait"><a href="#2-4-wait" class="headerlink" title="2.4 wait"></a>2.4 wait</h3><p>父进程等待子进程的结束。</p>
<p>子进程要退出时，通过 exit 向父进程发送返回值，父进程通过 wait 接受。</p>
<h2 id="3-进程实现"><a href="#3-进程实现" class="headerlink" title="3 进程实现"></a>3 进程实现</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Directly save the contents that will not change during running</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TaskControlBlock</span> &#123;</span><br><span class="line">    <span class="comment">// Immutable</span></span><br><span class="line">    <span class="comment">/// Process identifier</span></span><br><span class="line">    <span class="keyword">pub</span> pid: PidHandle,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Kernel stack corresponding to PID</span></span><br><span class="line">    <span class="keyword">pub</span> kernel_stack: KernelStack,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Mutable</span></span><br><span class="line">    inner: UPSafeCell&lt;TaskControlBlockInner&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TaskControlBlockInner</span> &#123;</span><br><span class="line">    <span class="comment">/// The physical page number of the frame where the trap context is placed</span></span><br><span class="line">    <span class="keyword">pub</span> trap_cx_ppn: PhysPageNum,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Application data can only appear in areas</span></span><br><span class="line">    <span class="comment">/// where the application address space is lower than base_size</span></span><br><span class="line">    <span class="keyword">pub</span> base_size: <span class="type">usize</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Save task context</span></span><br><span class="line">    <span class="keyword">pub</span> task_cx: TaskContext,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Maintain the execution status of the current process</span></span><br><span class="line">    <span class="keyword">pub</span> task_status: TaskStatus,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Application address space</span></span><br><span class="line">    <span class="keyword">pub</span> memory_set: MemorySet,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Parent process of the current process.</span></span><br><span class="line">    <span class="comment">/// Weak will not affect the reference count of the parent</span></span><br><span class="line">    <span class="keyword">pub</span> parent: <span class="type">Option</span>&lt;Weak&lt;TaskControlBlock&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A vector containing TCBs of all child processes of the current process</span></span><br><span class="line">    <span class="keyword">pub</span> children: <span class="type">Vec</span>&lt;Arc&lt;TaskControlBlock&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// It is set when active exit or execution error occurs</span></span><br><span class="line">    <span class="keyword">pub</span> exit_code: <span class="type">i32</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Heap bottom</span></span><br><span class="line">    <span class="keyword">pub</span> heap_bottom: <span class="type">usize</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Program break</span></span><br><span class="line">    <span class="keyword">pub</span> program_brk: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-几个系统调用的实现"><a href="#4-几个系统调用的实现" class="headerlink" title="4 几个系统调用的实现"></a>4 几个系统调用的实现</h2><h3 id="4-1-fork-的实现"><a href="#4-1-fork-的实现" class="headerlink" title="4.1 fork 的实现"></a>4.1 fork 的实现</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_fork</span>() <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">current_task</span> = <span class="title function_ invoke__">current_task</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_task</span> = current_task.fork();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_pid</span> = new_task.pid.<span class="number">0</span>;</span><br><span class="line">    <span class="comment">// modify trap context of new_task, because it returns immediately after switching</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">trap_cx</span> = new_task.<span class="title function_ invoke__">inner_exclusive_access</span>().<span class="title function_ invoke__">get_trap_cx</span>();</span><br><span class="line">    <span class="comment">// we do not have to move to next instruction since we have done it before</span></span><br><span class="line">    <span class="comment">// for child process, fork returns 0</span></span><br><span class="line">    trap_cx.x[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// add new task to scheduler</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把这个进程放在就绪队列里。</span></span><br><span class="line">    <span class="title function_ invoke__">add_task</span>(new_task);</span><br><span class="line">    new_pid <span class="keyword">as</span> <span class="type">isize</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">fork</span>(<span class="keyword">self</span>: &amp;Arc&lt;<span class="keyword">Self</span>&gt;) <span class="punctuation">-&gt;</span> Arc&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// ---- access parent PCB exclusively</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">parent_inner</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">inner_exclusive_access</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制地址空间</span></span><br><span class="line">    <span class="comment">// copy user space(include trap context)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">memory_set</span> = MemorySet::<span class="title function_ invoke__">from_existed_user</span>(&amp;parent_inner.memory_set);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">trap_cx_ppn</span> = memory_set</span><br><span class="line">        .<span class="title function_ invoke__">translate</span>(VirtAddr::<span class="title function_ invoke__">from</span>(TRAP_CONTEXT).<span class="title function_ invoke__">into</span>())</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        .<span class="title function_ invoke__">ppn</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// alloc a pid and a kernel stack in kernel space</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pid_handle</span> = <span class="title function_ invoke__">pid_alloc</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">kernel_stack</span> = KernelStack::<span class="title function_ invoke__">new</span>(&amp;pid_handle);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">kernel_stack_top</span> = kernel_stack.<span class="title function_ invoke__">get_top</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">task_control_block</span> = Arc::<span class="title function_ invoke__">new</span>(TaskControlBlock &#123;</span><br><span class="line">        pid: pid_handle,</span><br><span class="line">        kernel_stack,</span><br><span class="line">        inner: <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            UPSafeCell::<span class="title function_ invoke__">new</span>(TaskControlBlockInner &#123;</span><br><span class="line">                trap_cx_ppn,</span><br><span class="line">                base_size: parent_inner.base_size,</span><br><span class="line">                task_cx: TaskContext::<span class="title function_ invoke__">goto_trap_return</span>(kernel_stack_top),</span><br><span class="line">                task_status: TaskStatus::Ready,</span><br><span class="line">                memory_set,</span><br><span class="line">                parent: <span class="title function_ invoke__">Some</span>(Arc::<span class="title function_ invoke__">downgrade</span>(<span class="keyword">self</span>)),</span><br><span class="line">                children: <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">                exit_code: <span class="number">0</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// add child</span></span><br><span class="line">    parent_inner.children.<span class="title function_ invoke__">push</span>(task_control_block.<span class="title function_ invoke__">clone</span>());</span><br><span class="line">    <span class="comment">// modify kernel_sp in trap_cx</span></span><br><span class="line">    <span class="comment">// **** access children PCB exclusively</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">trap_cx</span> = task_control_block.<span class="title function_ invoke__">inner_exclusive_access</span>().<span class="title function_ invoke__">get_trap_cx</span>();</span><br><span class="line">    trap_cx.kernel_sp = kernel_stack_top;</span><br><span class="line">    <span class="comment">// return</span></span><br><span class="line">    task_control_block</span><br><span class="line">    <span class="comment">// ---- release parent PCB automatically</span></span><br><span class="line">    <span class="comment">// **** release children PCB automatically</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-exec-的实现"><a href="#4-2-exec-的实现" class="headerlink" title="4.2 exec 的实现"></a>4.2 exec 的实现</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_exec</span>(path: *<span class="keyword">const</span> <span class="type">u8</span>) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">token</span> = <span class="title function_ invoke__">current_user_token</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">path</span> = <span class="title function_ invoke__">translated_str</span>(token, path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 path 拿到 app 的数据，</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(data) = <span class="title function_ invoke__">get_app_data_by_name</span>(path.<span class="title function_ invoke__">as_str</span>()) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">task</span> = <span class="title function_ invoke__">current_task</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        task.<span class="title function_ invoke__">exec</span>(data);</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">exec</span>(&amp;<span class="keyword">self</span>, elf_data: &amp;[<span class="type">u8</span>]) &#123;</span><br><span class="line">    <span class="comment">// memory_set with elf program headers/trampoline/trap context/user stack</span></span><br><span class="line">    <span class="keyword">let</span> (memory_set, user_sp, entry_point) = MemorySet::<span class="title function_ invoke__">from_elf</span>(elf_data);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">trap_cx_ppn</span> = memory_set</span><br><span class="line">        .<span class="title function_ invoke__">translate</span>(VirtAddr::<span class="title function_ invoke__">from</span>(TRAP_CONTEXT).<span class="title function_ invoke__">into</span>())</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        .<span class="title function_ invoke__">ppn</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// **** access inner exclusively</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">inner</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">inner_exclusive_access</span>();</span><br><span class="line">    <span class="comment">// substitute memory_set</span></span><br><span class="line">    inner.memory_set = memory_set;</span><br><span class="line">    <span class="comment">// update trap_cx ppn</span></span><br><span class="line">    inner.trap_cx_ppn = trap_cx_ppn;</span><br><span class="line">    <span class="comment">// initialize base_size</span></span><br><span class="line">    inner.base_size = user_sp;</span><br><span class="line">    <span class="comment">// initialize trap_cx</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">trap_cx</span> = inner.<span class="title function_ invoke__">get_trap_cx</span>();</span><br><span class="line">    *trap_cx = TrapContext::<span class="title function_ invoke__">app_init_context</span>(</span><br><span class="line">        entry_point,</span><br><span class="line">        user_sp,</span><br><span class="line">        KERNEL_SPACE.<span class="title function_ invoke__">exclusive_access</span>().<span class="title function_ invoke__">token</span>(),</span><br><span class="line">        <span class="keyword">self</span>.kernel_stack.<span class="title function_ invoke__">get_top</span>(),</span><br><span class="line">        trap_handler <span class="keyword">as</span> <span class="type">usize</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// **** release inner automatically</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-waitpid-的实现"><a href="#4-3-waitpid-的实现" class="headerlink" title="4.3 waitpid 的实现"></a>4.3 waitpid 的实现</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// If there is not a child process whose pid is same as given, return -1.</span></span><br><span class="line"><span class="comment">/// Else if there is a child process but it is still running, return -2.</span></span><br><span class="line">                <span class="comment">// pid 我要等待子进程的 pid，exit_code_ptr 子进程的返回值</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_waitpid</span>(pid: <span class="type">isize</span>, exit_code_ptr: *<span class="keyword">mut</span> <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">task</span> = <span class="title function_ invoke__">current_task</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="comment">// find a child process</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---- access current TCB exclusively</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">inner</span> = task.<span class="title function_ invoke__">inner_exclusive_access</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首先去偏历 children 的成员变量，找 pid 和它一样的。</span></span><br><span class="line">    <span class="keyword">if</span> !inner</span><br><span class="line">        .children</span><br><span class="line">        .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">any</span>(|p| pid == -<span class="number">1</span> || pid <span class="keyword">as</span> <span class="type">usize</span> == p.<span class="title function_ invoke__">getpid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 没有就退出。</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// ---- release current PCB</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// is_zombie 看这个进程是否是退出状态。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pair</span> = inner.children.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>().<span class="title function_ invoke__">find</span>(|(_, p)| &#123;</span><br><span class="line">        <span class="comment">// ++++ temporarily access child PCB lock exclusively</span></span><br><span class="line">        p.<span class="title function_ invoke__">inner_exclusive_access</span>().<span class="title function_ invoke__">is_zombie</span>() &amp;&amp; (pid == -<span class="number">1</span> || pid <span class="keyword">as</span> <span class="type">usize</span> == p.<span class="title function_ invoke__">getpid</span>())</span><br><span class="line">        <span class="comment">// ++++ release child PCB</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>((idx, _)) = pair &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child</span> = inner.children.<span class="title function_ invoke__">remove</span>(idx);</span><br><span class="line">        <span class="comment">// confirm that child will be deallocated after removing from children list</span></span><br><span class="line">        <span class="built_in">assert_eq!</span>(Arc::<span class="title function_ invoke__">strong_count</span>(&amp;child), <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">found_pid</span> = child.<span class="title function_ invoke__">getpid</span>();</span><br><span class="line">        <span class="comment">// ++++ temporarily access child TCB exclusively</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取返回码。</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">exit_code</span> = child.<span class="title function_ invoke__">inner_exclusive_access</span>().exit_code;</span><br><span class="line">        <span class="comment">// ++++ release child PCB</span></span><br><span class="line">        *<span class="title function_ invoke__">translated_refmut</span>(inner.memory_set.<span class="title function_ invoke__">token</span>(), exit_code_ptr) = exit_code;</span><br><span class="line">        found_pid <span class="keyword">as</span> <span class="type">isize</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        -<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ---- release current PCB lock automatically</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://goversion.github.io/2025/08/31/os4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhou tao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/31/os4/" class="post-title-link" itemprop="url">os4</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-31 17:44:24 / 修改时间：23:19:04" itemprop="dateCreated datePublished" datetime="2025-08-31T17:44:24+08:00">2025-08-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <head>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
</head>


<h1 id="OS-第四章：地址空间的抽象-—-从-va-到-pa"><a href="#OS-第四章：地址空间的抽象-—-从-va-到-pa" class="headerlink" title="OS 第四章：地址空间的抽象 —- 从 va 到 pa"></a>OS 第四章：地址空间的抽象 —- 从 va 到 pa</h1><p>回顾分时系统，每个 app 要和 kernel 约好地址空间，每一个 app 地址都是事先写死的，这就存在诸多不便。于是引入对地址空间的抽象—-虚拟地址。</p>
<p>本章原理上比较简单，但在代码实现上颇有难度，是学习 OS 路上的一道槛。一方面，需要做一些铺垫性的准备工作，另一方面，正式的功能步骤也比较多，下面按功能分解如下：</p>
<ul>
<li>第一个准备工作—-动态分配。因为 rust 没有标准库的支持，缺少在 heap 上对内存动态分配的功能，该功能需要补上，rust 才能正常使用一些  heap 上对内存动态分配的数据结构。</li>
<li>第二个准备工作—-物理页帧管理。</li>
<li>第三个准备工作—-CPU 为页表做的硬件准备 MMU,TLB。</li>
<li>正式四步之第一步—-映射管理。管理 <code>(ekernel 0x80000000, MEMORY_END 0x80800000)</code> 区间的内存。</li>
<li>正式四步之第二步—-把内核映射起来。</li>
<li>正式四步之第三步—-把应用映射起来。</li>
<li>正式四步之第四步—-切换的问题。</li>
</ul>
<p>TODO:</p>
<ul>
<li>把数据结构的宏观图画出来。</li>
<li>阅读源代码。</li>
<li>单步调试。</li>
<li>查一下RAII 思想的相关背景？<blockquote>
<p>将某种资源的生命周期与一个变量绑定的这种 RAII 的思想无处不在。</p>
</blockquote>
</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/528896132">https://zhuanlan.zhihu.com/p/528896132</a></li>
<li><a target="_blank" rel="noopener" href="https://hangx-ma.github.io/2023/07/04/rcore-note-ch4.html">https://hangx-ma.github.io/2023/07/04/rcore-note-ch4.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/YuanZiming/p/14561382.html">https://www.cnblogs.com/YuanZiming/p/14561382.html</a></li>
</ul>
<h2 id="0-总览"><a href="#0-总览" class="headerlink" title="0 总览"></a>0 总览</h2><p><img src="/./pics/4_13.png"></p>
<h2 id="1-第一个准备工作—-动态分配"><a href="#1-第一个准备工作—-动态分配" class="headerlink" title="1 第一个准备工作—-动态分配"></a>1 第一个准备工作—-动态分配</h2><p>因为此时 kernel 运行在 no_std 环境下，并没有动态内存分配的功能，此时，就需要我们自己实现<code>动态内存分配器</code>。在内核最开始的镜像中定义了一个较大的静态内存区域，我们对这片区域进行一个动态管理。rust 的一些  Box &#x2F; Vec &#x2F;BTreeMap &#x2F; alloc 库的大多数数据结构需要堆的支持。有了<code>动态内存分配器</code>，rust 的这些数据结构才会正常工作。</p>
<p>rust 有 treat</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">alloc</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">dealloc</span></span><br></pre></td></tr></table></figure>

<p>我们只需要加上定义全局的，实现了全局接口的数据结构。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[global_allocator]</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>看 rcore kernel 初始化堆的代码：</p>
<p>看 main.rs mm::init() -&gt; mod.rs init() -&gt; heap_allocator::init_heap()</p>
<h4 id="1-1-具体编程实现"><a href="#1-1-具体编程实现" class="headerlink" title="1.1 具体编程实现"></a>1.1 具体编程实现</h4><p>在上一章的代码基础上添加下面内容。</p>
<ul>
<li><p>在 os&#x2F;Cargo.toml 中引入:<br>buddy_system_allocator &#x3D; “0.6”</p>
</li>
<li><p>在os&#x2F;src&#x2F;main.rs中引入.</p>
</li>
</ul>
<p>extern crate alloc;</p>
<ul>
<li>创建 os&#x2F;src&#x2F;mm&#x2F;heap_allocator.rs</li>
</ul>
<p>alloc 库需要我们提供给它一个<code>全局的动态内存分配器</code>，它会利用该分配器来管理堆空间，从而使得与堆相关的智能指针或容器数据结构可以正常工作。具体而言，我们的<code>动态内存分配器</code>需要实现它提供的 GlobalAlloc Trait。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> buddy_system_allocator::LockedHeap;</span><br><span class="line"><span class="keyword">use</span> crate::config::KERNEL_HEAP_SIZE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[global_allocator]</span></span><br><span class="line"><span class="keyword">static</span> HEAP_ALLOCATOR: LockedHeap = LockedHeap::<span class="title function_ invoke__">empty</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> HEAP_SPACE: [<span class="type">u8</span>; KERNEL_HEAP_SIZE] = [<span class="number">0</span>; KERNEL_HEAP_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init_heap</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        HEAP_ALLOCATOR</span><br><span class="line">            .<span class="title function_ invoke__">lock</span>()</span><br><span class="line">            .<span class="title function_ invoke__">init</span>(HEAP_SPACE.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> <span class="type">usize</span>, KERNEL_HEAP_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[alloc_error_handler]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">handle_alloc_error</span>(layout: core::alloc::Layout) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;Heap allocation error, layout = &#123;:?&#125;&quot;</span>, layout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建测试函数</span></span><br><span class="line"><span class="meta">#[allow(unused)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">heap_test</span>() &#123;</span><br><span class="line">    <span class="keyword">use</span> alloc::boxed::<span class="type">Box</span>;</span><br><span class="line">    <span class="keyword">use</span> alloc::vec::<span class="type">Vec</span>;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">sbss</span>();</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">ebss</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bss_range</span> = sbss <span class="keyword">as</span> <span class="type">usize</span>..ebss <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(*a, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">assert!</span>(bss_range.<span class="title function_ invoke__">contains</span>(&amp;(a.<span class="title function_ invoke__">as_ref</span>() <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span>)));</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(a);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span>: <span class="type">Vec</span>&lt;<span class="type">usize</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">500</span> &#123;</span><br><span class="line">        v.<span class="title function_ invoke__">push</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">500</span> &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(v[i], i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">assert!</span>(bss_range.<span class="title function_ invoke__">contains</span>(&amp;(v.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> <span class="type">usize</span>)));</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(v);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;heap_test passed!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert_eq!(*a, 5);</span><br><span class="line">assert!(bss_range.contains(&amp;(a.as_ref() as *const _ as usize)));</span><br></pre></td></tr></table></figure>
<p>判断a的值是否为5</p>
<p>判断a的指针是否在bss的范围内</p>
<p>接下来的操作则是创建了一个Vec容器，然后储存了0..500的值进去，并且分别执行上述对a的断言判断。</p>
<h2 id="2-第二个准备工作—-CPU-为页表做的硬件准备-MMU-TLB"><a href="#2-第二个准备工作—-CPU-为页表做的硬件准备-MMU-TLB" class="headerlink" title="2 第二个准备工作—-CPU 为页表做的硬件准备 MMU,TLB"></a>2 第二个准备工作—-CPU 为页表做的硬件准备 MMU,TLB</h2><h4 id="2-1-三级页表"><a href="#2-1-三级页表" class="headerlink" title="2.1 三级页表"></a>2.1 三级页表</h4><p>由于虚拟页号有 $2^{39-12&#x3D;27}$ 种，每个页表项使用 8 字节，则每个页表需要消耗掉 $ 2^{27} * 8 &#x3D; 2^{30} &#x3D; 1GB $ 内存！这显然不可行。</p>
<p>多级页表的设计类似于数据结构中的字典树，使用 3 个 9 位的页号分段进行索引。</p>
<p><code>aaaaaaaaa bbbbbbbbb ccccccccc</code></p>
<p>使用 aaaaaaaaa 在根页表中查到对应的物理地址 A ，在 A 处的二级页表中查询 bbbbbbbbb ，以此类推，直到查询到叶子节点。</p>
<h4 id="2-2-CPU-为页表做的硬件准备—-MMU-TLB"><a href="#2-2-CPU-为页表做的硬件准备—-MMU-TLB" class="headerlink" title="2.2 CPU 为页表做的硬件准备—-MMU, TLB"></a>2.2 CPU 为页表做的硬件准备—-MMU, TLB</h4><p>前面两章，app 在编写时是写死的，kernel 在加载 app 也需要按约定的地址加载。</p>
<p>有了地址空间的抽象，需要两个硬件的辅助：</p>
<ol>
<li>MMU: memory management unit：它的功能是将 虚拟地址 -&gt; 物理地址。<br>为每个 app 做转换，<br>硬件提供一些 register，软件可以对 register 进设置，来控制 MMU 当前为哪个应用的转换规则。</li>
</ol>
<p>有了 mmu ，硬件帮我们做转换，每次做转换，每次需读内存，为了进一步降低开销，CPU 还提供了 TLB。</p>
<ol start="2">
<li>TLB: translation lookaside buffer 快表，<code>TLB 就是一张表</code>，是 mmu 在 CPU 上的一个 cache。<ul>
<li><p>存储 virtual address -&gt; physical address 的转换关系。<br> 当 MMU 做了一次转换之后，TLB 就把这个转换关系存在自己的表里。<br> 当下次需要使用时，直接先在 TLB 里查找，如果命中则结束。如果没有找到，则需要到 MMU 里找。</p>
</li>
<li><p>当切换到不同 app 时，TLB 是需要清空的，</p>
</li>
</ul>
</li>
</ol>
<h4 id="2-3-上面有了概念，硬件为‘映射’做了哪些事呢？"><a href="#2-3-上面有了概念，硬件为‘映射’做了哪些事呢？" class="headerlink" title="2.3 上面有了概念，硬件为‘映射’做了哪些事呢？"></a>2.3 上面有了概念，硬件为‘映射’做了哪些事呢？</h4><blockquote>
<p>SV39 仅仅使用低39位，高25位必须与第38位保持一致，才能通过MMU的检查（硬件实现），换句话说，只有 0 —— 0000003FFFFFFFFF（低256GB）和 FFFFFC000000000 —— FFFFFFFFFFFFFFFF（高256G）才能通过MMU检查。</p>
</blockquote>
<blockquote>
<blockquote>
<p>这里，对 “ 高25位必须与第38位保持一致 ” 不理解?</p>
</blockquote>
</blockquote>
<p>如何从 39 的<code>虚拟地址</code>转换到<code>物理地址</code>的？</p>
<p><img src="/./pics/4_04.png"></p>
<ul>
<li>虚拟地址被分为39位，意味着虚拟地址空间的可以达到$2^{39}&#x3D;512GB$。其中低12位是页内的偏移量, 高27位可以分为3份, 每份9位, 表示的是在各级页表中的索引。</li>
<li>物理地址的低12位表示一个页内的偏移, 12-55位表示了页号。</li>
</ul>
<p><img src="/./pics/4_05.png"></p>
<p>注意上图，L2&#x2F;L1&#x2F;L0 都是索引，是索引，是索引。</p>
<blockquote>
<p>疑问：39 位的 va 映射为 44 的 pa，是不是有点毛病？</p>
</blockquote>
<h2 id="3-第三个准备工作—-物理页帧分配器-StackFrameAllocator"><a href="#3-第三个准备工作—-物理页帧分配器-StackFrameAllocator" class="headerlink" title="3 第三个准备工作—-物理页帧分配器 StackFrameAllocator"></a>3 第三个准备工作—-物理页帧分配器 StackFrameAllocator</h2><ul>
<li>物理内存的范围是什么？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-riscv64 \</span><br><span class="line">  -machine virt \</span><br><span class="line">  -machine dumpdtb=qemu.dtb \</span><br><span class="line">  -nographic \</span><br><span class="line">  -bios ../../rustsbi-qemu.bin \</span><br><span class="line">  -device loader,file=target/riscv64gc-unknown-none-elf/release/os.bin,addr=0x80200000</span><br><span class="line"></span><br><span class="line">dtc -I dtb -O dts qemu.dtb &gt; qemu.dts</span><br></pre></td></tr></table></figure>
<p>我们可以看到 qemu-system-riscv64 模拟出的计算机，它的内存是 128M。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">memory@80000000 &#123;</span><br><span class="line">    device_type = &quot;memory&quot;;</span><br><span class="line">    reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>src&#x2F;mm&#x2F;frame_allocator.rs<br>开启分页后，首先把物理内存管理起来，管理的对象是内核空间以外的物理空间。<br>先找到了 <code>ekernel 的最后的地址</code>，到 MEMORY_END 之间都当作空闲的页进行管理。</p>
<p>rCore 使用了最简单的<code>栈式物理页帧管理策略</code> struct StackFrameAllocator 实现 FRAME_ALLOCATOR， 并开放给其他内核模块两个用以分配和回收物理地址 frame 的接口： frame_alloc 以及 frame_dealloc。 值得注意的是 frame_alloc 返回的类型是封装 PhysPageNum 的 FrameTracker 类型， 该类型实现了 Drop Trait， 这是一种 RAII 的思想， 当 FrameTracker 的声明周期结束， 其包裹的 PhysPageNum 能通过编译器自动回收到 FRAME_ALLOCATOR。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init_frame_allocator</span>() &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">ekernel</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    FRAME_ALLOCATOR.<span class="title function_ invoke__">exclusive_access</span>().<span class="title function_ invoke__">init</span>(</span><br><span class="line">        PhysAddr::<span class="title function_ invoke__">from</span>(ekernel <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">ceil</span>(),</span><br><span class="line">        PhysAddr::<span class="title function_ invoke__">from</span>(MEMORY_END).<span class="title function_ invoke__">floor</span>(),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了让内核能访问实际的物理地址， rCore 设计了三种粒度的访问方式： 基于 PTE， 基于 Bytes， 基于变量类型。 至此， 物理地址空间的分配以及访问的框架已经建成， 后续需要做的就是构建虚拟地址与物理地址映射的 页表(Page Table)。</p>
<h2 id="4-正式四步之第一步—-空间抽象的数据结构-PageTable-MapArea-MemorySet"><a href="#4-正式四步之第一步—-空间抽象的数据结构-PageTable-MapArea-MemorySet" class="headerlink" title="4 正式四步之第一步—-空间抽象的数据结构 PageTable &#x2F; MapArea &#x2F; MemorySet"></a>4 正式四步之第一步—-空间抽象的数据结构 PageTable &#x2F; MapArea &#x2F; MemorySet</h2><h4 id="4-1-页表-Page-Table"><a href="#4-1-页表-Page-Table" class="headerlink" title="4.1 页表 Page Table"></a>4.1 页表 Page Table</h4><p>上面把物理页管理起来了，现在开始构建结构 PageTable，它负责建立好 va 到 pa 的关系，逐步建立好<code>三级页表</code>的过程。<br>PageTable 的数据结构的设计包括了定位 Page Table 的 root_ppn 以及 Page Table 中包含的各个 PTE 项 frames。<br>因此 struct PageTable 初始化的流程就很自然能想得出，每个 PageTable 都需要向 frame allocator 先申请一个物理页帧将其 PPN 作为 root_ppn 唯一标识。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// page table structure</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    root_ppn: PhysPageNum,</span><br><span class="line">    frames: <span class="type">Vec</span>&lt;FrameTracker&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>root_ppn 保存根节点的物理页号，它作为<code>页表唯一的区分标志</code>。</p>
<p>frames 保存了页表所有的节点(包括根节点) 所在的物理页帧。(<code>RAII</code> 自动回收所有物理页帧)</p>
<p>并且，它为 PageTable 这个结构实现了两个函数，map 和 unmap。map 建立映射表，unmap 就是回收映射表。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">map</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum, ppn: PhysPageNum, flags: PTEFlags);</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unmap</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>估计是为了让 root_ppn 和 frames 的指向和含义统一才把 PTE 命名为 frame， 个人感觉直接用 PTE 会清晰很多。 这里 rCore 又提及 RAII 的思想， frames 内部变量通过 Vec 数据结构绑定 FrameTracker， 可以保证声明周期结束后对 FrameTracker 的内存自动回收。</p>
</blockquote>
<blockquote>
<p>什么是节点？</p>
</blockquote>
<h4 id="4-2-建立-VA-与-PA-的映射关系"><a href="#4-2-建立-VA-与-PA-的映射关系" class="headerlink" title="4.2 建立 VA 与 PA 的映射关系"></a>4.2 建立 VA 与 PA 的映射关系</h4><p>Page Table 必然是动态变化的， 程序运行的时候会通过 <code>Page Fault Trap</code> 来实现对内存页的按需分配。 当我们知道虚拟地址空间的某个 VA 的时候， 需要通过前述的 Page Table 找到或建立一个关于物理页帧映射。rCore 提供了两个基础函数 <code>find_pte_create</code> 以及 <code>find_pte</code>， 区别就在于是否在某一级页表的 PTE 未创建时创建一个新的 PTE。</p>
<p>用 map&#x2F;unmap 为当前的 Page Table 增加或删除 PTE。</p>
<p>find_pte_create：实现 map 时，发现有些页表不存在，就申请一个物理页，再建立映射。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    <span class="comment">/// Find PageTableEntry by VirtPageNum, create a frame for a 4KB page table if not exist</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">find_pte_create</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">idxs</span> = vpn.<span class="title function_ invoke__">indexes</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ppn</span> = <span class="keyword">self</span>.root_ppn;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span>: <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">for</span> (i, idx) <span class="keyword">in</span> idxs.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">pte</span> = &amp;<span class="keyword">mut</span> ppn.<span class="title function_ invoke__">get_pte_array</span>()[*idx];</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">2</span> &#123;</span><br><span class="line">                result = <span class="title function_ invoke__">Some</span>(pte);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !pte.<span class="title function_ invoke__">is_valid</span>() &#123;</span><br><span class="line">                <span class="comment">// 发现一个 pte 不存在，就新建一个物理页，</span></span><br><span class="line">                <span class="keyword">let</span> <span class="variable">frame</span> = <span class="title function_ invoke__">frame_alloc</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                *pte = PageTableEntry::<span class="title function_ invoke__">new</span>(frame.ppn, PTEFlags::V);</span><br><span class="line">                <span class="keyword">self</span>.frames.<span class="title function_ invoke__">push</span>(frame);</span><br><span class="line">            &#125;</span><br><span class="line">            ppn = pte.<span class="title function_ invoke__">ppn</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// Find PageTableEntry by VirtPageNum</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">find_pte</span>(&amp;<span class="keyword">self</span>, vpn: VirtPageNum) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">idxs</span> = vpn.<span class="title function_ invoke__">indexes</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ppn</span> = <span class="keyword">self</span>.root_ppn;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span>: <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">for</span> (i, idx) <span class="keyword">in</span> idxs.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">pte</span> = &amp;<span class="keyword">mut</span> ppn.<span class="title function_ invoke__">get_pte_array</span>()[*idx];</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">2</span> &#123;</span><br><span class="line">                result = <span class="title function_ invoke__">Some</span>(pte);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !pte.<span class="title function_ invoke__">is_valid</span>() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ppn = pte.<span class="title function_ invoke__">ppn</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// set the map between virtual page number and physical page number</span></span><br><span class="line">    <span class="meta">#[allow(unused)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">map</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum, ppn: PhysPageNum, flags: PTEFlags) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pte</span>: &amp;<span class="keyword">mut</span> PageTableEntry = <span class="keyword">self</span>.<span class="title function_ invoke__">find_pte_create</span>(vpn).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">assert!</span>(!pte.<span class="title function_ invoke__">is_valid</span>(), <span class="string">&quot;vpn &#123;:?&#125; is mapped before mapping&quot;</span>, vpn);</span><br><span class="line">        *pte = PageTableEntry::<span class="title function_ invoke__">new</span>(ppn, flags | PTEFlags::V);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// remove the map between virtual page number and physical page number</span></span><br><span class="line">    <span class="meta">#[allow(unused)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unmap</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pte</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">find_pte</span>(vpn).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">assert!</span>(pte.<span class="title function_ invoke__">is_valid</span>(), <span class="string">&quot;vpn &#123;:?&#125; is invalid before unmapping&quot;</span>, vpn);</span><br><span class="line">        *pte = PageTableEntry::<span class="title function_ invoke__">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是一些辅助函数，把物理页转换成数组。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">PhysPageNum</span> &#123;</span><br><span class="line">    <span class="comment">/// Get the reference of page table(array of ptes)</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_pte_array</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [PageTableEntry] &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pa</span>: PhysAddr = (*<span class="keyword">self</span>).<span class="title function_ invoke__">into</span>();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(pa.<span class="number">0</span> <span class="keyword">as</span> *<span class="keyword">mut</span> PageTableEntry, <span class="number">512</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>PageTable 只能以页为单位维护 virtual -&gt; physical 映射表，对计算机系统的整个 虚拟&#x2F;物理 的空间并没有一个全局的描述和掌握。</p>
<blockquote>
<p>这一段描述，我仍然不是很理解。PageTable 是维护一个 app 的 (v, p) 映射表吗？还是? 这里理解得不透。</p>
</blockquote>
<blockquote>
<p>老师在讲，有了 pageTable ，为什么还需要 MapArea &#x2F; MemorySet? 这个思路没有讲清楚。</p>
</blockquote>
<blockquote>
<blockquote>
<p>pageTable 是维护一个页的映射，MapArea 是维护一段连续的映射。</p>
</blockquote>
</blockquote>
<ul>
<li>那么 VirtAddr 是如何转换为 PhysPageNum 的呢？</li>
</ul>
<p>VirtAddr -&gt; 调用 VirtAddr::into() 转换为 VirtPageNum -&gt; 用 page_table 的 translate 方法获取 PageTableEntry -&gt; 调用 PageTableEntry::ppn() 获取 PhysPageNum。</p>
<h4 id="4-3-地址空间的管理-MapArea-MemorySet"><a href="#4-3-地址空间的管理-MapArea-MemorySet" class="headerlink" title="4.3 地址空间的管理  MapArea &#x2F; MemorySet"></a>4.3 地址空间的管理  MapArea &#x2F; MemorySet</h4><p>为了对整个 虚拟&#x2F;物理 的空间有一个全局的描述，我们需要进一步抽象。</p>
<p>使用 sruct MapArea 表示一段连续地址的虚拟内存，所有虚拟页面都以相同的方式映射到物理页帧，而 PageTable <code>只维护以页为大小的转换关系</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pub struct MapArea &#123;</span><br><span class="line">    vpn_range: VPNRange,</span><br><span class="line">    data_frames: BTreeMap&lt;VirtPageNum, FrameTracker&gt;,</span><br><span class="line">    map_type: MapType,      //</span><br><span class="line">    map_perm: MapPermission,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>vpn_range: 表明该逻辑段的在虚拟地址的范围以及长度；</li>
<li>data_frames: 既然区分了映射方式， 存储映射关系的数据结构也会不同，data_frames 用于存储 leaf PTE 的 PPN 与其对应的 VPN 之间的关系，仅用在 Framed 映射办法；</li>
<li>map_type: 则表示了虚拟地址和物理地址的映射办法，直接映射 (MapType::Identical) 又或是通过 FRAME_ALLOCATOR 随机分配物理帧 (MapType::Framed)；</li>
<li>map_perm: 就和 Linux 系统的 RWXU 的含义基本接近了；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pub struct MemorySet &#123;</span><br><span class="line">    page_table: PageTable,</span><br><span class="line">    areas: Vec&lt;MapArea&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把所有的 MapArea 和 PageTable 都管理起来，</p>
<p>也就是说，<code>地址空间</code>的实现是通过三个结构 MemorySet、PageTable、MapArea。</p>
<p><img src="/./pics/4_02.jpg"></p>
<p><code>readelf  -a  target/riscv64gc-unknown-none-elf/release/os  | less</code></p>
<p><img src="/./pics/4_09.png"></p>
<p>MemorySet、PageTable、MapArea 就是上图数据的结构体。</p>
<p>如上图，MemorySet 描述多个段，MapArea 是用来描述一个段的概念，它包括多个 frame。</p>
<p><img src="/./pics/4_06.png"></p>
<h2 id="5-正式四步之第二步—-把内核映射起来。-开启分页模式的虚拟地址空间，为内核建立恒等映射"><a href="#5-正式四步之第二步—-把内核映射起来。-开启分页模式的虚拟地址空间，为内核建立恒等映射" class="headerlink" title="5 正式四步之第二步—-把内核映射起来。(开启分页模式的虚拟地址空间，为内核建立恒等映射)"></a>5 正式四步之第二步—-把内核映射起来。(开启分页模式的虚拟地址空间，为内核建立恒等映射)</h2><p><img src="/./pics/4_07.png"></p>
<p><img src="/./pics/4_08.png"></p>
<p><img src="/./pics/4_11.png"></p>
<p><font color="red">为什么这个 trampoline 在 .text 区域放着？ .text 不是低地址吗，trampoline 不是在高地址吗？</font></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="comment">/// The kernel&#x27;s initial memory mapping(kernel address space)</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> KERNEL_SPACE: Arc&lt;UPSafeCell&lt;MemorySet&gt;&gt; =</span><br><span class="line">        Arc::<span class="title function_ invoke__">new</span>(<span class="keyword">unsafe</span> &#123; UPSafeCell::<span class="title function_ invoke__">new</span>(MemorySet::<span class="title function_ invoke__">new_kernel</span>()) &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Without kernel stacks.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new_kernel</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">memory_set</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">new_bare</span>();</span><br><span class="line">    <span class="comment">// map trampoline</span></span><br><span class="line">    memory_set.<span class="title function_ invoke__">map_trampoline</span>();</span><br><span class="line">    <span class="comment">// map kernel sections</span></span><br><span class="line">    info!(<span class="string">&quot;.text [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>, stext <span class="keyword">as</span> <span class="type">usize</span>, etext <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    info!(<span class="string">&quot;.rodata [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>, srodata <span class="keyword">as</span> <span class="type">usize</span>, erodata <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    info!(<span class="string">&quot;.data [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>, sdata <span class="keyword">as</span> <span class="type">usize</span>, edata <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    info!(</span><br><span class="line">        <span class="string">&quot;.bss [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>,</span><br><span class="line">        sbss_with_stack <span class="keyword">as</span> <span class="type">usize</span>, ebss <span class="keyword">as</span> <span class="type">usize</span></span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .text section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (stext <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (etext <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::X,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .rodata section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (srodata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (erodata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .data section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (sdata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (edata <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::W,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping .bss section&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (sbss_with_stack <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (ebss <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::W,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    info!(<span class="string">&quot;mapping physical memory&quot;</span>);</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (ekernel <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MEMORY_END.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::W,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    memory_set</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// os/src/trap/trap.S</span><br><span class="line">    .section .text.trampoline</span><br><span class="line">    .globl __alltraps</span><br><span class="line">    .globl __restore</span><br><span class="line">    .align 2</span><br><span class="line">__alltraps:</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">__restore:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>从linker-qemu.ld和trap.S中可以看出，物理地址在strampoline的代码段是中断和异常处理入口和恢复的出口。我们通过map_trampoline方法把这部分映射到了内核地址空间的最高处。</p>
<p>然后调用 <code>rust_main() -&gt; mm::init() -&gt; KERNEL_SPACE.exclusive_access().activate()</code> 内核就开启了使用 va 访问内存。</p>
<p>到此为止mm::init就做了这些事情，算是把内核空间给搞定了，仔细想想，虽然用起来没啥差别，因为做了一个恒等映射，之间访问到哪儿，现在还是访问到哪儿，但其中的过程却是大不相同，在访存的时候不是一开始拿着地址就当作物理地址访问，而是通过MMU翻译之后得到物理地址，只是说翻译了一通最后发现等于一开始拿到的虚拟地址，虽说过程曲折，但结果倒是一样。</p>
<h2 id="6-正式四步之第三步—-把应用映射起来。"><a href="#6-正式四步之第三步—-把应用映射起来。" class="headerlink" title="6 正式四步之第三步—-把应用映射起来。"></a>6 正式四步之第三步—-把应用映射起来。</h2><h2 id="7-正式四步之第四步—-trapContext-切换的问题。"><a href="#7-正式四步之第四步—-trapContext-切换的问题。" class="headerlink" title="7 正式四步之第四步—-trapContext 切换的问题。"></a>7 正式四步之第四步—-trapContext 切换的问题。</h2><p>u-s 之间的跳转就没有之前那么简单了，之前都是 pa 地址空间，现在，各在各的空间，要在两个空间之间做跳转。</p>
<p>值得注意的是无论是内核空间还是应用程序空间，在最高的虚拟页上，我们设置了一个 <code>trampoline</code> ，在转换时，这一段地址都会映射到相同的地址。这样就保证了在映射前后，执行的指令是连续的。</p>
<p>在地址空间进行切换的时候，会有一段代码，既需要在用户空间访问，也需要在内核空间访问。</p>
<p>再看<code>用户地址空间</code>的次高页，有了 trapContext，这个之前是放在内核栈里的，</p>
<h4 id="7-1-为什么要把-trapContext-放在用户空间？"><a href="#7-1-为什么要把-trapContext-放在用户空间？" class="headerlink" title="7.1 为什么要把 trapContext 放在用户空间？"></a>7.1 为什么要把 trapContext 放在用户空间？</h4><p>如果放在内核空间，需要两个寄存器，一个用于保存内核页表指针，一个内核栈顶。硬件却只提供一个 sscratch 可以用来进行周转。</p>
<blockquote>
<p>内核空间的 token 是什么？</p>
</blockquote>
<blockquote>
<p>内核空间是 identical 了，用户对kernel 空间的布局都清楚了，还需要内核页表做什么？</p>
</blockquote>
<p>引入虚拟内存后, 需要添加地址空间MemorySet的结构体以及每个任务的trap context的物理页号, 这样以来, 内核才可以在任务控制时获取其trap的上下文信息</p>
<p><img src="/./pics/4_01.jpg"></p>
<p><img src="/./pics/a2bbc8ee.webp"></p>
<h2 id="8-总结"><a href="#8-总结" class="headerlink" title="8 总结"></a>8 总结</h2><ul>
<li>mm::init()</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 首先分配堆</span></span><br><span class="line">    heap_allocator::<span class="title function_ invoke__">init_heap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 物理页帧分配器</span></span><br><span class="line">    frame_allocator::<span class="title function_ invoke__">init_frame_allocator</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先按排内核地址， activate 往 satp 里写值，激活内核的分页。</span></span><br><span class="line">    KERNEL_SPACE.<span class="title function_ invoke__">exclusive_access</span>().<span class="title function_ invoke__">activate</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">map_trampoline</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.page_table.<span class="title function_ invoke__">map</span></span><br><span class="line">    (</span><br><span class="line">        VirtAddr::<span class="title function_ invoke__">from</span>(TRAMPOLINE).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">        PhysAddr::<span class="title function_ invoke__">from</span>(strampoline <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">        PTEFlags::R | PTEFlags::X,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里就表示，从内存的顶端往下一个页面。</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> TRAMPOLINE: <span class="type">usize</span> = <span class="type">usize</span>::MAX - PAGE_SIZE + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>所以虚拟地址的内核页里，trampline 的代码有两份，一份在 text 里，一份在 trampline 里，它们指向同一个物理页面。</p>
<ul>
<li>task::run_first_task()</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">run_first_task</span>()</span><br><span class="line">&#123;</span><br><span class="line">    TASK_MANAGER.<span class="title function_ invoke__">run_first_task</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/./pics/4_12.png"><br><img src="/./pics/4_13.png"></p>
<p><font color="red">下面的 alltraps 代码涉及到三个栈指针 sp，首先 <code>csrrw sp, sscratch, sp</code> 使得当前的 sp 指向 trapcontext 结构，scratch 指向 user stack。</p>
<p>然后 <code>ld sp, 35*8(sp)</code> 一行，对照着 TrapContext 结构 的 offset 35，即 sp 指向了 app kernel stack。</p>
<p>接着，切换页表，执行一个长跳转 <code>jr t1</code> 跳到 traphandler， traphandler 位于低地址，trampoline 位于高地址，所以这里是长跳转。<br></font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__alltraps:</span><br><span class="line">    csrrw sp, sscratch, sp</span><br><span class="line">    # now sp-&gt;*TrapContext in user space, sscratch-&gt;user stack</span><br><span class="line">    # save other general purpose registers</span><br><span class="line">    sd x1, 1*8(sp)</span><br><span class="line">    # skip sp(x2), we will save it later</span><br><span class="line">    sd x3, 3*8(sp)</span><br><span class="line">    # skip tp(x4), application does not use it</span><br><span class="line">    # save x5~x31</span><br><span class="line">    .set n, 5</span><br><span class="line">    .rept 27</span><br><span class="line">        SAVE_GP %n</span><br><span class="line">        .set n, n+1</span><br><span class="line">    .endr</span><br><span class="line">    # we can use t0/t1/t2 freely, because they have been saved in TrapContext</span><br><span class="line">    csrr t0, sstatus</span><br><span class="line">    csrr t1, sepc</span><br><span class="line">    sd t0, 32*8(sp)</span><br><span class="line">    sd t1, 33*8(sp)</span><br><span class="line">    # read user stack from sscratch and save it in TrapContext</span><br><span class="line">    csrr t2, sscratch</span><br><span class="line">    sd t2, 2*8(sp)</span><br><span class="line">    # load kernel_satp into t0</span><br><span class="line">    ld t0, 34*8(sp)</span><br><span class="line">    # load trap_handler into t1</span><br><span class="line">    ld t1, 36*8(sp)</span><br><span class="line">    # move to kernel_sp</span><br><span class="line">    ld sp, 35*8(sp)</span><br><span class="line">    # switch to kernel space</span><br><span class="line">    csrw satp, t0</span><br><span class="line">    sfence.vma</span><br><span class="line">    # jump to trap_handler</span><br><span class="line">    jr t1</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TrapContext</span> &#123;</span><br><span class="line">    <span class="comment">/// General-Purpose Register x0-31</span></span><br><span class="line">    <span class="keyword">pub</span> x: [<span class="type">usize</span>; <span class="number">32</span>],</span><br><span class="line">    <span class="comment">/// Supervisor Status Register</span></span><br><span class="line">    <span class="keyword">pub</span> sstatus: Sstatus,</span><br><span class="line">    <span class="comment">/// Supervisor Exception Program Counter</span></span><br><span class="line">    <span class="keyword">pub</span> sepc: <span class="type">usize</span>,</span><br><span class="line">    <span class="comment">/// Token of kernel address space</span></span><br><span class="line">    <span class="keyword">pub</span> kernel_satp: <span class="type">usize</span>,</span><br><span class="line">    <span class="comment">/// Kernel stack pointer of the current application</span></span><br><span class="line">    <span class="keyword">pub</span> kernel_sp: <span class="type">usize</span>,</span><br><span class="line">    <span class="comment">/// Virtual address of trap handler entry point in kernel</span></span><br><span class="line">    <span class="keyword">pub</span> trap_handler: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="TODO-gpb-时，遇到一个奇怪的现象。"><a href="#TODO-gpb-时，遇到一个奇怪的现象。" class="headerlink" title="TODO gpb 时，遇到一个奇怪的现象。"></a>TODO gpb 时，遇到一个奇怪的现象。</h2><p><img src="/./pics/4_10.png"></p>
<p>如上图所示，打了两个断点，分别是 run_first_task &#x2F; run_next_task，通过 gdb 进入的是 lazy_static 代码，有点不理解？</p>
<h2 id="TODO-待删，了解-from-raw-parts"><a href="#TODO-待删，了解-from-raw-parts" class="headerlink" title="TODO 待删，了解 from_raw_parts"></a>TODO 待删，了解 from_raw_parts</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::slice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">some_vector</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pointer</span> = some_vector.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">length</span> = some_vector.<span class="title function_ invoke__">len</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">my_slice</span>: &amp;[<span class="type">u32</span>] = slice::<span class="title function_ invoke__">from_raw_parts</span>(pointer, length);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(some_vector.<span class="title function_ invoke__">as_slice</span>(), my_slice);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>接下来的任务是通读代码。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://goversion.github.io/2025/08/31/os3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhou tao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/31/os3/" class="post-title-link" itemprop="url">os3</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-31 17:44:21 / 修改时间：23:12:12" itemprop="dateCreated datePublished" datetime="2025-08-31T17:44:21+08:00">2025-08-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <head>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
</head>


<h1 id="OS-第三章：分时多任务系统"><a href="#OS-第三章：分时多任务系统" class="headerlink" title="OS 第三章：分时多任务系统"></a>OS 第三章：分时多任务系统</h1><p>分时多任务：</p>
<ul>
<li><p>任务上下文的切换；</p>
<ul>
<li>任务切换的时机；</li>
<li>任务上下文与 trap 上下文的区别；</li>
</ul>
</li>
<li><p>中断处理；</p>
</li>
<li><p>用户态 -&gt; 内核态</p>
<p>异常：即 syscall，用户程序主动调用 syscall 访问内核。</p>
<p>中断：如果用户程序访问 syscall 一直霸着 CPU 不放，用户程序虽然没有触发 syscall，但 kernel 可以主动中断用户程序。</p>
</li>
</ul>
<h2 id="0-总览"><a href="#0-总览" class="headerlink" title="0 总览"></a>0 总览</h2><p><img src="/./pics/3_05.png"></p>
<p><img src="/./pics/3_06.jpg"></p>
<p><img src="/./pics/3_08.png"></p>
<p>批处理系统：用户程序在用户态的瞬间状态(现场) A 用 trapContext 来封装。主控程序使用 <code>syscall / restore</code> 在用户态的 app 和内核态的 alltrap 之间来回跳动。</p>
<p><img src="/./pics/3_07.jpg"><br><font color="red"></p>
<p>分时系统：用户程序在内核态的瞬间状态 A‘ 用 taskContext 来封装。主控程序使用 <code>__switch</code> 在内核态里的 app 之间切换。</p>
<p>此处，该流程在脑海里像放动画一样，这个总结简洁而又高屋建瓴。<br></font></p>
<h2 id="1-从用户程序一侧的视角看"><a href="#1-从用户程序一侧的视角看" class="headerlink" title="1 从用户程序一侧的视角看"></a>1 从用户程序一侧的视角看</h2><p>从用户程序出发，因为内存足够大，把所有应用依次加载到各自的区域。而不是像前面，一次加载一个，每次加载到相同的区域。</p>
<p><img src="/./pics/3_05.png"></p>
<p>每个 app 会被编译到不同的起始处，对应地，load_app 也就需要改变。见 user&#x2F;build.py 代码里。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> app <span class="keyword">in</span> apps:</span><br><span class="line">    app = app[: app.find(<span class="string">&quot;.&quot;</span>)]</span><br><span class="line">    os.system(</span><br><span class="line">        <span class="string">&quot;cargo rustc --bin %s %s -- -Clink-args=-Ttext=%x&quot;</span></span><br><span class="line">        % (app, mode_arg, base_address + step * app_id)</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">&quot;[build.py] application %s start with address %s&quot;</span></span><br><span class="line">        % (app, <span class="built_in">hex</span>(base_address + step * app_id))</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> chapter == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">        app_id = app_id + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>本章，每一个应用依次加载到 $ base_address + step * app_id &#x3D; 0x80400000 + 0x20000 * app_id $ 中。</p>
<p>在 kernel 侧，加载时就需要做相应的调整。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Load nth user app at</span></span><br><span class="line"><span class="comment">/// [APP_BASE_ADDRESS + n * APP_SIZE_LIMIT, APP_BASE_ADDRESS + (n+1) * APP_SIZE_LIMIT).</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">load_apps</span>() &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">_num_app</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num_app_ptr</span> = _num_app <span class="keyword">as</span> <span class="type">usize</span> <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num_app</span> = <span class="title function_ invoke__">get_num_app</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">app_start</span> = <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts</span>(num_app_ptr.<span class="title function_ invoke__">add</span>(<span class="number">1</span>), num_app + <span class="number">1</span>) &#125;;</span><br><span class="line">    <span class="comment">// clear i-cache first</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(<span class="string">&quot;fence.i&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// load apps</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..num_app &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">base_i</span> = <span class="title function_ invoke__">get_base_i</span>(i);</span><br><span class="line">        <span class="comment">// clear region</span></span><br><span class="line">        (base_i..base_i + APP_SIZE_LIMIT)</span><br><span class="line">            .for_each(|addr| <span class="keyword">unsafe</span> &#123; (addr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>).<span class="title function_ invoke__">write_volatile</span>(<span class="number">0</span>) &#125;);</span><br><span class="line">        <span class="comment">// load app from data section to memory</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">src</span> = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            core::slice::<span class="title function_ invoke__">from_raw_parts</span>(app_start[i] <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>, app_start[i + <span class="number">1</span>] - app_start[i])</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">dst</span> = <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(base_i <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, src.<span class="title function_ invoke__">len</span>()) &#125;;</span><br><span class="line">        dst.<span class="title function_ invoke__">copy_from_slice</span>(src);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-用户程序主动交出控制权，引入了一个系统调用-sys-yield。"><a href="#2-用户程序主动交出控制权，引入了一个系统调用-sys-yield。" class="headerlink" title="2 用户程序主动交出控制权，引入了一个系统调用 sys_yield。"></a>2 用户程序主动交出控制权，引入了一个系统调用 sys_yield。</h2><p><img src="/./pics/3_03.png"></p>
<p>先把当前的 app 暂停下来，寻找下一个 app。然后通过 <code>__switch</code> 就完成了 “暂停上一下任务，切换到下一个任务” 的功能。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Switch current `Running` task to the task we have found,</span></span><br><span class="line"><span class="comment">/// or there is no `Ready` task and we can exit with all applications completed</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">run_next_task</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(next) = <span class="keyword">self</span>.<span class="title function_ invoke__">find_next_task</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">inner</span> = <span class="keyword">self</span>.inner.<span class="title function_ invoke__">exclusive_access</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">current</span> = inner.current_task;</span><br><span class="line">        inner.tasks[next].task_status = TaskStatus::Running;</span><br><span class="line">        inner.current_task = next;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">current_task_cx_ptr</span> = &amp;<span class="keyword">mut</span> inner.tasks[current].task_cx <span class="keyword">as</span> *<span class="keyword">mut</span> TaskContext;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">next_task_cx_ptr</span> = &amp;inner.tasks[next].task_cx <span class="keyword">as</span> *<span class="keyword">const</span> TaskContext;</span><br><span class="line">        <span class="title function_ invoke__">drop</span>(inner);</span><br><span class="line">        <span class="comment">// before this, we should drop local variables that must be dropped manually</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            __switch(current_task_cx_ptr, next_task_cx_ptr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// go back to user mode</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;All applications completed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-1-TaskContext"><a href="#2-1-TaskContext" class="headerlink" title="2.1 TaskContext"></a>2.1 TaskContext</h4><p><img src="/./pics/3_01.jpg"></p>
<blockquote>
<p>为什么是在 kernel 时刻，做任务切换，在 kernel 从 A 切到 B，再 切到用户态 B。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pub struct TaskContext &#123;</span><br><span class="line">    /// Ret position after task switching</span><br><span class="line">    ra: usize,</span><br><span class="line">    /// Stack pointer</span><br><span class="line">    sp: usize,</span><br><span class="line">    /// s0-11 register, callee saved</span><br><span class="line">    s: [usize; 12],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>trapContext 跳到内核时，保存了 app 在用户态执行的状态，因为涉及到特权权的切换，它要保存大多数 Register。</p>
<p>从内核态跳到用户态时，app 就可以继续执行。也就是说，我们可以把程序的状态保存下来，并合适的时候恢复。</p>
<p>当 app 跳到 内核态，告诉内核，当前 app 可以暂停，<br>而 TaskContext，在程序</p>
<ul>
<li><p>trapContext 保存的是在用户态执行时的状态，而 TaskContext 保存的是用户程序进入内核执行的中间状态，TaskContext 在保存和恢复时不涉及到特权性的切换。</p>
</li>
<li><p>trapContext 是需要硬件辅助。TaskContext 不需要硬件的帮助，编译器为我们保存一部分 register。</p>
</li>
</ul>
<blockquote>
<p>trapContext 在哪里可以感知，硬件做了事情？</p>
</blockquote>
<ul>
<li>trapContext 恢复后就回到了用户态执行，TaskContext 恢复后继续执行 app 在内核的操作。</li>
</ul>
<h4 id="2-2-有了-trapContext，内核第一次如何进入用户态执行第一个-app？"><a href="#2-2-有了-trapContext，内核第一次如何进入用户态执行第一个-app？" class="headerlink" title="2.2 有了 trapContext，内核第一次如何进入用户态执行第一个 app？"></a>2.2 有了 trapContext，内核第一次如何进入用户态执行第一个 app？</h4><p><img src="/./pics/3_02.png"></p>
<p>run_first_task 完成从 kernel 到 U 的第一个 app，<code>TaskContext::zero_init()</code> 构造一个空的 <code>TaskContext</code>，<code>next_task_cx_ptr</code> 是 <code>第一个 app 的上下文</code> 作为 <code>__switch</code> 的第二个参数</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Run the first task in task list.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Generally, the first task in task list is an idle task (we call it zero process later).</span></span><br><span class="line"><span class="comment">/// But in ch3, we load apps statically, so the first task is a real app.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">run_first_task</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">inner</span> = <span class="keyword">self</span>.inner.<span class="title function_ invoke__">exclusive_access</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">task0</span> = &amp;<span class="keyword">mut</span> inner.tasks[<span class="number">0</span>];</span><br><span class="line">    task0.task_status = TaskStatus::Running;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">next_task_cx_ptr</span> = &amp;task0.task_cx <span class="keyword">as</span> *<span class="keyword">const</span> TaskContext;</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(inner);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">_unused</span> = TaskContext::<span class="title function_ invoke__">zero_init</span>();</span><br><span class="line">    <span class="comment">// before this, we should drop local variables that must be dropped manually</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        __switch(&amp;<span class="keyword">mut</span> _unused <span class="keyword">as</span> *<span class="keyword">mut</span> TaskContext, next_task_cx_ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;unreachable in run_first_task!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__switch:</span><br><span class="line">    # __switch(</span><br><span class="line">    #     current_task_cx_ptr: *mut TaskContext,</span><br><span class="line">    #     next_task_cx_ptr: *const TaskContext</span><br><span class="line">    # )</span><br><span class="line">    # save kernel stack of current task</span><br><span class="line">    sd sp, 8(a0)</span><br><span class="line">    # save ra &amp; s0~s11 of current execution</span><br><span class="line">    sd ra, 0(a0)</span><br><span class="line">    .set n, 0</span><br><span class="line">    .rept 12</span><br><span class="line">        SAVE_SN %n</span><br><span class="line">        .set n, n + 1</span><br><span class="line">    .endr</span><br><span class="line">    # restore ra &amp; s0~s11 of next execution</span><br><span class="line">    ld ra, 0(a1)</span><br><span class="line">    .set n, 0</span><br><span class="line">    .rept 12</span><br><span class="line">        LOAD_SN %n</span><br><span class="line">        .set n, n + 1</span><br><span class="line">    .endr</span><br><span class="line">    # restore kernel stack of next task</span><br><span class="line">    ld sp, 8(a1)</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<p>先把当前任务的状态保存下来，然后把下一个任务的状态恢复，并且最后调一个 ret 返回到 ra 指向的地址处。</p>
<h4 id="2-3-上图左侧，构造好-trapContext，设好-ra-sp"><a href="#2-3-上图左侧，构造好-trapContext，设好-ra-sp" class="headerlink" title="2.3 上图左侧，构造好 trapContext，设好 ra &#x2F; sp"></a>2.3 上图左侧，构造好 trapContext，设好 ra &#x2F; sp</h4><p>内核在为这些用户程序构造任务上下文时，它做的事情。<br>TASK_MANAGER 在初始化时，为每个用户程序初始化了任务上下文，<br><code>init_app_cx(i)</code> 为每一个用户程序构造 trap 上下文，</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Global variable: TASK_MANAGER</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> TASK_MANAGER: TaskManager = &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num_app</span> = <span class="title function_ invoke__">get_num_app</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tasks</span> = [TaskControlBlock &#123;</span><br><span class="line">        task_cx: TaskContext::<span class="title function_ invoke__">zero_init</span>(),</span><br><span class="line">        task_status: TaskStatus::UnInit,</span><br><span class="line">    &#125;; MAX_APP_NUM];</span><br><span class="line">    <span class="keyword">for</span> (i, task) <span class="keyword">in</span> tasks.<span class="title function_ invoke__">iter_mut</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        task.task_cx = TaskContext::<span class="title function_ invoke__">goto_restore</span>(<span class="title function_ invoke__">init_app_cx</span>(i));</span><br><span class="line">        task.task_status = TaskStatus::Ready;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>为每一个用户程序在内核栈上构建 trapContext，每一个用户程序有了自己的内核栈。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// get app info with entry and sp and save `TrapContext` in kernel stack</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init_app_cx</span>(app_id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    KERNEL_STACK[app_id].<span class="title function_ invoke__">push_context</span>(TrapContext::<span class="title function_ invoke__">app_init_context</span>(</span><br><span class="line">        <span class="title function_ invoke__">get_base_i</span>(app_id),</span><br><span class="line">        USER_STACK[app_id].<span class="title function_ invoke__">get_sp</span>(),</span><br><span class="line">    ))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 trapContext 和批处理系统的逻辑是一样的，它的主要不同点是，现在，每一个用户程序都有了自己的内核栈了 <code>KERNEL_STACK[app_id]</code>。</p>
<p>因为批处理系统是一个接一个运行的，我们可以重复利用内核栈和用户栈。<br>但现在分时多任务系统不是一个接一个运行的，而是可以暂停一个，跳到去执行另一个。<br>所以，我们需要为每一个程序分配它的内核栈和用户栈。</p>
<blockquote>
<p>TODO: 这里的用户栈，好像从来没有讲到过，没有用过？</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Create a new task context with a trap return addr and a kernel stack pointer</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">goto_restore</span>(kstack_ptr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">__restore</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Self</span> &#123;</span><br><span class="line">        ra: __restore <span class="keyword">as</span> <span class="type">usize</span>,</span><br><span class="line">        sp: kstack_ptr,</span><br><span class="line">        s: [<span class="number">0</span>; <span class="number">12</span>],</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里把 rs 赋为 __restore 的地址，sp 赋了内核栈的地址，</p>
<h2 id="3-如果用户程序不交出控制权，内核通过时钟中断。"><a href="#3-如果用户程序不交出控制权，内核通过时钟中断。" class="headerlink" title="3 如果用户程序不交出控制权，内核通过时钟中断。"></a>3 如果用户程序不交出控制权，内核通过时钟中断。</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pub fn rust_main() -&gt; ! &#123;</span><br><span class="line">    ...</span><br><span class="line">    trap::enable_timer_interrupt();</span><br><span class="line">    timer::set_next_trigger();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="4-代码总览"><a href="#4-代码总览" class="headerlink" title="4 代码总览"></a>4 代码总览</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pub fn rust_main() -&gt; ! &#123;</span><br><span class="line">    clear_bss();</span><br><span class="line">    println!(&quot;[kernel] Hello, world!&quot;);</span><br><span class="line"></span><br><span class="line">    // 让 vec 指向 中断处理程序 alltrap。</span><br><span class="line">    trap::init();</span><br><span class="line"></span><br><span class="line">    // 把几个应用加载到相应的位置。</span><br><span class="line">    loader::load_apps();</span><br><span class="line"></span><br><span class="line">    // 设置时钟中断寄存器；</span><br><span class="line">    trap::enable_timer_interrupt();</span><br><span class="line"></span><br><span class="line">    // 设置时间间隔；</span><br><span class="line">    timer::set_next_trigger();</span><br><span class="line"></span><br><span class="line">    task::run_first_task();</span><br><span class="line"></span><br><span class="line">    panic!(&quot;Unreachable in rust_main!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-疑问"><a href="#5-疑问" class="headerlink" title="5 疑问"></a>5 疑问</h2><ol>
<li>app 是如何停下来的呢？</li>
</ol>
<p>mark_current_suspend()</p>
<ol start="2">
<li>看下面代码，第一种 helloworld 正常的系统调用 syscall 它没有调用 exit_current_and_run_next()，即一个简单的 helloworld 程序是如何切换为下一个程序的？</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// handle an interrupt, exception, or system call from user space</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">trap_handler</span>(cx: &amp;<span class="keyword">mut</span> TrapContext) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> TrapContext &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">scause</span> = scause::<span class="title function_ invoke__">read</span>(); <span class="comment">// get trap cause</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stval</span> = stval::<span class="title function_ invoke__">read</span>(); <span class="comment">// get extra value</span></span><br><span class="line">    <span class="keyword">match</span> scause.<span class="title function_ invoke__">cause</span>() &#123;</span><br><span class="line">        Trap::<span class="title function_ invoke__">Exception</span>(Exception::UserEnvCall) =&gt; &#123;</span><br><span class="line">            cx.sepc += <span class="number">4</span>;</span><br><span class="line">            cx.x[<span class="number">10</span>] = <span class="title function_ invoke__">syscall</span>(cx.x[<span class="number">17</span>], [cx.x[<span class="number">10</span>], cx.x[<span class="number">11</span>], cx.x[<span class="number">12</span>]]) <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Trap::<span class="title function_ invoke__">Exception</span>(Exception::StoreFault) | Trap::<span class="title function_ invoke__">Exception</span>(Exception::StorePageFault) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[kernel] PageFault in application, bad addr = &#123;:#x&#125;, bad instruction = &#123;:#x&#125;, kernel killed it.&quot;</span>, stval, cx.sepc);</span><br><span class="line">            <span class="title function_ invoke__">exit_current_and_run_next</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Trap::<span class="title function_ invoke__">Exception</span>(Exception::IllegalInstruction) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[kernel] IllegalInstruction in application, kernel killed it.&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">exit_current_and_run_next</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Trap::<span class="title function_ invoke__">Interrupt</span>(Interrupt::SupervisorTimer) =&gt; &#123;</span><br><span class="line">            <span class="title function_ invoke__">set_next_trigger</span>();</span><br><span class="line">            <span class="title function_ invoke__">suspend_current_and_run_next</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(</span><br><span class="line">                <span class="string">&quot;Unsupported trap &#123;:?&#125;, stval = &#123;:#x&#125;!&quot;</span>,</span><br><span class="line">                scause.<span class="title function_ invoke__">cause</span>(),</span><br><span class="line">                stval</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>分时系统如何用 gdb 调试？</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://goversion.github.io/2025/08/31/os2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhou tao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/31/os2/" class="post-title-link" itemprop="url">os2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-31 17:44:18 / 修改时间：17:45:17" itemprop="dateCreated datePublished" datetime="2025-08-31T17:44:18+08:00">2025-08-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="OS-第二章：批处理系统"><a href="#OS-第二章：批处理系统" class="headerlink" title="OS 第二章：批处理系统"></a>OS 第二章：批处理系统</h1><p>批处理系统：</p>
<ul>
<li>trap 上下文的切换；<ul>
<li>特权级切换；</li>
<li>trap 上下文的保存和恢复；</li>
</ul>
</li>
<li>异常处理；<ul>
<li>系统调用；</li>
<li>其它异常；</li>
</ul>
</li>
</ul>
<blockquote>
<p>sscratch 像是在说，用户的内核栈在这里，现场要保存到这里。</p>
</blockquote>
<h2 id="0-总览"><a href="#0-总览" class="headerlink" title="0 总览"></a>0 总览</h2><p><img src="/./pics/2_03.jpg"></p>
<p><img src="/./pics/2_05.png"></p>
<p><img src="/./pics/2_08.png"></p>
<p>在内核态到用户态之间的切换，主要靠 syscall 和 ret 两条命令。</p>
<h2 id="1-从用户程序一侧的视角看"><a href="#1-从用户程序一侧的视角看" class="headerlink" title="1 从用户程序一侧的视角看"></a>1 从用户程序一侧的视角看</h2><p>作为批处理系统，从用户程序一侧的视角出发，先准备多个应用程序，加载一个到 0x80400000，运行它，再加载下一个到 0x80400000，如此循环。</p>
<ul>
<li>user&#x2F;src&#x2F;lib.rs 这里是 user 的主入口。</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="meta">#[link_section = <span class="string">&quot;.text.entry&quot;</span>]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>(argc: <span class="type">usize</span>, argv: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="title function_ invoke__">clear_bss</span>();</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        HEAP.<span class="title function_ invoke__">lock</span>()</span><br><span class="line">            .<span class="title function_ invoke__">init</span>(HEAP_SPACE.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> <span class="type">usize</span>, USER_HEAP_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span>: <span class="type">Vec</span>&lt;&amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..argc &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">str_start</span> = <span class="keyword">unsafe</span> &#123; ((argv + i * core::mem::size_of::&lt;<span class="type">usize</span>&gt;()) <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">usize</span>).<span class="title function_ invoke__">read_volatile</span>() &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = (<span class="number">0usize</span>..)</span><br><span class="line">            .<span class="title function_ invoke__">find</span>(|i| <span class="keyword">unsafe</span> &#123; ((str_start + *i) <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>).<span class="title function_ invoke__">read_volatile</span>() == <span class="number">0</span> &#125;)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        v.<span class="title function_ invoke__">push</span>(</span><br><span class="line">            core::<span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(<span class="keyword">unsafe</span> &#123;</span><br><span class="line">                core::slice::<span class="title function_ invoke__">from_raw_parts</span>(str_start <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>, len)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">exit</span>(<span class="title function_ invoke__">main</span>(argc, v.<span class="title function_ invoke__">as_slice</span>()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[linkage = <span class="string">&quot;weak&quot;</span>]</span></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(_argc: <span class="type">usize</span>, _argv: &amp;[&amp;<span class="type">str</span>]) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;Cannot find main!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用完用户程序 <code>app</code> 后，为什么需要 <code>exit</code> 这个系统调用呢？</p>
<p>下面的代码，<code>linkage = &quot;weak&quot;</code>，下面也是一个 main，<br>当编译 app 时，如果 app main 不存在的话，就采用弱链接的实现，<br>这是为什么有两个 main 实现。</p>
<p>这里才是 user 的主入口程序。<br><code>exit(main(argc, v.as_slice()));</code><br>这一段代码，先调用 app；<br>app 结束之后，调用 exit 向 OS 发出请求；<br>下面的代码，<code>linkage = &quot;weak&quot;</code>，下面也是一个 main，<br>当编译 app 时，如果 app main 不存在的话，就采用弱链接的实现，<br>这是为什么有两个 main 实现。</p>
<h2 id="3-从-kernel-一侧的视角看"><a href="#3-从-kernel-一侧的视角看" class="headerlink" title="3 从 kernel 一侧的视角看"></a>3 从 kernel 一侧的视角看</h2><h3 id="3-1-将应用程序链接到内核"><a href="#3-1-将应用程序链接到内核" class="headerlink" title="3.1 将应用程序链接到内核"></a>3.1 将应用程序链接到内核</h3><p><code>build.rs</code> 生成 <code>link_app.S</code> 文件</p>
<ul>
<li>扫描 user 目录下的 app。</li>
<li>将编译出来的 binary 文件链接到内核里，和内核一起编译。</li>
</ul>
<p>  link_app.S 扫描 user 目录下的 <code>用户程序 app</code>。<br>然后 main.rs 中 引入 <code>global_asm!(include_str!(&quot;link_app.S&quot;));</code> 后，汇编的符号信息就可以使用了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">    .align 3</span><br><span class="line">    .section .data</span><br><span class="line">    .global _num_app</span><br><span class="line">_num_app:</span><br><span class="line">    .quad 5</span><br><span class="line">    .quad app_0_start</span><br><span class="line">    .quad app_1_start</span><br><span class="line">    .quad app_2_start</span><br><span class="line">    .quad app_3_start</span><br><span class="line">    .quad app_4_start</span><br><span class="line">    .quad app_4_end</span><br><span class="line"></span><br><span class="line">    .section .data</span><br><span class="line">    .global app_0_start</span><br><span class="line">    .global app_0_end</span><br><span class="line">app_0_start:</span><br><span class="line">    .incbin &quot;../user/target/riscv64gc-unknown-none-elf/release/00hello_world.bin&quot;</span><br><span class="line">app_0_end:</span><br><span class="line"></span><br><span class="line">    .section .data</span><br><span class="line">    .global app_1_start</span><br><span class="line">    .global app_1_end</span><br><span class="line">app_1_start:</span><br><span class="line">    .incbin &quot;../user/target/riscv64gc-unknown-none-elf/release/01store_fault.bin&quot;</span><br><span class="line">app_1_end:</span><br><span class="line"></span><br><span class="line">    .section .data</span><br><span class="line">    .global app_2_start</span><br><span class="line">    .global app_2_end</span><br><span class="line">app_2_start:</span><br><span class="line">    .incbin &quot;../user/target/riscv64gc-unknown-none-elf/release/02power.bin&quot;</span><br><span class="line">app_2_end:</span><br><span class="line"></span><br><span class="line">    .section .data</span><br><span class="line">    .global app_3_start</span><br><span class="line">    .global app_3_end</span><br><span class="line">app_3_start:</span><br><span class="line">    .incbin &quot;../user/target/riscv64gc-unknown-none-elf/release/03priv_inst.bin&quot;</span><br><span class="line">app_3_end:</span><br><span class="line"></span><br><span class="line">    .section .data</span><br><span class="line">    .global app_4_start</span><br><span class="line">    .global app_4_end</span><br><span class="line">app_4_start:</span><br><span class="line">    .incbin &quot;../user/target/riscv64gc-unknown-none-elf/release/04priv_csr.bin&quot;</span><br><span class="line">app_4_end:</span><br></pre></td></tr></table></figure>

<p>incbin 是汇编语言中的一个伪指令，用于将二进制文件的原始内容直接嵌入到当前的汇编文件中。</p>
<h3 id="3-2-batch-init"><a href="#3-2-batch-init" class="headerlink" title="3.2 batch::init()"></a>3.2 batch::init()</h3><ul>
<li>main.rs 文件主要有下面三行。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trap::init();</span><br><span class="line">batch::init();</span><br><span class="line">batch::run_next_app();</span><br></pre></td></tr></table></figure>


<p><code>batch::init()</code> 找到 link_app.S 的符号信息，把值赋给 AppManager 这个结构体。</p>
<p><font color="red">这里没有看懂，batch::init() 是怎么调到下面的代码的？下面的 UPSafeCell 体是一个函数吗？</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">lazy_static! &#123;</span><br><span class="line">    static ref APP_MANAGER: UPSafeCell&lt;AppManager&gt; = unsafe &#123;</span><br><span class="line">        UPSafeCell::new(&#123;</span><br><span class="line">            extern &quot;C&quot; &#123;</span><br><span class="line">                fn _num_app();</span><br><span class="line">            &#125;</span><br><span class="line">            let num_app_ptr = _num_app as usize as *const usize;</span><br><span class="line">            let num_app = num_app_ptr.read_volatile();</span><br><span class="line">            let mut app_start: [usize; MAX_APP_NUM + 1] = [0; MAX_APP_NUM + 1];</span><br><span class="line">            let app_start_raw: &amp;[usize] =</span><br><span class="line">                core::slice::from_raw_parts(num_app_ptr.add(1), num_app + 1);</span><br><span class="line">            app_start[..=num_app].copy_from_slice(app_start_raw);</span><br><span class="line">            AppManager &#123;</span><br><span class="line">                num_app,</span><br><span class="line">                current_app: 0,</span><br><span class="line">                app_start,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-batch-run-next-app"><a href="#3-3-batch-run-next-app" class="headerlink" title="3.3  batch::run_next_app()"></a>3.3  batch::run_next_app()</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">run_next_app</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">app_manager</span> = APP_MANAGER.<span class="title function_ invoke__">exclusive_access</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">current_app</span> = app_manager.<span class="title function_ invoke__">get_current_app</span>();</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        app_manager.<span class="title function_ invoke__">load_app</span>(current_app);</span><br><span class="line">    &#125;</span><br><span class="line">    app_manager.<span class="title function_ invoke__">move_to_next_app</span>();</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(app_manager);</span><br><span class="line">    <span class="comment">// before this we have to drop local variables related to resources manually and release the resources</span></span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">__restore</span>(cx_addr: <span class="type">usize</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        __restore(KERNEL_STACK.<span class="title function_ invoke__">push_context</span>(TrapContext::<span class="title function_ invoke__">app_init_context</span>(</span><br><span class="line">            APP_BASE_ADDRESS,</span><br><span class="line">            USER_STACK.<span class="title function_ invoke__">get_sp</span>(),</span><br><span class="line">        )) <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;Unreachable in batch::run_current_app!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>load_app</p>
<p>获取当前的 app，清然后通过 <code>load_app</code> 把 app 加载到内存里。<code>load_app</code> 具体干了什么事呢？</p>
<ul>
<li><code>if app_id &gt;= self.num_app</code>， 判断当前的 app 是否越界；</li>
<li>用 <code>from_raw_parts_mut.fill(0)</code> 把 <code>0x80400000 + 0x20000</code> 区域清 0；</li>
<li>用 <code>copy_from_slice</code> 把 app 的二进制文件 copy 到这块区域；</li>
<li><code>fence.i</code> 的意思是，避免执行前一个 app 的指令。即<code>清理 cpu 的指令缓存</code>中前一个 app 的指令；</li>
</ul>
</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">load_app</span>(&amp;<span class="keyword">self</span>, app_id: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> app_id &gt;= <span class="keyword">self</span>.num_app &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;All applications completed!&quot;</span>);</span><br><span class="line">        <span class="keyword">use</span> crate::board::QEMUExit;</span><br><span class="line">        crate::board::QEMU_EXIT_HANDLE.<span class="title function_ invoke__">exit_success</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;[kernel] Loading app_&#123;&#125;&quot;</span>, app_id);</span><br><span class="line">    <span class="comment">// clear app area</span></span><br><span class="line">    core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(APP_BASE_ADDRESS <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, APP_SIZE_LIMIT).<span class="title function_ invoke__">fill</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">app_src</span> = core::slice::<span class="title function_ invoke__">from_raw_parts</span>(</span><br><span class="line">        <span class="keyword">self</span>.app_start[app_id] <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>,</span><br><span class="line">        <span class="keyword">self</span>.app_start[app_id + <span class="number">1</span>] - <span class="keyword">self</span>.app_start[app_id],</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">app_dst</span> = core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(APP_BASE_ADDRESS <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, app_src.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    app_dst.<span class="title function_ invoke__">copy_from_slice</span>(app_src);</span><br><span class="line"></span><br><span class="line">    asm!(<span class="string">&quot;fence.i&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">这里有一个疑问，这里只看到了加载，哪里是执行用户程序的调用？</font></p>
<ul>
<li>__restore</li>
</ul>
<p><font color="#FF007F">要注意，保护现场保护的是什么？<strong>from A to B. 保护的是 A 的状态，即把用户程序跳转前的一瞬间的 cpu 的状态 <code>冰冻</code> 起来。</strong></font></p>
<p>先是构建一个 <code>TrapContext</code> 放入 <code>KERNEL_STACK</code> 内核栈里。然后把 <code>TrapContext</code> 地址作为 restore 的参数，restore 完成从内核态跳转到用户态去执行。</p>
<h3 id="3-4-对-TrapContext-的解释"><a href="#3-4-对-TrapContext-的解释" class="headerlink" title="3.4 对 TrapContext 的解释"></a>3.4 对 TrapContext 的解释</h3><p><img src="/./pics/2_01.png"></p>
<p><img src="/./pics/2_02.jpg"></p>
<p>从 A 到 B，从用户态到内核态。上表中，sstatus&#x2F;sepc&#x2F;scause&#x2F;stval 是 A 侧的信息，stvec 是 B 侧的信息。</p>
<p><font color="#FF007F">sepc 是 A 侧的地址，stvec 是 B 侧的地址。</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pub struct TrapContext &#123;</span><br><span class="line">    pub x: [usize; 32],</span><br><span class="line">    pub sstatus: Sstatus,</span><br><span class="line">    pub sepc: usize,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><font color="gray">我对 TrapContext 有点没有理解，为什么上图中 5 个寄存器，而 TrapContext 只保留了 2 个？</font></p>
<blockquote>
<p>老师说，发生嵌套时，可能覆盖现场。</p>
</blockquote>
<blockquote>
<p>贺兰星辰说，那 3 个寄存器不需要保存，因为那是由 cpu 给你分派过去的，用一次后面也不会再用。我们保存上面 2 个是因为后面要恢复。</p>
</blockquote>
</li>
<li><p>把 TrapContext 保持在哪里？</p>
<p>sstatus &#x2F; sepc 是高特权级的寄存器，放在用户栈不合适。保存在 <code>app 自己的</code> 内核栈。<br><font color="#FF007F">可以想像成，app 在用户态有一个临时储物箱，在同核态也有一个临时储物箱，而 TrapContext 放在内核态的临时储物箱。</font></p>
</li>
</ul>
<h3 id="3-5-trap-init"><a href="#3-5-trap-init" class="headerlink" title="3.5 trap::init()"></a>3.5 trap::init()</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init</span>() &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">__alltraps</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        stvec::<span class="title function_ invoke__">write</span>(__alltraps <span class="keyword">as</span> <span class="type">usize</span>, TrapMode::Direct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>stvec::write</code> 写入了异常处理 <code>__alltraps</code> 的地址，即 <font color="#FF007F">stvec &#x3D; &amp;__alltraps</font>。<br>当用户程序 app 发出 syscall 时，跳转到 <code>__alltraps</code>，</p>
<p><code>csrrw sp, sscratch, sp</code> 交换用户栈和内核栈指针。交换后，现在的 sp 就指向了 app 内核栈。<br>将现场，即将寄存器和 2 个寄存器保存在内核栈上，<br>然后调用 trap_handler 去执行。</p>
<p>下面是异常处理的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__alltraps:</span><br><span class="line">    // 看 __restore 倒数第二行，就知道 内核栈指针保存在 sscratch 里。</span><br><span class="line">    csrrw sp, sscratch, sp</span><br><span class="line">    # now sp-&gt;kernel stack, sscratch-&gt;user stack</span><br><span class="line">    # allocate a TrapContext on kernel stack</span><br><span class="line">    addi sp, sp, -34*8</span><br><span class="line">    # save general-purpose registers</span><br><span class="line">    sd x1, 1*8(sp)</span><br><span class="line">    # skip sp(x2), we will save it later</span><br><span class="line">    sd x3, 3*8(sp)</span><br><span class="line">    # skip tp(x4), application does not use it</span><br><span class="line">    # save x5~x31</span><br><span class="line">    .set n, 5</span><br><span class="line">    .rept 27</span><br><span class="line">        SAVE_GP %n</span><br><span class="line">        .set n, n+1</span><br><span class="line">    .endr</span><br><span class="line">    # we can use t0/t1/t2 freely, because they were saved on kernel stack</span><br><span class="line">    csrr t0, sstatus</span><br><span class="line">    csrr t1, sepc</span><br><span class="line">    sd t0, 32*8(sp)</span><br><span class="line">    sd t1, 33*8(sp)</span><br><span class="line">    # read user stack from sscratch and save it on the kernel stack</span><br><span class="line">    csrr t2, sscratch</span><br><span class="line">    sd t2, 2*8(sp)</span><br><span class="line">    # set input argument of trap_handler(cx: &amp;mut TrapContext)</span><br><span class="line">    mv a0, sp</span><br><span class="line">    call trap_handler</span><br></pre></td></tr></table></figure>

<p>trap_handler 是 OS 提供服务的地方。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// handle an interrupt, exception, or system call from user space</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">trap_handler</span>(cx: &amp;<span class="keyword">mut</span> TrapContext) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> TrapContext &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">scause</span> = scause::<span class="title function_ invoke__">read</span>(); <span class="comment">// get trap cause</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stval</span> = stval::<span class="title function_ invoke__">read</span>(); <span class="comment">// get extra value</span></span><br><span class="line">    <span class="keyword">match</span> scause.<span class="title function_ invoke__">cause</span>() &#123;</span><br><span class="line">        <span class="comment">// syscall</span></span><br><span class="line">        Trap::<span class="title function_ invoke__">Exception</span>(Exception::UserEnvCall) =&gt; &#123;</span><br><span class="line">            cx.sepc += <span class="number">4</span>;</span><br><span class="line">            cx.x[<span class="number">10</span>] = <span class="title function_ invoke__">syscall</span>(cx.x[<span class="number">17</span>], [cx.x[<span class="number">10</span>], cx.x[<span class="number">11</span>], cx.x[<span class="number">12</span>]]) <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Trap::<span class="title function_ invoke__">Exception</span>(Exception::StoreFault) | Trap::<span class="title function_ invoke__">Exception</span>(Exception::StorePageFault) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[kernel] PageFault in application, kernel killed it.&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">run_next_app</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Trap::<span class="title function_ invoke__">Exception</span>(Exception::IllegalInstruction) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[kernel] IllegalInstruction in application, kernel killed it.&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">run_next_app</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(</span><br><span class="line">                <span class="string">&quot;Unsupported trap &#123;:?&#125;, stval = &#123;:#x&#125;!&quot;</span>,</span><br><span class="line">                scause.<span class="title function_ invoke__">cause</span>(),</span><br><span class="line">                stval</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>从 scause 获取 syscall id。</li>
<li>syscall 后返回 cx.sepc +&#x3D; 4;</li>
</ul>
<blockquote>
<p><code>trap_handler</code> 结束之后，回到 __restore，这从哪里可以看得出来？<code>__restore</code> 做的事情与 <code>__alltraps</code> 相反。</p>
</blockquote>
<p>注意，上面第一个 Trap syscall 之后没有调用 run_next_app()，原因是 system_call 是在执行内核代码，并不切换 app，系统调用完了就返回原 task 继续运行了。gdb 一行代码一行代码跟着走，看看他是怎么执行的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__restore:</span><br><span class="line">    # case1: start running app by __restore</span><br><span class="line">    # case2: back to U after handling trap</span><br><span class="line"></span><br><span class="line">    // 注意 __restore(KERNEL_STACK(trapContext))，参数是 trapContext</span><br><span class="line">    mv sp, a0</span><br><span class="line"></span><br><span class="line">    # now sp-&gt;kernel stack(after allocated), sscratch-&gt;user stack</span><br><span class="line">    # restore sstatus/sepc</span><br><span class="line">    ld t0, 32*8(sp)</span><br><span class="line">    ld t1, 33*8(sp)</span><br><span class="line">    ld t2, 2*8(sp)</span><br><span class="line">    csrw sstatus, t0</span><br><span class="line">    csrw sepc, t1</span><br><span class="line">    csrw sscratch, t2</span><br><span class="line">    # restore general-purpuse registers except sp/tp</span><br><span class="line">    ld x1, 1*8(sp)</span><br><span class="line">    ld x3, 3*8(sp)</span><br><span class="line">    .set n, 5</span><br><span class="line">    .rept 27</span><br><span class="line">        LOAD_GP %n</span><br><span class="line">        .set n, n+1</span><br><span class="line">    .endr</span><br><span class="line">    # release TrapContext on kernel stack</span><br><span class="line">    addi sp, sp, 34*8</span><br><span class="line">    # now sp-&gt;kernel stack, sscratch-&gt;user stack</span><br><span class="line">    // 准备要退到用户态去执行了，把内核栈指针 sp 保存到 sscratch 里去，</span><br><span class="line">    csrrw sp, sscratch, sp</span><br><span class="line">    sret</span><br></pre></td></tr></table></figure>

<p>通过 sret 回到用户态。</p>
<p><code>__restore</code> 结尾的 <code>csrrw sp, sscratch, sp</code>，sp 原本指向内核栈指针，交换后，sp 指向用户栈，sscratch 指向内核栈。</p>
<p>再回过头来看 <code>__alltraps</code> 开头的 <code>csrrw sp, sscratch, sp</code>，从 sscratch 里获取内核栈。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">TrapContext</span> &#123;</span><br><span class="line">    <span class="comment">/// set stack pointer to x_2 reg (sp)</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">set_sp</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, sp: <span class="type">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.x[<span class="number">2</span>] = sp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// init app context</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">app_init_context</span>(entry: <span class="type">usize</span>, sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">sstatus</span> = sstatus::<span class="title function_ invoke__">read</span>(); <span class="comment">// CSR sstatus</span></span><br><span class="line">        sstatus.<span class="title function_ invoke__">set_spp</span>(SPP::User); <span class="comment">//previous privilege mode: user mode</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cx</span> = <span class="keyword">Self</span> &#123;</span><br><span class="line">            x: [<span class="number">0</span>; <span class="number">32</span>],</span><br><span class="line">            sstatus,</span><br><span class="line">            sepc: entry, <span class="comment">// entry point of app</span></span><br><span class="line">        &#125;;</span><br><span class="line">        cx.<span class="title function_ invoke__">set_sp</span>(sp); <span class="comment">// app&#x27;s user stack pointer</span></span><br><span class="line">        cx <span class="comment">// return initial Trap Context of app</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>__alltraps</code> 和 <code>__restore</code> 里，直接存取那些 R，不需要 trapContext 呀。<br>那 trapContext 是为谁构建的一个结构？</p>
<h3 id="3-6-内核态第一次执行用户程序"><a href="#3-6-内核态第一次执行用户程序" class="headerlink" title="3.6 内核态第一次执行用户程序"></a>3.6 内核态第一次执行用户程序</h3><ul>
<li>batch::run_next_app()</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pub fn run_next_app() -&gt; ! &#123;</span><br><span class="line">    ...</span><br><span class="line">    unsafe &#123;</span><br><span class="line">        __restore(KERNEL_STACK.push_context(TrapContext::app_init_context(</span><br><span class="line">            APP_BASE_ADDRESS,</span><br><span class="line">            USER_STACK.get_sp(),</span><br><span class="line">        )) as *const _ as usize);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/./pics/2_04.png"></p>
<h2 id="4-问题"><a href="#4-问题" class="headerlink" title="4 问题"></a>4 问题</h2><h4 id="1-UPSafeCell-背景，需要深入阅读-rust-相关资料。"><a href="#1-UPSafeCell-背景，需要深入阅读-rust-相关资料。" class="headerlink" title="1 UPSafeCell 背景，需要深入阅读 rust 相关资料。"></a>1 UPSafeCell 背景，需要深入阅读 rust 相关资料。</h4><h4 id="2-比如-hello-rc"><a href="#2-比如-hello-rc" class="headerlink" title="2 比如 hello.rc"></a>2 比如 hello.rc</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fn main() -&gt; i32 &#123;</span><br><span class="line">    println!(&quot;Hello, world from user mode program!&quot;);</span><br><span class="line">    0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 println 系统调用结束后，干了什么事？如何运行下一个 app <code>run_next_app()</code>？</p>
<h4 id="3-user-项目入口文件为什么需要名为-user-src-lib-rs，而不是-main-rs？"><a href="#3-user-项目入口文件为什么需要名为-user-src-lib-rs，而不是-main-rs？" class="headerlink" title="3 user 项目入口文件为什么需要名为 user&#x2F;src&#x2F;lib.rs，而不是 main.rs？"></a>3 user 项目入口文件为什么需要名为 user&#x2F;src&#x2F;lib.rs，而不是 main.rs？</h4><p>在 kernel 端，它可能没用处。<br>只是用于在 user 端作为调用。</p>
<h4 id="4-上述疑问，使-lab2-在细节的理解上，还存在点点没有串成线。并且在使用-gdb-上也存在问题，进入第一个-app-就退出了，原因不知，还有些莫名其妙。"><a href="#4-上述疑问，使-lab2-在细节的理解上，还存在点点没有串成线。并且在使用-gdb-上也存在问题，进入第一个-app-就退出了，原因不知，还有些莫名其妙。" class="headerlink" title="4 上述疑问，使 lab2 在细节的理解上，还存在点点没有串成线。并且在使用 gdb 上也存在问题，进入第一个 app 就退出了，原因不知，还有些莫名其妙。"></a>4 上述疑问，使 lab2 在细节的理解上，还存在点点没有串成线。并且在使用 gdb 上也存在问题，进入第一个 app 就退出了，原因不知，还有些莫名其妙。</h4><p>设置断点如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b os::batch::run_next_app</span><br></pre></td></tr></table></figure>

<p>通过 si 不能进入汇编语言 __restore，原因在哪里？</p>
<p>有空时，专门练习一下汇编语言GDB的调试办法。</p>
<h4 id="5-为什么-entry-asm-trap-s-都是汇编代码，但是不同的扩展名？"><a href="#5-为什么-entry-asm-trap-s-都是汇编代码，但是不同的扩展名？" class="headerlink" title="5 为什么 entry.asm &#x2F; trap.s 都是汇编代码，但是不同的扩展名？"></a>5 为什么 entry.asm &#x2F; trap.s 都是汇编代码，但是不同的扩展名？</h4><h4 id="6-查一下-csrrw-指令的意思？"><a href="#6-查一下-csrrw-指令的意思？" class="headerlink" title="6 查一下 csrrw 指令的意思？"></a>6 查一下 <code>csrrw</code> 指令的意思？</h4><p>csrrw: CSR read and write,</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/kuankuan02/article/details/95452616">https://blog.csdn.net/kuankuan02/article/details/95452616</a></p>
<h4 id="7-gdb-界面，为什么看不到-sscratch-寄存器？"><a href="#7-gdb-界面，为什么看不到-sscratch-寄存器？" class="headerlink" title="7 gdb 界面，为什么看不到 sscratch 寄存器？"></a>7 gdb 界面，为什么看不到 sscratch 寄存器？</h4><h4 id="8-load-app-后，是如何执行-app-的，其代码在哪里？"><a href="#8-load-app-后，是如何执行-app-的，其代码在哪里？" class="headerlink" title="8 load_app 后，是如何执行 app 的，其代码在哪里？"></a>8 load_app 后，是如何执行 app 的，其代码在哪里？</h4><p>执行用户代码 app，通过什么命令或其它方式？</p>
<h2 id="5-gdb-单步调试"><a href="#5-gdb-单步调试" class="headerlink" title="5 gdb 单步调试"></a>5 gdb 单步调试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译 user 代码</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> user; make build</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">调试 os 代码</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> os  ; make debug</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找函数符号名称</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; info <span class="built_in">functions</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设 run_next_app 为断点</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; b os::batch::run_next_app</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; n 不进入</span></span><br></pre></td></tr></table></figure>

<p><img src="/./pics/2_07.png"></p>
<h2 id="6-细节补充：动手创建-user-工程。"><a href="#6-细节补充：动手创建-user-工程。" class="headerlink" title="6 细节补充：动手创建 user 工程。"></a>6 细节补充：动手创建 user 工程。</h2><ol>
<li>用 cargo 创建工程</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 在项目目录下创建 user 文件夹,用来储存 `用户态` 的代码。</span><br><span class="line">cargo new ./user</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>linker.ld<br><img src="/./pics/2_06.png"></p>
<ul>
<li>.rodata 已初始化的、全局的、只读数据。即只读常量。</li>
<li>.data  已初始化的、全局的、只读数据。即可修改常量。</li>
<li>.bss 未初始化的、全局数据，通常由程序的加载者代为进行零初始化。</li>
</ul>
</li>
<li><p>lib.rs &#x2F;&#x2F; 和 os 的 main.rs 一样。</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#[no_mangle]</span><br><span class="line">#[link_section = &quot;.text.entry&quot;]</span><br><span class="line">pub extern &quot;C&quot; fn _start() -&gt; ! &#123;</span><br><span class="line">    clear_bss();</span><br><span class="line">    exit(main());</span><br><span class="line">    panic!(&quot;unreachable after sys_exit!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>syscall.rs</li>
</ol>
<p>那么就可以在syscall.rs文件下创建接口:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// user/src/syscall.rs</span><br><span class="line">use core::arch::asm;</span><br><span class="line">fn syscall(id: usize, args: [usize; 3]) -&gt; isize &#123;</span><br><span class="line">    let mut ret: isize;</span><br><span class="line">    unsafe &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            &quot;ecall&quot;,</span><br><span class="line">            inlateout(&quot;x10&quot;) args[0] =&gt; ret,</span><br><span class="line">            in(&quot;x11&quot;) args[1],</span><br><span class="line">            in(&quot;x12&quot;) args[2],</span><br><span class="line">            in(&quot;x17&quot;) id</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>console.rs</li>
<li>测试</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make build          //生成二进制</span><br><span class="line">qemu-riscv64 ./00hello_world</span><br><span class="line">qemu-riscv64 ./01store_fault</span><br><span class="line">qemu-riscv64 ./02power</span><br></pre></td></tr></table></figure>



<hr>
<p>在本章中，应用程序和批处理系统之间按照 API 的结构，约定如下两个系统调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/// 功能：将内存中缓冲区中的数据写入文件。</span><br><span class="line">/// 参数：`fd` 表示待写入文件的文件描述符；</span><br><span class="line">///      `buf` 表示内存中缓冲区的起始地址；</span><br><span class="line">///      `len` 表示内存中缓冲区的长度。</span><br><span class="line">/// 返回值：返回成功写入的长度。</span><br><span class="line">/// syscall ID：64</span><br><span class="line">fn sys_write(fd: usize, buf: *const u8, len: usize) -&gt; isize;</span><br><span class="line"></span><br><span class="line">/// 功能：退出应用程序并将返回值告知批处理系统。</span><br><span class="line">/// 参数：`exit_code` 表示应用程序的返回值。</span><br><span class="line">/// 返回值：该系统调用不应该返回。</span><br><span class="line">/// syscall ID：93</span><br><span class="line">fn sys_exit(exit_code: usize) -&gt; !;</span><br></pre></td></tr></table></figure>
<p>那么对应的,我们可以使用syscall来实现这两个API:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// user/src/syscall.rs</span><br><span class="line"></span><br><span class="line">const SYSCALL_WRITE: usize = 64;</span><br><span class="line">const SYSCALL_EXIT: usize = 93;</span><br><span class="line"></span><br><span class="line">pub fn sys_write(fd: usize, buffer: &amp;[u8]) -&gt; isize &#123;</span><br><span class="line">    syscall(SYSCALL_WRITE, [fd, buffer.as_ptr() as usize, buffer.len()])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub fn sys_exit(xstate: i32) -&gt; isize &#123;</span><br><span class="line">    syscall(SYSCALL_EXIT, [xstate as usize, 0, 0])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意 sys_write 使用一个 &amp;[u8] 切片类型来描述缓冲区，这是一个 胖指针 (Fat Pointer)，里面既包含缓冲区的起始地址，还 包含缓冲区的长度。我们可以分别通过 as_ptr 和 len 方法取出它们并独立地作为实际的系统调用参数。</p>
<h4 id="进一步封装接口"><a href="#进一步封装接口" class="headerlink" title="进一步封装接口"></a>进一步封装接口</h4><p>为了将上述两个系统调用在用户库 user_lib 中进一步封装，从而更加接近在 Linux 等平台的实际系统调用接口,修改lib.rs文件,在其中键入:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mod syscall;</span><br><span class="line"></span><br><span class="line">use syscall::*;</span><br><span class="line"></span><br><span class="line">pub fn write(fd: usize, buf: &amp;[u8]) -&gt; isize &#123;</span><br><span class="line">    sys_write(fd, buf)</span><br><span class="line">&#125;</span><br><span class="line">pub fn exit(exit_code: i32) -&gt; isize &#123;</span><br><span class="line">    sys_exit(exit_code)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更改console的实现"><a href="#更改console的实现" class="headerlink" title="更改console的实现"></a>更改console的实现</h4><p>我们把 console 子模块中 Stdout::write_str 改成基于 write 的实现，且传入的 fd 参数设置为 1，它代表标准输出， 也就是输出到屏幕。目前我们不需要考虑其他的 fd 选取情况。这样，应用程序的 println! 宏借助系统调用变得可用了。</p>
<p>创建console.rs文件,内容和第一章该模块保持一致,只修改Stdout的Write特性的实现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// user/src/console.rs</span><br><span class="line">const STDOUT: usize = 1;</span><br><span class="line"></span><br><span class="line">impl Write for Stdout &#123;</span><br><span class="line">    fn write_str(&amp;mut self, s: &amp;str) -&gt; fmt::Result &#123;</span><br><span class="line">        write(STDOUT, s.as_bytes());</span><br><span class="line">        Ok(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的文件内容为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">use super::write;</span><br><span class="line">use core::fmt::&#123;self, Write&#125;;</span><br><span class="line"></span><br><span class="line">struct Stdout;</span><br><span class="line"></span><br><span class="line">const STDOUT: usize = 1;</span><br><span class="line"></span><br><span class="line">impl Write for Stdout &#123;</span><br><span class="line">    fn write_str(&amp;mut self, s: &amp;str) -&gt; fmt::Result &#123;</span><br><span class="line">        write(STDOUT, s.as_bytes());</span><br><span class="line">        Ok(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub fn print(args: fmt::Arguments) &#123;</span><br><span class="line">    Stdout.write_fmt(args).unwrap();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#[macro_export]</span><br><span class="line">macro_rules! print &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        $crate::console::print(format_args!($fmt $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#[macro_export]</span><br><span class="line">macro_rules! println &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        $crate::console::print(format_args!(concat!($fmt, &quot;\n&quot;) $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-作业"><a href="#7-作业" class="headerlink" title="7 作业"></a>7 作业</h2><h2 id="8-TODO"><a href="#8-TODO" class="headerlink" title="8 TODO"></a>8 TODO</h2><ul>
<li><p>完成作业。</p>
</li>
<li><p>把所有疑问搞清楚。</p>
</li>
</ul>
<h2 id="9-参考："><a href="#9-参考：" class="headerlink" title="9 参考："></a>9 参考：</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenhan-winddevil/p/18312966">https://www.cnblogs.com/chenhan-winddevil/p/18312966</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://goversion.github.io/2025/08/31/os1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhou tao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/31/os1/" class="post-title-link" itemprop="url">os1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-31 17:39:28 / 修改时间：17:41:22" itemprop="dateCreated datePublished" datetime="2025-08-31T17:39:28+08:00">2025-08-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="OS-第一章：基本执行环境"><a href="#OS-第一章：基本执行环境" class="headerlink" title="OS 第一章：基本执行环境"></a>OS 第一章：基本执行环境</h1><h2 id="0-预备知识"><a href="#0-预备知识" class="headerlink" title="0 预备知识"></a>0 预备知识</h2><ul>
<li><p>sbi 位于 M 态，为操作系统提供服务。</p>
</li>
<li><p>程序编译的过程：</p>
<ol>
<li>对源代码展开，把宏展开成源代码。</li>
<li>把高级语言转换成汇编程序。</li>
<li>汇编程序转换成机器语言。</li>
<li>把机器语言汇总在一起，转换为一个成执行的文件。</li>
</ol>
</li>
<li><p>修改编译目标 + 剥掉标准库</p>
<p>从一个普通的 app，到一个 bare app，我们需要做的是：</p>
<ul>
<li>重新指定 <code>三元组</code>，即修改编译目标；</li>
<li>剥掉 <code>标准库</code>；</li>
<li>剥掉 <code>os kernel</code>；</li>
<li>app 直接操作硬件平台；</li>
</ul>
</li>
</ul>
<h2 id="1-准备环境"><a href="#1-准备环境" class="headerlink" title="1 准备环境"></a>1 准备环境</h2><h4 id="1-1-安装-rust"><a href="#1-1-安装-rust" class="headerlink" title="1.1 安装 rust"></a>1.1 安装 rust</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static</span><br><span class="line">export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl https://sh.rustup.rs -sSf | sh</span><br><span class="line"></span><br><span class="line">选 2. Customize installation，选 nightly 配置，</span><br><span class="line"></span><br><span class="line">再选 1. Proceed with installation (default) 按上面的配置安装。</span><br></pre></td></tr></table></figure>


<p>更换为国内源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp $&#123;CARGO_HOME:-$HOME/.cargo&#125;</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | tee -a $&#123;CARGO_HOME:-$HOME/.cargo&#125;/config</span><br><span class="line">[source.crates-io]</span><br><span class="line">replace-with = &#x27;mirror&#x27;</span><br><span class="line"></span><br><span class="line">[source.mirror]</span><br><span class="line">registry = &quot;https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rustup install nightly</span><br><span class="line">rustup default nightly</span><br><span class="line"></span><br><span class="line">rustup target add riscv64gc-unknown-none-elf</span><br><span class="line">cargo install cargo-binutils</span><br><span class="line">rustup component add llvm-tools-preview</span><br><span class="line">rustup component add rust-src</span><br></pre></td></tr></table></figure>

<p>Visual Studio Code 搭配 rust-analyzer 和 RISC-V Support 插件。</p>
<h4 id="1-2-安装-qemu"><a href="#1-2-安装-qemu" class="headerlink" title="1.2 安装 qemu"></a>1.2 安装 qemu</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev \</span><br><span class="line">              gawk build-essential bison flex texinfo gperf libtool patchutils bc \</span><br><span class="line">              zlib1g-dev libexpat-dev pkg-config  libglib2.0-dev libpixman-1-dev libsdl2-dev libslirp-dev \</span><br><span class="line">              git tmux python3 python3-pip ninja-build</span><br><span class="line"></span><br><span class="line">wget https://download.qemu.org/qemu-7.0.0.tar.xz</span><br><span class="line"></span><br><span class="line">tar xvJf qemu-7.0.0.tar.xz</span><br><span class="line"></span><br><span class="line">cd qemu-7.0.0</span><br><span class="line"></span><br><span class="line">./configure --target-list=riscv64-softmmu,riscv64-linux-user</span><br><span class="line"></span><br><span class="line">// 可以有图形界面和网络。如果要支持图形界面，可添加 &quot; --enable-sdl&quot; 参数；如果要支持网络，可添加 &quot; --enable-slirp&quot; 参数</span><br><span class="line"></span><br><span class="line">make -j$(nproc)</span><br><span class="line"></span><br><span class="line">export PATH=$PATH:/home/xu/workspace/31.os/qemu-7.0.0/build</span><br><span class="line"></span><br><span class="line">qemu-system-riscv64 --version</span><br><span class="line"></span><br><span class="line">qemu-riscv64 --version</span><br></pre></td></tr></table></figure>



<h2 id="2-构建用户态执行环境。利用-qemu-riscv64-提供-OS-kernel能力，实现一个简单的用户态程序。"><a href="#2-构建用户态执行环境。利用-qemu-riscv64-提供-OS-kernel能力，实现一个简单的用户态程序。" class="headerlink" title="2 构建用户态执行环境。利用 qemu-riscv64 提供 OS kernel能力，实现一个简单的用户态程序。"></a>2 构建用户态执行环境。利用 <code>qemu-riscv64</code> 提供 <code>OS kernel</code>能力，实现一个简单的用户态程序。</h2><p><img src="/./pics/1_01.png"></p>
<p>上图 1 从 hello world 出发，具体细节：</p>
<h4 id="2-1-缺-std"><a href="#2-1-缺-std" class="headerlink" title="2.1 缺 std"></a>2.1 缺 std</h4><p>通过加 no_std；</p>
<h4 id="2-2-缺-println"><a href="#2-2-缺-println" class="headerlink" title="2.2 缺 println"></a>2.2 缺 println</h4><p>暂时注释掉；</p>
<h4 id="2-3-缺-panic-（rust-程序里出了错，如非法访问造成程序崩溃，就需要panic，处理崩溃的实现-）"><a href="#2-3-缺-panic-（rust-程序里出了错，如非法访问造成程序崩溃，就需要panic，处理崩溃的实现-）" class="headerlink" title="2.3 缺 panic （rust 程序里出了错，如非法访问造成程序崩溃，就需要panic，处理崩溃的实现 ）"></a>2.3 缺 panic （rust 程序里出了错，如非法访问造成程序崩溃，就需要panic，处理崩溃的实现 ）</h4><h4 id="2-4-不支持-main-，因为没有-std-的原因"><a href="#2-4-不支持-main-，因为没有-std-的原因" class="headerlink" title="2.4 不支持 main ，因为没有 std 的原因"></a>2.4 不支持 main ，因为没有 std 的原因</h4><p>通过加 no_main，告诉编译器，不要去找 main &#x2F; start，此时这个程序的代码段什么都没有。</p>
<h4 id="2-5-加上-start-语言项"><a href="#2-5-加上-start-语言项" class="headerlink" title="2.5 加上 start 语言项"></a>2.5 加上 start 语言项</h4><p>现在的代码如下：</p>
<ul>
<li>lang_items.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>main.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="meta">#![feature(asm)]</span></span><br><span class="line"><span class="meta">#![feature(panic_info_message)]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> lang_items;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/lang_items.rs</span></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo build</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">qemu-riscv64 target/riscv64gc-unknown-none-elf/debug/os</span></span><br><span class="line"> segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>

<p>上面的代码编译执行会报 ‘segmentation fault’，因为目前的执行环境还缺了一个退出机制，我们需要调用 kernel 提供的 exit 系统调用来退出程序。</p>
<h4 id="2-6-发出一个系统调用-exit"><a href="#2-6-发出一个系统调用-exit" class="headerlink" title="2.6 发出一个系统调用 exit"></a>2.6 发出一个系统调用 exit</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SYSCALL_EXIT: <span class="type">usize</span> = <span class="number">93</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">syscall</span>(id: <span class="type">usize</span>, args: [<span class="type">usize</span>; <span class="number">3</span>]) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ret</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        core::arch::asm!(</span><br><span class="line">            <span class="string">&quot;ecall&quot;</span>,</span><br><span class="line">            <span class="title function_ invoke__">inlateout</span>(<span class="string">&quot;x10&quot;</span>) args[<span class="number">0</span>] =&gt; ret,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x11&quot;</span>) args[<span class="number">1</span>],</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x12&quot;</span>) args[<span class="number">2</span>],</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x17&quot;</span>) id,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_exit</span>(xstate: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">syscall</span>(SYSCALL_EXIT, [xstate <span class="keyword">as</span> <span class="type">usize</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">sys_exit</span>(<span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cargo build</span><br><span class="line"></span><br><span class="line">qemu-riscv64 target/riscv64gc-unknown-none-elf/debug/os; echo $?</span><br></pre></td></tr></table></figure>

<h4 id="2-7-添加-print-功能"><a href="#2-7-添加-print-功能" class="headerlink" title="2.7 添加 print 功能"></a>2.7 添加 print 功能</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SYSCALL_WRITE: <span class="type">usize</span> = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_write</span>(fd: <span class="type">usize</span>, buffer: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">  <span class="title function_ invoke__">syscall</span>(SYSCALL_WRITE, [fd, buffer.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> <span class="type">usize</span>, buffer.<span class="title function_ invoke__">len</span>()])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">然后实现基于 Write Trait 的数据结构，并完成 Write Trait 所需要的 write_str 函数，并用 print 函数进行包装。</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Stdout</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Write</span> <span class="keyword">for</span> <span class="title class_">Stdout</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">write_str</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">sys_write</span>(<span class="number">1</span>, s.<span class="title function_ invoke__">as_bytes</span>());</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">print</span>(args: fmt::Arguments) &#123;</span><br><span class="line">    Stdout.<span class="title function_ invoke__">write_fmt</span>(args).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">最后，实现基于 print 函数，实现Rust语言 格式化宏 ( formatting macros )。</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> print &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        $crate::console::<span class="title function_ invoke__">print</span>(<span class="built_in">format_args!</span>($fmt $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> println &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">print</span>(<span class="built_in">format_args!</span>(<span class="built_in">concat!</span>($fmt, <span class="string">&quot;\n&quot;</span>) $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">接下来，我们调整一下应用程序，让它发出显示字符串和退出的请求：</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">sys_exit</span>(<span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终，用户程序可以向 qemu-riscv64 提供的 kernel 发出 print &#x2F; exit 的系统调用。</p>
<h2 id="3-构建裸机执行环境。利用-qemu-system-riscv64-把-OS-kernel-去掉"><a href="#3-构建裸机执行环境。利用-qemu-system-riscv64-把-OS-kernel-去掉" class="headerlink" title="3 构建裸机执行环境。利用 qemu-system-riscv64 把 OS kernel 去掉"></a>3 构建裸机执行环境。利用 <code>qemu-system-riscv64</code> 把 <code>OS kernel</code> 去掉</h2><p>把 Hello world! 应用程序从用户态搬到内核态。</p>
<h4 id="qemu-system-riscv64"><a href="#qemu-system-riscv64" class="headerlink" title="qemu-system-riscv64"></a>qemu-system-riscv64</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-riscv64 \</span><br><span class="line">            -machine virt \</span><br><span class="line">            -nographic \</span><br><span class="line">            -bios $(BOOTLOADER) \</span><br><span class="line">            -device loader,file=$(KERNEL_BIN),addr=$(KERNEL_ENTRY_PA)</span><br></pre></td></tr></table></figure>
<p>CPU 的其它通用寄存器清零，而 PC 会指向 0x1000 的位置，这里有固化在硬件中的一小段引导代码，它会很快跳转到 0x80000000 的 RustSBI 处。 RustSBI 完成硬件初始化后，会跳转到 $(KERNEL_BIN) 所在内存位置 0x80200000 处， 执行操作系统的第一条指令。</p>
<p>后面 gdb 调试的小节里，可以看到 0x1000 的位置只有 6 行代码。</p>
<h4 id="3-1-对上一节实现的代码稍作调整，把-exit-替换为-shutdown。通过-ecall-调用-RustSBI-实现关机功能。"><a href="#3-1-对上一节实现的代码稍作调整，把-exit-替换为-shutdown。通过-ecall-调用-RustSBI-实现关机功能。" class="headerlink" title="3.1 对上一节实现的代码稍作调整，把 exit 替换为 shutdown。通过 ecall 调用 RustSBI 实现关机功能。"></a>3.1 对上一节实现的代码稍作调整，把 exit 替换为 shutdown。通过 ecall 调用 RustSBI 实现关机功能。</h4><p>前者是 exit 是一个 syscall 调用 kernel 的服务，后者 shutdown 是 kernel 调用 sbi 的服务。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">sys_exit</span>(<span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>替换成：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/sbi.rs</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">sbi_call</span>(which: <span class="type">usize</span>, arg0: <span class="type">usize</span>, arg1: <span class="type">usize</span>, arg2: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ret</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;ecall&quot;</span>,</span><br><span class="line">            <span class="title function_ invoke__">inlateout</span>(<span class="string">&quot;x10&quot;</span>) arg0 =&gt; ret,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x11&quot;</span>) arg1,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x12&quot;</span>) arg2,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x17&quot;</span>) which,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SBI_SHUTDOWN: <span class="type">usize</span> = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">shutdown</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="title function_ invoke__">sbi_call</span>(SBI_SHUTDOWN, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;It should shutdown!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/main.rs</span></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">shutdown</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 qemu-system-riscv64 测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cargo build --release</span><br><span class="line"></span><br><span class="line">rust-objcopy --binary-architecture=riscv64 target/riscv64gc-unknown-none-elf/release/os --strip-all -O binary target/riscv64gc-unknown-none-elf/release/os.bin</span><br><span class="line"></span><br><span class="line">qemu-system-riscv64 -machine virt -nographic -bios ../bootloader/rustsbi-qemu.bin -device loader,file=target/riscv64gc-unknown-none-elf/release/os.bin,addr=0x80200000</span><br><span class="line"></span><br><span class="line">rust-readobj -h target/riscv64gc-unknown-none-elf/release/os</span><br></pre></td></tr></table></figure>

<p>注意 <code>-bios $(BOOTLOADER)</code> 意味着硬件加载了一个 BootLoader 程序，即 <code>SBI</code>。</p>
<p><img src="/./pics/1_03.png"></p>
<p>上面进程无法退出，风扇狂转，感觉碰到死循环，卡死了。</p>
<p>问题在哪？通过 rust-readobj 分析 os 可执行程序，发现其入口地址不是 RustSBI 约定的 0x80200000 。</p>
<p>也就是说，通过 <code>qemu-system-riscv64 addr=0x80200000</code> 没有起作用。</p>
<p>我们需要修改程序的内存布局并设置好栈空间。</p>
<h4 id="3-2-添加链接脚本-linker-ld"><a href="#3-2-添加链接脚本-linker-ld" class="headerlink" title="3.2 添加链接脚本 linker.ld"></a>3.2 添加链接脚本 linker.ld</h4><p>上面的 1.6 编译之后，起始地址是一个随机的默认的地址，但我们希望它的起始地址是 0x80200000，因此我们需要一个 linker 告诉编译器，如何放置 text,code.codata,等。</p>
<p>.cargo&#x2F;config.toml 放置了 linker.ld 文件。</p>
<h4 id="3-3-配置栈"><a href="#3-3-配置栈" class="headerlink" title="3.3 配置栈"></a>3.3 配置栈</h4><p>写 app 时，我们不需要准备栈，qemu-riscv64 会为我们准备这个栈。<br>现在在祼机上运行了，我们需要自己准备栈。</p>
<p>如果自己不准备栈，sp 会仍然指向 qemu-system-riscv64 启动时执行到 SBI 时的栈，kernel 就会把 SBI 的栈损坏。</p>
<p>所以，在 _start 一开始，我们要先准备栈，再进入 rust_main。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_start:</span><br><span class="line">    la sp, boot_stack_top</span><br><span class="line">    call rust_main</span><br><span class="line"></span><br><span class="line">    .section .bss.stack</span><br><span class="line">    .globl boot_stack_lower_bound</span><br><span class="line">boot_stack_lower_bound:</span><br><span class="line">    .space 4096 * 16</span><br><span class="line">    .globl boot_stack_top</span><br><span class="line">boot_stack_top:</span><br></pre></td></tr></table></figure>

<h4 id="3-4-使用-SBI-服务，打印一个字符"><a href="#3-4-使用-SBI-服务，打印一个字符" class="headerlink" title="3.4 使用 SBI 服务，打印一个字符"></a>3.4 使用 SBI 服务，打印一个字符</h4><p><img src="/./pics/1_04.png"></p>
<p>上图的 syscall 参数规范，</p>
<ul>
<li>参考：<a target="_blank" rel="noopener" href="https://d3s.mff.cuni.cz/files/teaching/nswi200/202324/doc/riscv-abi.pdf">https://d3s.mff.cuni.cz/files/teaching/nswi200/202324/doc/riscv-abi.pdf</a></li>
<li>参考：<a target="_blank" rel="noopener" href="https://jborza.com/post/2021-05-11-riscv-linux-syscalls/">https://jborza.com/post/2021-05-11-riscv-linux-syscalls/</a></li>
</ul>
<p>上图的 SBI 参数规范，</p>
<ul>
<li>参考：<a target="_blank" rel="noopener" href="https://www.scs.stanford.edu/~zyedidia/docs/riscv/riscv-sbi.pdf">https://www.scs.stanford.edu/~zyedidia/docs/riscv/riscv-sbi.pdf</a></li>
</ul>
<h4 id="3-5-打印一个字符串"><a href="#3-5-打印一个字符串" class="headerlink" title="3.5 打印一个字符串"></a>3.5 打印一个字符串</h4><p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://rustwiki.org/zh-CN/std/fmt/trait.Write.html">https://rustwiki.org/zh-CN/std/fmt/trait.Write.html</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/s/rust%20no_std%20fmt">https://juejin.cn/s/rust%20no_std%20fmt</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiangxianghehe/article/details/92839138">https://blog.csdn.net/xiangxianghehe/article/details/92839138</a></li>
<li><a target="_blank" rel="noopener" href="https://xy-plus.gitbook.io/rcore-step-by-step/ge-shi-hua-shu-chu">https://xy-plus.gitbook.io/rcore-step-by-step/ge-shi-hua-shu-chu</a></li>
</ul>
<p>总结以上的流程：</p>
<p>去掉 std，添加 panic，去掉 no_main，添加 syscall 调用，这样具备了一个应用程序的基本功能了。</p>
<p>然后，写 syscall 实现部分，准备 kernel 栈，指定链接脚本，因为现在的 syscall 在往下调用 sbi，最后把这个 sbi 也去掉，真正去调用硬件。</p>
<h2 id="4-安装-gdb-与使用"><a href="#4-安装-gdb-与使用" class="headerlink" title="4 安装 gdb 与使用"></a>4 安装 gdb 与使用</h2><h4 id="4-1-安装-gdb"><a href="#4-1-安装-gdb" class="headerlink" title="4.1 安装 gdb"></a>4.1 安装 gdb</h4><ul>
<li><p>下载 gdb 最新版 ：<br><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/gnu/gdb/">https://mirrors.tuna.tsinghua.edu.cn/gnu/gdb/</a></p>
</li>
<li><p>编译</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">cd gdb-XXX</span><br><span class="line">mkdir build-riscv64</span><br><span class="line">cd build-riscv64</span><br><span class="line">sudo apt-get install libncurses5-dev texinfo libreadline-dev</span><br><span class="line">../configure --prefix=/home/xu/workspace/31.os/gdb-15.1/build-riscv64 --with-python=/usr/bin/python --target=riscv64-unknown-elf --enable-tui=yes</span><br><span class="line"></span><br><span class="line">make -j$(nproc)</span><br><span class="line"></span><br><span class="line">make install</span><br><span class="line">./bin/riscv64-unknown-elf-gdb --version</span><br><span class="line"></span><br><span class="line">export PATH=$PATH:/home/xu/workspace/31.os/qemu-7.0.0/build:/home/xu/workspace/31.os/gdb-15.2/build-riscv64/bin</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 gdb-dashboard 插件：<a target="_blank" rel="noopener" href="https://github.com/cyrus-and/gdb-dashboard">https://github.com/cyrus-and/gdb-dashboard</a></li>
</ul>
<h4 id="4-2-gdb-操作说明"><a href="#4-2-gdb-操作说明" class="headerlink" title="4.2 gdb 操作说明"></a>4.2 gdb 操作说明</h4><h6 id="GDB-命令"><a href="#GDB-命令" class="headerlink" title="GDB 命令"></a>GDB 命令</h6><p>make debug MODE&#x3D;debug LOG&#x3D;INFO</p>
<ul>
<li>tui layout src</li>
<li>b <funcName>: 添加断点</li>
<li>c: 继续运行, 遇到断点会中断</li>
<li>s: 执行下一行代码，进入函数</li>
<li>n: 执行下一行代码, 不进入函数</li>
<li>info reg</li>
<li>finish：结束当前函数，返回到函数调用点</li>
<li>ni&#x2F;si：是执行一条汇编指令，不是执行一条rust语句</li>
</ul>
<h6 id="设断点"><a href="#设断点" class="headerlink" title="设断点"></a>设断点</h6><p>通过 <code>info functions</code> 找到main 符号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info function run_next_app</span><br><span class="line">(gdb) b os::batch::run_next_app</span><br></pre></td></tr></table></figure>

<h6 id="接下来要做的事"><a href="#接下来要做的事" class="headerlink" title="接下来要做的事"></a>接下来要做的事</h6><p>见上图，通过 si 不能进入汇编语言 __restore，原因在哪里？</p>
<p>有空时，专门练习一下汇编语言GDB的调试办法。</p>
<h6 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h6><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bonelee/p/13759115.html">https://www.cnblogs.com/bonelee/p/13759115.html</a></li>
</ul>
<h4 id="4-3-单步调试"><a href="#4-3-单步调试" class="headerlink" title="4.3 单步调试"></a>4.3 单步调试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-riscv64 \</span><br><span class="line">    -machine virt \</span><br><span class="line">    -nographic \</span><br><span class="line">    -bios ../bootloader/rustsbi-qemu.bin \</span><br><span class="line">    -device loader,file=target/riscv64gc-unknown-none-elf/release/os.bin,addr=0x80200000 \</span><br><span class="line">    -s -S</span><br></pre></td></tr></table></figure>
<p>在 ubuntu 的开发环境，需要把 bootloader&#x2F;rustsbi-qemu.bin 文件替换掉，最新版下载地址为：<a target="_blank" rel="noopener" href="https://github.com/rustsbi/rustsbi-qemu/releases%E3%80%82">https://github.com/rustsbi/rustsbi-qemu/releases。</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">riscv64-unknown-elf-gdb \</span><br><span class="line">    -ex &#x27;file target/riscv64gc-unknown-none-elf/release/os&#x27; \</span><br><span class="line">    -ex &#x27;set arch riscv:rv64&#x27; \</span><br><span class="line">    -ex &#x27;target remote localhost:1234&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Qemu 启动后 PC 被初始化为 0x1000</span></span><br><span class="line"></span><br><span class="line">(gdb) si</span><br><span class="line">0x0000000000001004 in ?? ()</span><br><span class="line">(gdb) si</span><br><span class="line">0x0000000000001008 in ?? ()</span><br><span class="line">(gdb) si</span><br><span class="line">0x000000000000100c in ?? ()</span><br><span class="line">(gdb) si</span><br><span class="line">0x0000000000001010 in ?? ()</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">p: <span class="built_in">print</span></span></span><br><span class="line"></span><br><span class="line">(gdb) p/x $t0</span><br><span class="line">1 = 0x80000000</span><br><span class="line">(gdb) si</span><br><span class="line">0x0000000080000000 in ?? ()</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用examine命令(简写是x)来查看内存地址中的值，x Examine memory: x/FMT ADDRESS. ADDRESS is an expression <span class="keyword">for</span> the memory address to examine.</span></span><br><span class="line"></span><br><span class="line">(gdb) x/10i $pc</span><br><span class="line">=&gt; 0x80000000:      auipc   sp,0x28</span><br><span class="line">0x80000004: mv      sp,sp</span><br><span class="line">0x80000008: lui     t0,0x4</span><br><span class="line">0x8000000a: addi    t1,a0,1</span><br><span class="line">0x8000000e: add     sp,sp,t0</span><br><span class="line">0x80000010: addi    t1,t1,-1</span><br><span class="line">0x80000012: bnez    t1,0x8000000e</span><br><span class="line">0x80000016: j       0x8001125a</span><br><span class="line">0x8000001a: unimp</span><br><span class="line">0x8000001c: addi    sp,sp,-48</span><br><span class="line">(gdb) si</span><br><span class="line">0x0000000080000004 in ?? ()</span><br><span class="line">(gdb) si</span><br><span class="line">0x0000000080000008 in ?? ()</span><br><span class="line">(gdb) si</span><br><span class="line">0x000000008000000a in ?? ()</span><br><span class="line">(gdb) si</span><br><span class="line">0x000000008000000e in ?? ()</span><br><span class="line">(gdb) b *0x80200000</span><br><span class="line">Breakpoint 1 at 0x80200000</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x0000000080200000 in ?? ()</span><br></pre></td></tr></table></figure>


<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zjp-cn.github.io/os-notes/rcore-gdb.html">https://zjp-cn.github.io/os-notes/rcore-gdb.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenhan-winddevil/p/18292657">https://www.cnblogs.com/chenhan-winddevil/p/18292657</a></li>
</ul>
<h2 id="5-构建用户态执行环境代码"><a href="#5-构建用户态执行环境代码" class="headerlink" title="5 构建用户态执行环境代码"></a>5 构建用户态执行环境代码</h2><p>共有以下两个代码文件：</p>
<ul>
<li>main.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="meta">#![feature(asm)]</span></span><br><span class="line"><span class="meta">#![feature(panic_info_message)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> lang_items;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::fmt::&#123;<span class="keyword">self</span>, Write&#125;;</span><br><span class="line"><span class="keyword">use</span> core::arch::asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Stdout</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Write</span> <span class="keyword">for</span> <span class="title class_">Stdout</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">write_str</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">sys_write</span>(<span class="number">1</span>, s.<span class="title function_ invoke__">as_bytes</span>());</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">print</span>(args: fmt::Arguments) &#123;</span><br><span class="line">    Stdout.<span class="title function_ invoke__">write_fmt</span>(args).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> print &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        $crate::console::<span class="title function_ invoke__">print</span>(<span class="built_in">format_args!</span>($fmt $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> println &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">print</span>(<span class="built_in">format_args!</span>(<span class="built_in">concat!</span>($fmt, <span class="string">&quot;\n&quot;</span>) $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SYSCALL_EXIT: <span class="type">usize</span> = <span class="number">93</span>;</span><br><span class="line"><span class="keyword">const</span> SYSCALL_WRITE: <span class="type">usize</span> = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">syscall</span>(id: <span class="type">usize</span>, args: [<span class="type">usize</span>; <span class="number">3</span>]) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ret</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;ecall&quot;</span>,</span><br><span class="line">            <span class="title function_ invoke__">inlateout</span>(<span class="string">&quot;x10&quot;</span>) args[<span class="number">0</span>] =&gt; ret,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x11&quot;</span>) args[<span class="number">1</span>],</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x12&quot;</span>) args[<span class="number">2</span>],</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x17&quot;</span>) id,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_exit</span>(xstate: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">syscall</span>(SYSCALL_EXIT, [xstate <span class="keyword">as</span> <span class="type">usize</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_write</span>(fd: <span class="type">usize</span>, buffer: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">syscall</span>(SYSCALL_WRITE, [fd, buffer.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> <span class="type">usize</span>, buffer.<span class="title function_ invoke__">len</span>()])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">sys_exit</span>(<span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>lang_items.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-构建裸机执行环境代码"><a href="#6-构建裸机执行环境代码" class="headerlink" title="6 构建裸机执行环境代码"></a>6 构建裸机执行环境代码</h2><ul>
<li>main.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="meta">#![feature(asm)]</span></span><br><span class="line"><span class="meta">#![feature(panic_info_message)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> console;</span><br><span class="line"><span class="keyword">mod</span> lang_items;</span><br><span class="line"><span class="keyword">mod</span> sbi;</span><br><span class="line">core::arch::global_asm!(<span class="built_in">include_str!</span>(<span class="string">&quot;entry.asm&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> sbi_rt::legacy::shutdown;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">clear_bss</span>() &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">sbss</span>();</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">ebss</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    (sbss <span class="keyword">as</span> <span class="type">usize</span>..ebss <span class="keyword">as</span> <span class="type">usize</span>).for_each(|a| &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (a <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>).<span class="title function_ invoke__">write_volatile</span>(<span class="number">0</span>) &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">rust_main</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="title function_ invoke__">clear_bss</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line">    <span class="comment">// sys_exit(9);</span></span><br><span class="line">    <span class="title function_ invoke__">shutdown</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>sbi.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![allow(unused)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::arch::asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SBI_SET_TIMER: <span class="type">usize</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_CONSOLE_PUTCHAR: <span class="type">usize</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_CONSOLE_GETCHAR: <span class="type">usize</span> = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_CLEAR_IPI: <span class="type">usize</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_SEND_IPI: <span class="type">usize</span> = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_REMOTE_FENCE_I: <span class="type">usize</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_REMOTE_SFENCE_VMA: <span class="type">usize</span> = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_REMOTE_SFENCE_VMA_ASID: <span class="type">usize</span> = <span class="number">7</span>;</span><br><span class="line"><span class="keyword">const</span> SBI_SHUTDOWN: <span class="type">usize</span> = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">sbi_call</span>(which: <span class="type">usize</span>, arg0: <span class="type">usize</span>, arg1: <span class="type">usize</span>, arg2: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ret</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;ecall&quot;</span>,</span><br><span class="line">            <span class="title function_ invoke__">inlateout</span>(<span class="string">&quot;x10&quot;</span>) arg0 =&gt; ret,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x11&quot;</span>) arg1,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x12&quot;</span>) arg2,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;x17&quot;</span>) which,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// use sbi call to putchar in console (qemu uart handler)</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">console_putchar</span>(c: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">sbi_call</span>(SBI_CONSOLE_PUTCHAR, c, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// use sbi call to getchar from console (qemu uart handler)</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">console_getchar</span>() <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">sbi_call</span>(SBI_CONSOLE_GETCHAR, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// use sbi call to shutdown the kernel</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">shutdown</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="title function_ invoke__">sbi_call</span>(SBI_SHUTDOWN, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;It should shutdown!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>console.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! SBI console driver, for text output</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::sbi::console_putchar;</span><br><span class="line"><span class="keyword">use</span> core::fmt::&#123;<span class="keyword">self</span>, Write&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Stdout</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Write</span> <span class="keyword">for</span> <span class="title class_">Stdout</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">write_str</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">c</span> <span class="keyword">in</span> s.<span class="title function_ invoke__">chars</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">console_putchar</span>(c <span class="keyword">as</span> <span class="type">usize</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">print</span>(args: fmt::Arguments) &#123;</span><br><span class="line">    Stdout.<span class="title function_ invoke__">write_fmt</span>(args).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// print string macro</span></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> print &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        $crate::console::<span class="title function_ invoke__">print</span>(<span class="built_in">format_args!</span>($fmt $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// println string macro</span></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> println &#123;</span><br><span class="line">    ($fmt: literal $(, $($arg: tt)+)?) =&gt; &#123;</span><br><span class="line">        $crate::console::<span class="title function_ invoke__">print</span>(<span class="built_in">format_args!</span>(<span class="built_in">concat!</span>($fmt, <span class="string">&quot;\n&quot;</span>) $(, $($arg)+)?));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>lang_items.rs</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">zhou tao</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
